<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="SpringBoot整合Security框架"><meta name="keywords" content="SpringBoot,Security"><meta name="author" content="攀"><meta name="copyright" content="攀"><title>SpringBoot整合Security框架 | 小世界</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security"><span class="toc-number">1.</span> <span class="toc-text">Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#目标"><span class="toc-number">1.1.1.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#概念"><span class="toc-number">1.1.2.</span> <span class="toc-text">概念</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基础配置"><span class="toc-number">1.2.</span> <span class="toc-text">基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#依赖与设置"><span class="toc-number">1.2.1.</span> <span class="toc-text">依赖与设置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#引入pom依赖："><span class="toc-number">1.2.1.1.</span> <span class="toc-text">引入pom依赖：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置yml"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">配置yml:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mapper"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">mapper</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#数据库"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">数据库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#必要的组件"><span class="toc-number">1.2.2.</span> <span class="toc-text">必要的组件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实体类"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">实体类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dao层"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">dao层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#服务层"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">服务层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#控制层"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">控制层</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security——登录和注销"><span class="toc-number">1.3.</span> <span class="toc-text">Security——登录和注销</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UserDetailsService"><span class="toc-number">1.3.1.</span> <span class="toc-text">UserDetailsService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebSecurityConfigurerAdapter"><span class="toc-number">1.3.2.</span> <span class="toc-text">WebSecurityConfigurerAdapter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注销的实现"><span class="toc-number">1.3.3.</span> <span class="toc-text">注销的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">1.3.4.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#登录界面"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">登录界面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#权限页面"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">权限页面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security——记住我"><span class="toc-number">1.4.</span> <span class="toc-text">Security——记住我</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cookies"><span class="toc-number">1.4.1.</span> <span class="toc-text">Cookies</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义Cookies"><span class="toc-number">1.4.2.</span> <span class="toc-text">自定义Cookies</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Token"><span class="toc-number">1.4.3.</span> <span class="toc-text">Token</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#修改配置"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">修改配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Bean"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">Bean</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security——定制跳转"><span class="toc-number">1.5.</span> <span class="toc-text">Security——定制跳转</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/tou.jpg"></div><div class="author-info__name text-center">攀</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Antarctica000">GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">60</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">33</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">链接</div><a class="author-info-links__name text-center" href="http://antarctica.gitee.io/blog/" target="_blank" rel="noopener">码云的Blog</a><a class="author-info-links__name text-center" href="https://github.com/Antarctica000/Concurrent-programming">GItHub配套资源</a><a class="author-info-links__name text-center" href="https://translate.google.cn/" target="_blank" rel="noopener">Google翻译</a><a class="author-info-links__name text-center" href="https://www.bilibili.com/" target="_blank" rel="noopener">bilibili</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-1251750343.cos.ap-beijing.myqcloud.com/blog/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">小世界</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">SpringBoot整合Security框架</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-24</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="Spring-Security"><a href="#Spring-Security" class="headerlink" title="Spring Security"></a>Spring Security</h2><p>“万一我随便输入一个账号，再随便输入一堆密码，就登录到了马云的淘宝号呢？”:yum:</p>
<p>“那阿里又要向社会输入工作十年的人才了。”:happy:</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><p>我们之前在众多的实验中，无论虽然对业务逻辑的处理和持久层的操作，都封装在后端，无法被轻易访问。但是，要调用的时候，还是需要通过前端的控制层，以及thymeleaf页面来完成，这个时候很多操作都可以从url头直接进行，而不加以限制，这样是不完善的。</p>
<p>粗俗一点讲，就是我们需要登录了才能访问页面，其他的请求将通通加以限制。</p>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架（简单说是对访问权限进行控制嘛）。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IoC，DI（控制反转Inversion of Control ,DI:Dependency Injection 依赖注入）和AOP（面向切面编程）功能，为应用系统提供声明式的安全访问控制功能，减少了为企业系统安全控制编写大量重复代码的工作。</p>
<p>可以简单地认为 Spring Security 是放在用户和 Spring 应用之间的一个安全屏障, 每一个 web 请求都先要经过 Spring Security 进行 Authenticate 和 Authoration 验证。</p>
<p>我们现在来使用Security框架，来制作需要登录验证的网站模型。</p>
<h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><p>security的理解的使用比较繁杂，我们先把基础配置和重点分开来讲：</p>
<h4 id="依赖与设置"><a href="#依赖与设置" class="headerlink" title="依赖与设置"></a>依赖与设置</h4><h5 id="引入pom依赖："><a href="#引入pom依赖：" class="headerlink" title="引入pom依赖："></a>引入pom依赖：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置yml"><a href="#配置yml" class="headerlink" title="配置yml:"></a>配置yml:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:&#x2F;mapper&#x2F;*.xml</span><br><span class="line">  type-aliases-package: com.example.security.pojo</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    username: root</span><br><span class="line">    password: 123456</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;springtest?useSSL&#x3D;false&amp;serverTimezone&#x3D;GMT%2B8&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf8</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    tomcat:</span><br><span class="line">      max-idle: 10</span><br><span class="line">      max-wait: 10000</span><br><span class="line">      max-active: 50</span><br><span class="line">      initial-size: 5</span><br><span class="line">server:</span><br><span class="line">  port: 8888</span><br></pre></td></tr></table></figure>

<p>这里还是使用mybatis来操作持久层</p>
<h5 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.security.dao.UserMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"String"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">        select * from t_user_roles where username =#&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>mapper的设置，直接获取全部属性。</p>
<h5 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h5><p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/1.png" alt=""></p>
<p>这是数据库的设置，注意roles形式是固定，必须有ROLE_ 前缀</p>
<h4 id="必要的组件"><a href="#必要的组件" class="headerlink" title="必要的组件"></a>必要的组件</h4><p>这里将所有必要的组件类列出来，这里不是重点，但是很有必要。</p>
<h5 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String roles;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dao层"><a href="#dao层" class="headerlink" title="dao层"></a>dao层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">getUser</span><span class="params">(String username)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">     UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.getUser(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="控制层"><a href="#控制层" class="headerlink" title="控制层"></a>控制层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/mypage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">my</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"mypage"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/admin"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">a</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"admin"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">logoutpage</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">        <span class="comment">//Authentication 是一个接口，用来表示用户认证信息</span></span><br><span class="line">        Authentication auth= SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="keyword">if</span> (auth!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">new</span> SecurityContextLogoutHandler().logout(request,response,auth);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重定向到 login</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/login?logout"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里列出了控制层要接收的所有映射，现在暂时不说明他们各自的作用，待会会结合Security的各个配置一并讲解出来。</p>
<h3 id="Security——登录和注销"><a href="#Security——登录和注销" class="headerlink" title="Security——登录和注销"></a>Security——登录和注销</h3><p>这里开始讲述，Security是如何将它们整合起来的。大家可能会发现，上面的Controller层代码并没有Service层的注入，那么控制层是如何从数据库获取验证的呢？这里由下而上，从Service的注入开始。</p>
<h4 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h4><p>Service层的注入在了一个接入了UserDetailsService接口的类里面。而这个类通过重写UserDetailsService的方法，来获取到数据库的用户信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String s)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"通过用户名加载用户"</span>);</span><br><span class="line">        com.example.security.pojo.User user = userService.getUserName(s);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"用户不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(user.getUsername() ,user.getPassword(),</span><br><span class="line">                createAuthority(user.getRoles()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里是将数据库的角色分割，构造GrantedAuthority</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;SimpleGrantedAuthority&gt; <span class="title">createAuthority</span><span class="params">(String roles)</span> </span>&#123;</span><br><span class="line">        String[] roleArray = roles.split(<span class="string">","</span>);</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String role : roleArray) &#123;</span><br><span class="line">            authorityList.add(<span class="keyword">new</span> SimpleGrantedAuthority(role));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorityList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里重写了loadUserByUsername方法，这个方法会返回一个User类，我们会使用服务层的API，从数据库读取数据，让我们的user获得各项信息，在结合自己定义的方法，把我们的Roles划分为一个ArrayList列表。再使用Security的User类去重新构造它，并且返回。</p>
<p>注意，返回的这个User类是属于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br></pre></td></tr></table></figure>

<p>这里在下犯了一个错误，就是不应该直接把实体类的名称直接定义为User，这样导致两个User类产生了冲突，所以在loadUserByUsername方法开头的user实例，使用地址的方式去声明。</p>
<p>那么这个类的方法又会被谁调用呢？</p>
<h4 id="WebSecurityConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h4><p>这个方法会被继承了WebSecurityConfigurerAdapter的类所调用。我们首先要继承WebSecurityConfigurerAdapter，并重写两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyUserDetailService myUserDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">"/"</span>, <span class="string">"/index"</span>).permitAll()<span class="comment">//允许/、/index的访问</span></span><br><span class="line">                .antMatchers(<span class="string">"/mypage/**"</span>).hasAnyRole(<span class="string">"USER"</span>)<span class="comment">//用户USER角色的用户访问有关/mypage下面的所有</span></span><br><span class="line">                .antMatchers(<span class="string">"/admin/**"</span>).hasAnyRole(<span class="string">"ADMIN"</span>)<span class="comment">//同上</span></span><br><span class="line">                .anyRequest().authenticated()<span class="comment">//其它所有访问都拦截</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()<span class="comment">//添加登陆</span></span><br><span class="line">                .loginPage(<span class="string">"/login"</span>).permitAll()<span class="comment">//登陆页面“/login"允许访问</span></span><br><span class="line">                .defaultSuccessUrl(<span class="string">"/mypage"</span>)<span class="comment">//成功默认跳转 url</span></span><br><span class="line">                .usernameParameter(<span class="string">"user"</span>)</span><br><span class="line">                .passwordParameter(<span class="string">"password"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .permitAll()</span><br><span class="line">                <span class="comment">//设置注销操作</span></span><br><span class="line">                <span class="comment">//所有用户都可以访问（可以使用注销）</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling().accessDeniedPage(<span class="string">"/error"</span>);</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        auth</span><br><span class="line">                .userDetailsService(myUserDetailService)</span><br><span class="line">                .passwordEncoder(<span class="keyword">new</span> MyPassWordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在重写了configure(AuthenticationManagerBuilder auth)方法后，调用auth的注册，我们就能把用户的信息注册到整个Servelet的上下文中，使其全局存在，注意这里的MyPassWordEncoder：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPassWordEncoder</span> <span class="keyword">implements</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> charSequence.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(charSequence.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是需要重写PasswordEncoder去实现的，这是为了完成Security的密码加密功能，这里暂时不做延伸。</p>
<p>然后重写的configure(HttpSecurity http)方法，这个方法就是用来拦截请求和注册的，非常的关键。</p>
<p>一开始，便使用了authorizeRequests，来配置和定义请求，使用antMatchers来定义页面和权限的信息。</p>
<p>.and()的作用是连接表示还有事务需要配置</p>
<p>使用.formLogin()去定义登录页面，对于需要权限的请求，都需要跳转到某个url进行登录操作，使用loginPage(“/login”)，表示url，permitAll()表示全部需要权限的页面</p>
<p>最后的logout()表示注销的页面，这里默认为logout，但注销操作实际上要根据业务的需要去定义，一般不会直接定位到某个页面。</p>
<p>.exceptionHandling().accessDeniedPage(“/error”);表示出现权限不足时，需要跳转的页面。</p>
<p>这里就需要重新提起Controller层的操作了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然我们定义了跳转页面，但是我们仍然需要对/login请求进行重新规划，在defaultSuccessUrl中，定义了登录成功后会跳转的URL，这就表示了，如果登录成功，则跳转到相应的URL页面，否则，仍然返回login页面。</p>
<h4 id="注销的实现"><a href="#注销的实现" class="headerlink" title="注销的实现"></a>注销的实现</h4><p>重新看回Controller层的/logout页面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">logoutpage</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">    <span class="comment">//Authentication 是一个接口，用来表示用户认证信息</span></span><br><span class="line">    Authentication auth= SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="keyword">if</span> (auth!=<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">new</span> SecurityContextLogoutHandler().logout(request,response,auth);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重定向到 login</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/login?logout"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们接受到了一个请求，使用（HttpServletRequest request, HttpServletResponse response），去处理这请求。</p>
<p>首先看到SecurityContextHolder.getContext().getAuthentication(); 它获取了我们存在于服务器中的上下文，同时又获取到了该用户的名字，如果该用户存在，则new一个新的用户去相应logout页面，最后再重定向回来。重定向在thymeleaf中也有所提及，是重新访问url页面并执行方法的意思。</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>开始测试，首先需要HTML页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登陆页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.error&#125;"</span>&gt;</span></span><br><span class="line">    密码错误</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;param.logout&#125;"</span>&gt;</span></span><br><span class="line">    您已注销</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/login&#125;"</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"user"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    密码:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember-me"</span>&gt;</span>记住我<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"登陆"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a>登录界面</h5><p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/2.png" alt=""></p>
<p>这个就是登录界面.。</p>
<h5 id="权限页面"><a href="#权限页面" class="headerlink" title="权限页面"></a>权限页面</h5><p>当我们登录了张三这个用户的身份后，将自动跳转到mypage页面</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/4.png" alt=""></p>
<p>再尝试去访问admin页面。</p>
<p> <img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/3.png" alt=""></p>
<p>于是点击退出</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/5.png" alt=""></p>
<p>然后再次用管理员的账号去登录管理员界面</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/6.png" alt=""></p>
<p>完成！余下HTML页面会在文章最后的源码连接中放出。</p>
<h3 id="Security——记住我"><a href="#Security——记住我" class="headerlink" title="Security——记住我"></a>Security——记住我</h3><p>在WebSecurityConfigurerAdapter，选择记住我，但是这个.rememberMe()，也是有着许许多多的层级关系的。</p>
<h4 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h4><p>我们直接配置中使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.rememberMe();</span><br></pre></td></tr></table></figure>

<p>开启的rememberMe()功能，但是它是存储于一个全局的Cookies中的，它会存在一段时间，在这段时间中，即使你切到其他页面，再切回来，也不用登录，但是一旦清除了Cookies，那就必须重新登录了。</p>
<p>同时，除了通过自己去编辑注销之外，还可以使用Security中自带的注销方法，它还可以自定义注销成功跳转的目录。：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.logout().logoutSuccessUrl(<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure>

<p>同时，在控制层中注释掉logout的映射关系，并在html页面上改成：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">"@&#123;/logout&#125;"</span> <span class="attr">method</span>=<span class="string">"post"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"注销"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>它就会提交一个logout请求，而Security就会自动识别到这个请求，来完成我们的注销功能</p>
<p>可以在浏览器中按F12，打开application 的cookies页面，查看jsession信息。</p>
<h4 id="自定义Cookies"><a href="#自定义Cookies" class="headerlink" title="自定义Cookies"></a>自定义Cookies</h4><p>我们还可以使用自定义Cookies去存储用户信息，使我们在关闭浏览器后，还缓存固定的时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests()                </span><br><span class="line">    .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .key(<span class="string">"uniqueAndSecret"</span>)</span><br><span class="line">                .rememberMeCookieName(<span class="string">"remember-me"</span>)</span><br><span class="line">                .tokenValiditySeconds(<span class="number">60</span>);</span><br></pre></td></tr></table></figure>

<p>重新添加这段代码后，我们就将用户信息缓存在了Cookies中。</p>
<p>使用.key(“uniqueAndSecret”)，指定缓存的键名，.rememberMeCookieName(“remember-me”)指定Cookies名。</p>
<p>.tokenValiditySeconds(60);则是指定Cookies时间，这里使用60秒来进行测试，我们可以在测试后发现，它确实在关闭浏览器后，仍然仍然存在。</p>
<h4 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h4><p>但是使用Cookies还是有着弊端，那就是我们再使用什么清理垃圾软件清理缓存的时候，将全部被清除掉，或者对于不支持缓存的浏览器而言，也是极其致命的，于是，我们可以将数据放到数据库中。这样就没有问题了。</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/8.jpg" alt=""></p>
<h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests()</span><br><span class="line">        .and()</span><br><span class="line">        .rememberMe()</span><br><span class="line">        .tokenRepository(persistentTokenRepository())</span><br><span class="line">        .tokenValiditySeconds(<span class="number">60</span>)</span><br><span class="line">        .userDetailsService(myUserDetailService);</span><br></pre></td></tr></table></figure>

<p>增加这项配置，注意 .tokenRepository 将会注册一个处理方法：</p>
<h5 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PersistentTokenRepository <span class="title">persistentTokenRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JdbcTokenRepositoryImpl jdbcTokenRepository = <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line">    <span class="comment">// 配置数据源</span></span><br><span class="line">    jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">    <span class="comment">// 第一次启动的时候自动建表</span></span><br><span class="line">     <span class="comment">//jdbcTokenRepository.setCreateTableOnStartup(true);</span></span><br><span class="line">    <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里配置了PersistentTokenRepository，也就是Token的处理方法。当我们开启了这个后，可以访问页面，这个时候便可以再去观察数据库，你会发现：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/security/7.png" alt=""></p>
<p>这个便是我们的登录的信息，它会被存储在数据库里，它也会再时间过期后，将用户登录信息给无效化。</p>
<h3 id="Security——定制跳转"><a href="#Security——定制跳转" class="headerlink" title="Security——定制跳转"></a>Security——定制跳转</h3><p>我们也可以在登录成功后，定制跳转页面，使得我们拥有admin权限的用户直接跳转到后台管理页面，而user权限的则跳转默认的主页。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">AuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"AppSecurityConfigurer()调用-------"</span>);</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">            <span class="comment">//spring-scurity 5.0之后需要过滤静态资源</span></span><br><span class="line"></span><br><span class="line">            .antMatchers(<span class="string">"/login"</span>,<span class="string">"/css/**"</span>,<span class="string">"/js/**"</span>,<span class="string">"/img/**"</span>).permitAll()</span><br><span class="line">            <span class="comment">//指定用户可以访问的多个url模式。</span></span><br><span class="line">            <span class="comment">// 特别的，任何用户可以访问以"/resources"开头的url资源，或者等于"/signup"或about</span></span><br><span class="line"></span><br><span class="line">            .antMatchers(<span class="string">"/"</span>,<span class="string">"/home"</span>).hasRole(<span class="string">"USER"</span>)</span><br><span class="line">            <span class="comment">//任何以"/home"开头的请求限制用户具有 "ROLE_USER"角色。</span></span><br><span class="line">            <span class="comment">// 你可能已经注意的，尽管我们调用的hasRole方法，但是不用传入"ROLE_"前缀</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            .antMatchers(<span class="string">"/admin/**"</span>).hasAnyRole(<span class="string">"ADMIN"</span>,<span class="string">"DBA"</span>)</span><br><span class="line">            <span class="comment">//这个是拥有其中一个权限都能使用</span></span><br><span class="line"></span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            <span class="comment">//任何没有匹配上的其他的url请求，需要用户被验证。</span></span><br><span class="line"></span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">//拼接</span></span><br><span class="line"></span><br><span class="line">            .formLogin().loginPage(<span class="string">"/login"</span>)</span><br><span class="line">            <span class="comment">//开始设置登录操作</span></span><br><span class="line">            <span class="comment">//设置登录页面的访问地址</span></span><br><span class="line"></span><br><span class="line">            .successHandler(authenticationSuccessHandler)</span><br><span class="line">            <span class="comment">//设置了一个认证处理，登录成功后不同用户需要跳转到不同的页面</span></span><br><span class="line">            <span class="comment">//以此认证，视为通行证</span></span><br><span class="line"></span><br><span class="line">            .usernameParameter(<span class="string">"loginName"</span>).passwordParameter(<span class="string">"password"</span>)</span><br><span class="line">            <span class="comment">//登录时接受传递的参数 loginName 和password</span></span><br><span class="line">            <span class="comment">//注意大小写</span></span><br><span class="line"></span><br><span class="line">            .and()</span><br><span class="line">            .logout().permitAll()</span><br><span class="line">            <span class="comment">//设置注销操作</span></span><br><span class="line">            <span class="comment">//所有用户都可以访问（可以使用注销）</span></span><br><span class="line"></span><br><span class="line">            .and()</span><br><span class="line">            .exceptionHandling().accessDeniedPage(<span class="string">"/accessDenied"</span>);</span><br><span class="line">    <span class="comment">//指定异常处理页面</span></span><br><span class="line">    <span class="comment">//特别是在没有权限的时候使用发生的错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这便是我们重新写的http处理。注释写完整了各个位置的含义。</p>
<p>以下是AuthenticationSuccessHandler 处理方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationSuccessHandler</span> <span class="keyword">extends</span> <span class="title">SimpleUrlAuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//spring security 通过RedirectStrategy 对象负责所有重定向事务</span></span><br><span class="line">    <span class="keyword">private</span> RedirectStrategy redirectStrategy=<span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    重写 handle 方法，方法中通过 RedirectStrategy 对象重定向到指定的url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">//通过determineTargetURL方法返回需要跳转的URL</span></span><br><span class="line">        String targetUrl=determineTargetUrl(authentication);</span><br><span class="line">        <span class="comment">//重定向请求指定的URL</span></span><br><span class="line">        redirectStrategy.sendRedirect(request,response,targetUrl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    从Authentication 对象中提取当前登录用户的角色，并根据其角色返回适当的URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">determineTargetUrl</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">        String url=<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前登录用户的角色权限到集合 authentication</span></span><br><span class="line">        Collection&lt;? extends GrantedAuthority&gt; authorities=authentication.getAuthorities();</span><br><span class="line">        <span class="comment">//Collection是最基本的集合接口，</span></span><br><span class="line">        <span class="comment">// 一个Collection代表一组Object，即Collection的元素（Elements）。</span></span><br><span class="line">        <span class="comment">// 一些Collection允许相同的元素而另一些不行。一些能排序而另一些不行。</span></span><br><span class="line">        <span class="comment">// Java SDK不提供直接继承自Collection的类，</span></span><br><span class="line">        <span class="comment">// Java SDK提供的类都是继承自Collection的“子接口”如List和Set。</span></span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; roles=<span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将角色名称添加到List集合</span></span><br><span class="line">        <span class="keyword">for</span> (GrantedAuthority a:authorities)</span><br><span class="line">        &#123;</span><br><span class="line">            roles.add(a.getAuthority());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断不同角色跳转到不同的URL</span></span><br><span class="line">        <span class="keyword">if</span>(isAdmin(roles))</span><br><span class="line">        &#123;</span><br><span class="line">            url=<span class="string">"/admin"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (isUser(roles))&#123;</span><br><span class="line">            url=<span class="string">"/home"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;url=<span class="string">"/accessDenied"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"url="</span>+url);</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isUser</span><span class="params">(List&lt;String&gt; roles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (roles.contains(<span class="string">"ROLE_USER"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span><span class="params">(List&lt;String&gt; roles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (roles.contains(<span class="string">"ROLE_ADMIN"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//set 和  get</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectStrategy <span class="title">getRedirectStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redirectStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRedirectStrategy</span><span class="params">(RedirectStrategy redirectStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.redirectStrategy = redirectStrategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>源码地址：</p>
<p><a href="https://github.com/Antarctica000/SpringBoot/tree/master/security">https://github.com/Antarctica000/SpringBoot/tree/master/security</a></p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/Security/">Security</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/01/27/mysql1/"><i class="fa fa-chevron-left">  </i><span>MySQL体系结构</span></a></div><div class="next-post pull-right"><a href="/2020/01/21/spring6/"><span>SpringBoot整合Thymeleaf</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://blog-1251750343.cos.ap-beijing.myqcloud.com/blog/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By 攀</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>