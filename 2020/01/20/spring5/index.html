<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="知识整合：抢购商品"><meta name="keywords" content="SpringBoot,Redis,项目,MyBtis,定时任务"><meta name="author" content="攀"><meta name="copyright" content="攀"><title>知识整合：抢购商品 | 小世界</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="小世界" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#高并发下抢购商品"><span class="toc-number">1.</span> <span class="toc-text">高并发下抢购商品</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设计与开发"><span class="toc-number">1.1.</span> <span class="toc-text">设计与开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据库"><span class="toc-number">1.1.1.</span> <span class="toc-text">数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#持久层开发"><span class="toc-number">1.1.2.</span> <span class="toc-text">持久层开发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#实体类"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">实体类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#xml设计"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">xml设计</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dao层"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">dao层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置文件"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#服务层"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">服务层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#控制层"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">控制层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Html"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">Html</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">1.1.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高并发情况下"><span class="toc-number">1.2.</span> <span class="toc-text">高并发情况下</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#500次抢购"><span class="toc-number">1.2.1.</span> <span class="toc-text">500次抢购</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用悲观锁"><span class="toc-number">1.2.2.</span> <span class="toc-text">使用悲观锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用乐观锁"><span class="toc-number">1.2.3.</span> <span class="toc-text">使用乐观锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#增加版本号判断"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">增加版本号判断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#按时间戳重入"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">按时间戳重入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#按次数重入"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">按次数重入</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用Redis处理高并发"><span class="toc-number">1.2.4.</span> <span class="toc-text">使用Redis处理高并发</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置文件："><span class="toc-number">1.2.4.1.</span> <span class="toc-text">配置文件：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#服务层-1"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">服务层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#开启定时任务"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">开启定时任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#增加定时任务接口"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">增加定时任务接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#定时任务服务"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">定时任务服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改控制层"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">修改控制层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-1"><span class="toc-number">1.2.4.7.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/pandalee99/image_store/master/hexo/c17f0489-42cd-439a-94bd-0612598b142f.jpg"></div><div class="author-info__name text-center">攀</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Pandalee99">GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">102</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">69</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">链接</div><a class="author-info-links__name text-center" href="https://github.com/Pandalee99/Concurrent-programming">GItHub配套资源</a><a class="author-info-links__name text-center" href="https://translate.google.cn/" target="_blank" rel="noopener">Google翻译</a><a class="author-info-links__name text-center" href="https://www.bilibili.com/" target="_blank" rel="noopener">bilibili</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">小世界</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">知识整合：抢购商品</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-20</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="高并发下抢购商品"><a href="#高并发下抢购商品" class="headerlink" title="高并发下抢购商品"></a>高并发下抢购商品</h2><p>这次做一个知识的总结，把之前所学习的mybatis、redis，rest、和并发编程相关的内容整合起来，模拟一个小型的场景。</p>
<p>这次场景叫做：抢购商品。我们在淘宝或者京东买东西的时候，偶尔某些商品会有一些打折期。这时候就有很多人去抢购商品，同时也是最考验我们数据库性能和后端设计的时候了。</p>
<h3 id="设计与开发"><a href="#设计与开发" class="headerlink" title="设计与开发"></a>设计与开发</h3><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>先建立两个表，分别为产品表和订单表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`springtest`</span>.<span class="string">`t_product`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`product_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">45</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'产品名称'</span>,</span><br><span class="line">  <span class="string">`stock`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'库存'</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'单价'</span>,</span><br><span class="line">  <span class="string">`version`</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'版本号'</span>,</span><br><span class="line">  <span class="string">`note`</span> <span class="built_in">VARCHAR</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>));</span><br></pre></td></tr></table></figure>

<p>订单表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`springtest`</span>.<span class="string">`t_purchase_record`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">INT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户编号'</span>,</span><br><span class="line">  <span class="string">`product_id`</span> <span class="built_in">INT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'产品编号'</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格'</span>,</span><br><span class="line">  <span class="string">`quantity`</span> <span class="built_in">INT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'数量'</span>,</span><br><span class="line">  <span class="string">`sum`</span> <span class="built_in">DECIMAL</span>(<span class="number">16</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'总价'</span>,</span><br><span class="line">  <span class="string">`purchase_date`</span> <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">now</span>() <span class="keyword">COMMENT</span> <span class="string">'购买日期'</span>,</span><br><span class="line">  <span class="string">`note`</span> <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>));</span><br></pre></td></tr></table></figure>

<h4 id="持久层开发"><a href="#持久层开发" class="headerlink" title="持久层开发"></a>持久层开发</h4><h5 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductPo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3288311147760635602L</span>;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> stock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> price;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> version;</span><br><span class="line">    <span class="keyword">private</span> String note;   </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Alias</span>(<span class="string">"purchaseRecord"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseRecordPo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">360816189433370174L</span>;</span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> Long userId;</span><br><span class="line">	<span class="keyword">private</span> Long productId;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> price;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> quantity;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">double</span> sum;</span><br><span class="line">	<span class="keyword">private</span> Timestamp purchaseTime;</span><br><span class="line">	<span class="keyword">private</span> String note;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里接入了 Serializable，之所以要这么做，是为了<strong>序列化</strong>。</p>
<p>什么情况下需要序列化？</p>
<ul>
<li>a）当你想把的内存中的对象写入到硬盘的时候；</li>
<li>b）当你想用套接字在网络上传送对象的时候；</li>
<li>c）当你想通过RMI传输对象的时候</li>
</ul>
<p>总的就是说安全性问题，具体原因见解释：假如没有一个接口（即没有Serializable来标记是否可以序列化），让所有对象都可以序列化。那么所有对象通过序列化存储到硬盘上后，都可以在序列化得到的文件中看到属性对应的值（后面将会通过代码展示）。所以最后为了安全性（即不让一些对象中私有属性的值被外露），不能让所有对象都可以序列化。要让用户自己来选择是否可以序列化，因此需要一个接口来标记该类是否可序列化。。</p>
<p>最重要的两个原因是：<br>　　1、将对象的状态保存在存储媒体中以便可以在以后重新创建出完全相同的副本；<br>　　2、按值将对象从一个应用程序域发送至另一个应用程序域。<br>通俗的说：在分布式应用中，你就得实现序列化，如果你不需要分布式应用，那就没那个必要实现序列化。</p>
<h5 id="xml设计"><a href="#xml设计" class="headerlink" title="xml设计"></a>xml设计</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.designshop.dao.ProductDao"</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 获取产品 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getProduct"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"product"</span>&gt;</span></span><br><span class="line">		select id, product_name as productName,</span><br><span class="line">		stock, price, version, note from t_product</span><br><span class="line">		where id=#&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 减库存 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseProduct"</span>&gt;</span></span><br><span class="line">		update t_product set stock = stock - #&#123;quantity&#125;,</span><br><span class="line">		version = version +1</span><br><span class="line">		where id = #&#123;id&#125; </span><br><span class="line">	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.example.designshop.dao.PurchaseRecordDao"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertPurchaseRecord"</span> <span class="attr">parameterType</span>=<span class="string">"purchaseRecord"</span>&gt;</span></span><br><span class="line">		insert into t_purchase_record(</span><br><span class="line">		user_id, product_id, price, quantity, sum, purchase_date, note)</span><br><span class="line">		values(#&#123;userId&#125;, #&#123;productId&#125;, #&#123;price&#125;, #&#123;quantity&#125;,</span><br><span class="line">		#&#123;sum&#125;, now(), #&#123;note&#125;)</span><br><span class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="dao层"><a href="#dao层" class="headerlink" title="dao层"></a>dao层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductDao</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取产品</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProductPo <span class="title">getProduct</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//减库存，而@Param标明MyBatis参数传递给后台</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseProduct</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Long id, @<span class="title">Param</span><span class="params">(<span class="string">"quantity"</span>)</span> <span class="keyword">int</span> quantity)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseRecordDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertPurchaseRecord</span><span class="params">(PurchaseRecordPo pr)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:&#x2F;mapper&#x2F;*.xml</span><br><span class="line">  type-aliases-package: com.example.designshop.pojo</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    username: root</span><br><span class="line">    password: 123456</span><br><span class="line">    url: jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;springtest?useSSL&#x3D;false&amp;serverTimezone&#x3D;GMT%2B8&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf8</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    tomcat:</span><br><span class="line">      max-idle: 10</span><br><span class="line">      max-wait: 10000</span><br><span class="line">      max-active: 50</span><br><span class="line">      initial-size: 5</span><br><span class="line">      # 隔离级别为读写提交</span><br><span class="line">      default-transaction-isolation: 2</span><br><span class="line">server:</span><br><span class="line">  port: 8888</span><br></pre></td></tr></table></figure>

<p>隔离级别涉及到数据库事务相关，譬如脏读可重复读等待，以后会讲。</p>
<h5 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PurchaseService</span> </span>&#123;	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 处理购买业务</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId 用户编号</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> productId 产品编号</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> quantity 购买数量</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> 成功or失败</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchase</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseServiceImpl</span> <span class="keyword">implements</span> <span class="title">PurchaseService</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProductDao productDao = <span class="keyword">null</span>;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> PurchaseRecordDao purchaseRecordDao = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	 <span class="meta">@Override</span></span><br><span class="line">	 <span class="comment">// 启动Spring数据库事务机制</span></span><br><span class="line">	 <span class="meta">@Transactional</span></span><br><span class="line">	 <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchase</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">	 <span class="comment">// 获取产品</span></span><br><span class="line">	 ProductPo product = productDao.getProduct(productId);</span><br><span class="line">	 <span class="comment">// 比较库存和购买数量</span></span><br><span class="line">	 <span class="keyword">if</span> (product.getStock() &lt; quantity) &#123;</span><br><span class="line">	 <span class="comment">// 库存不足</span></span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	 &#125;</span><br><span class="line">	 <span class="comment">// 扣减库存</span></span><br><span class="line">	 productDao.decreaseProduct(productId, quantity);</span><br><span class="line">	 <span class="comment">// 初始化购买记录</span></span><br><span class="line">	 PurchaseRecordPo pr = <span class="keyword">this</span>.initPurchaseRecord(userId, product, quantity);</span><br><span class="line">	 <span class="comment">// 插入购买记录</span></span><br><span class="line">	 purchaseRecordDao.insertPurchaseRecord(pr);</span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	 &#125;</span><br><span class="line">    	<span class="comment">// 初始化购买信息</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> PurchaseRecordPo <span class="title">initPurchaseRecord</span><span class="params">(Long userId, ProductPo product, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">		PurchaseRecordPo pr = <span class="keyword">new</span> PurchaseRecordPo();</span><br><span class="line">		pr.setNote(<span class="string">"购买日志，时间："</span> + System.currentTimeMillis());</span><br><span class="line">		pr.setPrice(product.getPrice());</span><br><span class="line">		pr.setProductId(product.getId());</span><br><span class="line">		pr.setQuantity(quantity);</span><br><span class="line">		<span class="keyword">double</span> sum = product.getPrice() * quantity;</span><br><span class="line">		pr.setSum(sum);</span><br><span class="line">		pr.setUserId(userId);</span><br><span class="line">		<span class="keyword">return</span> pr;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里很明显的可以看到，我们从Dao层读取数据，看看是否还有库存，如果库存不足，则直接返回false，否则进行扣减库存，并且更新订单表。</p>
<h5 id="控制层"><a href="#控制层" class="headerlink" title="控制层"></a>控制层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// REST风格控制器</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PurchaseController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	PurchaseService purchaseService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ModelAndView <span class="title">testPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		ModelAndView mv = <span class="keyword">new</span> ModelAndView(<span class="string">"test"</span>);</span><br><span class="line">		<span class="keyword">return</span> mv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping</span>(<span class="string">"/purchase"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Result <span class="title">purchase</span><span class="params">(Long userId, Long productId, Integer quantity)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> success = purchaseService.purchase(userId, productId, quantity);</span><br><span class="line">		String message = success ? <span class="string">"抢购成功"</span> : <span class="string">"抢购失败"</span>;</span><br><span class="line">		Result result = <span class="keyword">new</span> Result(success, message);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">    	<span class="comment">// 响应结果</span></span><br><span class="line">	<span class="meta">@Data</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">private</span> String message = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Result</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Result</span><span class="params">(<span class="keyword">boolean</span> success, String message)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.success = success;</span><br><span class="line">			<span class="keyword">this</span>.message = message;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制层从从服务层调用方法，并且将数据装进响应结果里面。可以从控制层看到的是，我们是通过result传达信息到前端的。</p>
<h5 id="Html"><a href="#Html" class="headerlink" title="Html"></a>Html</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-3.2.1.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--后面需要改写这段JavaScript脚本进行测试--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">         <span class="keyword">var</span> params = &#123;</span></span><br><span class="line">             userId : 1,</span><br><span class="line">             productId : 1,</span><br><span class="line">             quantity : 3</span><br><span class="line">         &#125;;</span><br><span class="line"><span class="actionscript">         <span class="comment">// 通过POST请求后端</span></span></span><br><span class="line"><span class="javascript">         $.post(<span class="string">"./purchase"</span>, params, <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span></span><br><span class="line">             alert(result.message);</span><br><span class="line">         &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>前端会使用post方法，去请求后端，执行方法。</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>这是数据库库存：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/1.png" alt=""></p>
<p>在网页输入 <a href="http://localhost:8888/test" target="_blank" rel="noopener">http://localhost:8888/test</a></p>
<p>测试结果：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/3.png" alt=""></p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/2.png" alt=""></p>
<p>抢购成功！</p>
<p>回看数据库：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/4.png" alt=""></p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/5.png" alt=""></p>
<h3 id="高并发情况下"><a href="#高并发情况下" class="headerlink" title="高并发情况下"></a>高并发情况下</h3><h4 id="500次抢购"><a href="#500次抢购" class="headerlink" title="500次抢购"></a>500次抢购</h4><p>上面的例子仅仅是在一个单例进行的测试，那么，在高并发情况下，有着很多很多的请求呢？</p>
<p>我们假设有300的库存：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/6.png" alt=""></p>
<p>在html页面设置 500次抢购：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for (var i=1; i<span class="tag">&lt;<span class="name">=500;</span> <span class="attr">i</span>++) &#123;</span></span><br><span class="line"><span class="tag">    <span class="attr">var</span> <span class="attr">params</span> = <span class="string">&#123;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">userId</span> <span class="attr">:</span> <span class="attr">1</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">productId</span> <span class="attr">:</span> <span class="attr">1</span>,</span></span><br><span class="line"><span class="tag">        <span class="attr">quantity</span> <span class="attr">:</span> <span class="attr">1</span></span></span><br><span class="line"><span class="tag">    &#125;;</span></span><br><span class="line"><span class="tag">    // 通过<span class="attr">POST</span>请求后端,这里的<span class="attr">JavaScript</span>会采用异步请求</span></span><br><span class="line"><span class="tag">    $<span class="attr">.post</span>("<span class="attr">.</span>/<span class="attr">purchase</span>", <span class="attr">params</span>, <span class="attr">function</span>(<span class="attr">result</span>) &#123;</span></span><br><span class="line"><span class="tag">    &#125;);</span></span><br><span class="line"><span class="tag">&#125;</span></span><br></pre></td></tr></table></figure>

<p>再次输入  <a href="http://localhost:8888/test" target="_blank" rel="noopener">http://localhost:8888/test</a> 进行测试：</p>
<p>结果：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/7.png" alt=""></p>
<p>？？？？   -5？</p>
<p>为什么会有这样数据，我们再看看订单表：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/8.png" alt=""></p>
<p>确实有着305条订单，显然，数据库事务的读写级别虽然达到了一致性，却没有达到原子性。面对这种情况，根据我们所学的知识，在并发编程里，可以使用<strong>锁</strong>去完成。</p>
<h4 id="使用悲观锁"><a href="#使用悲观锁" class="headerlink" title="使用悲观锁"></a>使用悲观锁</h4><p>在这样的高并发情况下，最简单粗暴的解决方法就是加锁，下面我们为数据库加一条锁，在xml 加入 for update 。就使用了悲观锁，当前的SQL被执行时，不允许其他线程执行该SQL。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getProduct"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"product"</span>&gt;</span></span><br><span class="line">	select id, product_name as productName,</span><br><span class="line">	stock, price, version, note from t_product</span><br><span class="line">	where id=#&#123;id&#125; for update </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再打开 <a href="http://localhost:8888/test" target="_blank" rel="noopener">http://localhost:8888/test</a>  进行测试：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/9.png" alt=""></p>
<p>我们发现，成功保持了只有300条的订单。但是，在使用这样悲观锁的前提下，数据库的性能会变成很差，效率也就变的缓慢。所以，我们开始引入乐观锁。</p>
<h4 id="使用乐观锁"><a href="#使用乐观锁" class="headerlink" title="使用乐观锁"></a>使用乐观锁</h4><p>乐观锁是一种不使用数据库锁和不阻塞线程并发的方案。就是一个线程一开始先读取商品库存数据，保存起来，我们把这些旧数据称之为旧值，然后执行一定的业务逻辑，等到需要对共享数据做修改时，会事先将保存的旧值库存与当前数据库的库存进行比较，如果旧值与当前库存一致，它就认为数据没有被修改过，否则就认为数据已经被修改过，当前计算将不被信任，所以就不再修改任何数据。</p>
<p>这就是多线程的概念 :CAS</p>
<p>然而，这一种方案却会引发一种ABA问题。关于ABA问题，之前在讲AtomicInteger 的时候谈论过，这里再放一个例子：</p>
<p>AbA问题的产生：要了解什么是ABA问题，首先我们来通俗的看一下这个例子，一家火锅店为了生意推出了一个特别活动，凡是在五一期间的老用户凡是卡里余额小于20的，赠送10元，但是这种活动没人只可享受一次。然后火锅店的后台程序员小王开始工作了，很简单就用cas技术，先去用户卡里的余额，然后包装成AtomicInteger，写一个判断，开启10个线程，然后判断小于20的，一律加20，然后就很开心的交差了。可是过了一段时间，发现账面亏损的厉害，老板起先的预支是2000块，因为店里的会员总共也就100多个，就算每人都符合条件，最多也就2000啊，怎么预支了这么多。小王一下就懵逼了，赶紧debug，tail -f一下日志，这不看不知道，一看吓一跳，有个客户被充值了10次!</p>
<p>阐述：</p>
<p>假设有个线程A去判断账户里的钱此时是15，满足条件，直接+20，这时候卡里余额是35.但是此时不巧，正好在连锁店里，这个客人正在消费，又消费了20，此时卡里余额又为15，线程B去执行扫描账户的时候，发现它又小于20，又用过cas给它加了20，这样的话就相当于加了两次，这样循环往复肯定把老板的钱就坑没了！</p>
<p>本质：</p>
<p>ABA问题的根本在于cas在修改变量的时候，无法记录变量的状态，比如修改的次数，否修改过这个变量。这样就很容易在一个线程将A修改成B时，另一个线程又会把B修改成A,造成casd多次执行的问题。</p>
<p>为了解决这样的问题，我们在这个例子中引入了版本号。</p>
<h5 id="增加版本号判断"><a href="#增加版本号判断" class="headerlink" title="增加版本号判断"></a>增加版本号判断</h5><p>在xml中修改：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 减库存 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"decreaseProduct"</span>&gt;</span></span><br><span class="line">	update t_product set stock = stock - #&#123;quantity&#125;,</span><br><span class="line">	version = version +1</span><br><span class="line">	where id = #&#123;id&#125; and version =  #&#123;version&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在DAO层中修改定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decreaseProduct</span><span class="params">(@Param(<span class="string">"id"</span>)</span> Long id,</span></span><br><span class="line"><span class="function">	    @<span class="title">Param</span><span class="params">(<span class="string">"quantity"</span>)</span> <span class="keyword">int</span> quantity, @<span class="title">Param</span><span class="params">(<span class="string">"version"</span>)</span> <span class="keyword">int</span> version)</span>;</span><br></pre></td></tr></table></figure>

<p>修改服务层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// 启动Spring数据库事务机制</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchase</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 获取产品（线程旧值）</span></span><br><span class="line">ProductPo product = productDao.getProduct(productId);</span><br><span class="line"><span class="comment">// 比较库存和购买数量</span></span><br><span class="line"><span class="keyword">if</span> (product.getStock() &lt; quantity) &#123;</span><br><span class="line"><span class="comment">// 库存不足</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取当前版本号</span></span><br><span class="line"><span class="keyword">int</span> version = product.getVersion();</span><br><span class="line"><span class="comment">// 扣减库存,同时将当前版本号发送给后台去比较</span></span><br><span class="line"><span class="keyword">int</span> result = productDao.decreaseProduct(productId, quantity, version);</span><br><span class="line"><span class="comment">// 如果更新数据失败，说明数据在多线程中被其他线程修改，导致失败返回</span></span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 初始化购买记录</span></span><br><span class="line">PurchaseRecordPo pr = <span class="keyword">this</span>.initPurchaseRecord(userId, product, quantity);</span><br><span class="line"><span class="comment">// 插入购买记录</span></span><br><span class="line">purchaseRecordDao.insertPurchaseRecord(pr);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到，我们每次执行都会去数据库读取版本号，如果一致则版本号+1，并且修改，否则则返回false。</p>
<p>再次测试：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/10.png" alt=""></p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/11.png" alt=""></p>
<p>居然还有库存？？？</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/12.png" alt=""></p>
<p>显然，大量的请求得到了大量的失败，这就导致了我们500次的读取却只有84次是成功的。</p>
<p>为了解决这个问题，乐观锁还可以引入重入机制，就是一旦更新失败，就重新做一次，而不是结束请求。</p>
<h5 id="按时间戳重入"><a href="#按时间戳重入" class="headerlink" title="按时间戳重入"></a>按时间戳重入</h5><p>但是这样又引入了其他问题，比如，SQL被执行的次数总数恐怕达到了上千次。为了克服这个问题，我们引入时间戳的方法来试试重入机制。</p>
<p>修改服务层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动Spring数据库事务机制</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchase</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 当前时间</span></span><br><span class="line">	<span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">	<span class="comment">// 循环尝试直至成功</span></span><br><span class="line">	<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">		<span class="comment">// 循环时间</span></span><br><span class="line">		<span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">		<span class="comment">// 如果循环时间大于100毫秒返回终止循环</span></span><br><span class="line">		<span class="keyword">if</span> (end - start &gt; <span class="number">100</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 获取产品</span></span><br><span class="line">		ProductPo product = productDao.getProduct(productId);</span><br><span class="line">		<span class="comment">// 获取当前版本号</span></span><br><span class="line">		<span class="keyword">int</span> version = product.getVersion();</span><br><span class="line">		<span class="comment">// 比较库存和购买数量</span></span><br><span class="line">		<span class="keyword">if</span> (product.getStock() &lt; quantity) &#123;</span><br><span class="line">			<span class="comment">// 库存不足</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 扣减库存,同时将当前版本号发送给后台去比较</span></span><br><span class="line">		<span class="keyword">int</span> result = productDao.decreaseProduct(productId, quantity, version);</span><br><span class="line">		<span class="comment">// 如果更新数据失败，说明数据在多线程中被其他线程修改，</span></span><br><span class="line">		<span class="comment">// 导致失败，则通过循环重入尝试购买商品</span></span><br><span class="line">		<span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 初始化购买记录</span></span><br><span class="line">		PurchaseRecordPo pr = <span class="keyword">this</span>.initPurchaseRecord(userId, product, quantity);</span><br><span class="line">		<span class="comment">// 插入购买记录</span></span><br><span class="line">		purchaseRecordDao.insertPurchaseRecord(pr);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将一个请求限制为100ms的生存期，如果在100ms内发生版本号冲突而不能更新的，则重新尝试，否则请求失败。</p>
<p>开始测试：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/13.png" alt=""></p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/14.png" alt=""></p>
<p>可以看到，测试成功了。</p>
<p>但是按照时间戳重入也有一个弊端，那就是系统会随着自身的忙碌而大大减少重入次数，因此有时候也会采用按次数重入的机制。</p>
<h5 id="按次数重入"><a href="#按次数重入" class="headerlink" title="按次数重入"></a>按次数重入</h5><p>服务层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// 启动Spring数据库事务机制，并将隔离级别设置为读写提交</span></span><br><span class="line"><span class="meta">@Transactional</span>(isolation = Isolation.READ_COMMITTED)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchase</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 循环尝试直至成功</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 循环时间</span></span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 如果循环时间大于100毫秒返回终止循环</span></span><br><span class="line">        <span class="keyword">if</span> (end - start &gt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取产品</span></span><br><span class="line">        ProductPo product = productDao.getProduct(productId);</span><br><span class="line">        <span class="comment">// 比较库存和购买数量</span></span><br><span class="line">        <span class="keyword">if</span> (product.getStock() &lt; quantity) &#123;</span><br><span class="line">            <span class="comment">// 库存不足</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取当前版本号</span></span><br><span class="line">        <span class="keyword">int</span> version = product.getVersion();</span><br><span class="line">        <span class="comment">// 扣减库存,同时将当前版本号发送给后台去比较</span></span><br><span class="line">        <span class="keyword">int</span> result = productDao.decreaseProduct(productId, quantity,version);</span><br><span class="line">        <span class="comment">// 如果更新数据失败，说明数据在多线程中被其他线程修改，</span></span><br><span class="line">        <span class="comment">// 导致失败，则通过循环重入尝试购买商品</span></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化购买记录</span></span><br><span class="line">        PurchaseRecordPo pr = <span class="keyword">this</span>.initPurchaseRecord(userId, product, quantity);</span><br><span class="line">        <span class="comment">// 插入购买记录</span></span><br><span class="line">        purchaseRecordDao.insertPurchaseRecord(pr);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里使用for的三重循环进行尝试。三次去尝试获取锁，如果都不能够成功获得，则请求失败。但是使用乐观锁，还是一个相对来说比较复杂的方式，因为在不同场景下势必要在后端中多次更改代码。现在，可以使用Redis缓存，去解决这个问题。</p>
<h4 id="使用Redis处理高并发"><a href="#使用Redis处理高并发" class="headerlink" title="使用Redis处理高并发"></a>使用Redis处理高并发</h4><p>在高并发的环境下，仅仅使用数据库去完成业务，是不够的。在前人的摸索中，开发出了一个叫Redis的缓存，去搭配数据库完成业务。</p>
<p>数据库是一个读写磁盘的过程，这个速度显然没有直接写入内存的Redis快。Redis的机制也能够帮助我们克服超发现象。但是，因为其命令方式的运算能力比较薄弱，所以往往采用Redis Luau去代替它原有的命令方式。</p>
<p>Redis Lua在Redis的执行中是具备原子性的，当它被执行时不会被其他客户端发送的命令所打断，通过这样一种机制可以在高并发环境下考虑使用Redis去代替数据库作为响应用户的数据载体。</p>
<p>设计主要分两部分：</p>
<ul>
<li>先使用Redis响应高并发用户的请求。</li>
<li>启动定时任务将Redis保存到数据库。</li>
</ul>
<h5 id="配置文件："><a href="#配置文件：" class="headerlink" title="配置文件："></a>配置文件：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis:</span><br><span class="line">  jedis:</span><br><span class="line">    pool:</span><br><span class="line">      min-idle: 5</span><br><span class="line">      max-active: 10</span><br><span class="line">      max-idle: 10</span><br><span class="line">      max-wait: 2000</span><br><span class="line">  port: 6379</span><br><span class="line">  host: localhost</span><br><span class="line">  timeout: 1000</span><br></pre></td></tr></table></figure>

<h5 id="服务层-1"><a href="#服务层-1" class="headerlink" title="服务层"></a>服务层</h5><p>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">purchaseRedis</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">dealRedisPurchase</span><span class="params">(List&lt;PurchaseRecordPo&gt; prpList)</span></span>;</span><br></pre></td></tr></table></figure>

<p>定制属于Redis的查找和删除</p>
<p>服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	StringRedisTemplate stringRedisTemplate = <span class="keyword">null</span>;</span><br><span class="line">	String purchaseScript =</span><br><span class="line">			<span class="comment">// 先将产品编号保存到集合中</span></span><br><span class="line">			<span class="string">" redis.call('sadd', KEYS[1], ARGV[2]) \n"</span></span><br><span class="line">			<span class="comment">// 购买列表</span></span><br><span class="line">			+ <span class="string">"local productPurchaseList = KEYS[2]..ARGV[2] \n"</span></span><br><span class="line">			<span class="comment">// 用户编号</span></span><br><span class="line">			+ <span class="string">"local userId = ARGV[1] \n"</span></span><br><span class="line">			<span class="comment">// 产品key</span></span><br><span class="line">			+ <span class="string">"local product = 'product_'..ARGV[2] \n"</span></span><br><span class="line">			<span class="comment">// 购买数量</span></span><br><span class="line">			+ <span class="string">"local quantity = tonumber(ARGV[3]) \n"</span></span><br><span class="line">			<span class="comment">// 当前库存</span></span><br><span class="line">			+ <span class="string">"local stock = tonumber(redis.call('hget', product, 'stock')) \n"</span></span><br><span class="line">			<span class="comment">// 价格</span></span><br><span class="line">			+ <span class="string">"local price = tonumber(redis.call('hget', product, 'price')) \n"</span></span><br><span class="line">			<span class="comment">// 购买时间</span></span><br><span class="line">			+ <span class="string">"local purchase_date = ARGV[4] \n"</span></span><br><span class="line">			<span class="comment">// 库存不足，返回0</span></span><br><span class="line">			+ <span class="string">"if stock &lt; quantity then return 0 end \n"</span></span><br><span class="line">			<span class="comment">// 减库存</span></span><br><span class="line">			+ <span class="string">"stock = stock - quantity \n"</span></span><br><span class="line">			+ <span class="string">"redis.call('hset', product, 'stock', tostring(stock)) \n"</span></span><br><span class="line">			<span class="comment">// 计算价格</span></span><br><span class="line">			+ <span class="string">"local sum = price * quantity \n"</span></span><br><span class="line">			<span class="comment">// 合并购买记录数据</span></span><br><span class="line">			+ <span class="string">"local purchaseRecord = userId..','..quantity..','"</span></span><br><span class="line">			+ <span class="string">"..sum..','..price..','..purchase_date \n"</span></span><br><span class="line">			<span class="comment">// 保存到将购买记录保存到list里</span></span><br><span class="line">			+ <span class="string">"redis.call('rpush', productPurchaseList, purchaseRecord) \n"</span></span><br><span class="line">			<span class="comment">// 返回成功</span></span><br><span class="line">			+ <span class="string">"return 1 \n"</span>;</span><br><span class="line">	<span class="comment">// Redis购买记录集合前缀</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PURCHASE_PRODUCT_LIST = <span class="string">"purchase_list_"</span>;</span><br><span class="line">	<span class="comment">// 抢购商品集合</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PRODUCT_SCHEDULE_SET = <span class="string">"product_schedule_set"</span>;</span><br><span class="line">	<span class="comment">// 32位SHA1编码，第一次执行的时候先让Redis进行缓存脚本返回</span></span><br><span class="line">	<span class="keyword">private</span> String sha1 = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">purchaseRedis</span><span class="params">(Long userId, Long productId, <span class="keyword">int</span> quantity)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 购买时间</span></span><br><span class="line">		Long purchaseDate = System.currentTimeMillis();</span><br><span class="line">		Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// 获取原始连接</span></span><br><span class="line">			jedis = (Jedis) stringRedisTemplate</span><br><span class="line">				.getConnectionFactory().getConnection().getNativeConnection();</span><br><span class="line">			<span class="comment">// 如果没有加载过，则先将脚本加载到Redis服务器，让其返回sha1</span></span><br><span class="line">			<span class="keyword">if</span> (sha1 == <span class="keyword">null</span>) &#123;</span><br><span class="line">				sha1 = jedis.scriptLoad(purchaseScript);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 执行脚本，返回结果</span></span><br><span class="line">			Object res = jedis.evalsha(sha1, <span class="number">2</span>, PRODUCT_SCHEDULE_SET,</span><br><span class="line">				PURCHASE_PRODUCT_LIST, userId + <span class="string">""</span>, productId + <span class="string">""</span>,</span><br><span class="line">				quantity + <span class="string">""</span>, purchaseDate + <span class="string">""</span>);</span><br><span class="line">			Long result = (Long) res;</span><br><span class="line">			<span class="keyword">return</span> result == <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 关闭jedis连接</span></span><br><span class="line">			<span class="keyword">if</span> (jedis != <span class="keyword">null</span> &amp;&amp; jedis.isConnected()) &#123;</span><br><span class="line">				jedis.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个代码中的StringRedisTemplate 是由SpringBoot机制自动生成的。</p>
<p>购买记录中使用了Lua语言，会在第一次执行时，把脚本缓存到Redis服务器中，然后Redis会返回一个 32位的SHA1编码，并缓存到变量sha1中，再通过它将程序需要的键和参数传递到后台去执行Lua脚本。Lua脚本会在减少库存后，将信息缓存起来。</p>
<p>注意这一段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行脚本，返回结果</span></span><br><span class="line">			Object res = jedis.evalsha(sha1, <span class="number">2</span>, PRODUCT_SCHEDULE_SET,</span><br><span class="line">				PURCHASE_PRODUCT_LIST, userId + <span class="string">""</span>, productId + <span class="string">""</span>,</span><br><span class="line">				quantity + <span class="string">""</span>, purchaseDate + <span class="string">""</span>);</span><br></pre></td></tr></table></figure>

<p>局部变量sha1代表一个32位的SHA1编码，用来执行缓存在Redis的脚本中，所以PRODUCT_SCHEDULE_SET和PURCHASE_PRODUCT_LIST都只是键。它们在Lua脚本中以Key[index]表示。而index则是它的索引，以1开始。从第二个参数之后，则都是脚本的参数，在Lua脚本中会以ARGV[index]表示。</p>
<p>最后，保存记录的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="comment">// 当运行方法启用新的独立事务运行</span></span><br><span class="line">	<span class="meta">@Transactional</span>(propagation = Propagation.REQUIRES_NEW)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dealRedisPurchase</span><span class="params">(List&lt;PurchaseRecordPo&gt; prpList)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">for</span> (PurchaseRecordPo prp : prpList) &#123;</span><br><span class="line">	        purchaseRecordDao.insertPurchaseRecord(prp);</span><br><span class="line">	        productDao.decreaseProduct(prp.getProductId(), prp.getQuantity());</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法将会把购买记录保存到数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(propagation &#x3D; Propagation.REQUIRES_NEW)</span><br></pre></td></tr></table></figure>

<p>这个事务传播行为配置为 Propagation.REQUIRES_NEW 这意味这它会将当前事务挂起，开启新的事务，回滚时只会回滚这个方法的内部事务，而不会影响全局事务。</p>
<h5 id="开启定时任务"><a href="#开启定时任务" class="headerlink" title="开启定时任务"></a>开启定时任务</h5><p>启动器上添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span></span><br></pre></td></tr></table></figure>

<h5 id="增加定时任务接口"><a href="#增加定时任务接口" class="headerlink" title="增加定时任务接口"></a>增加定时任务接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TaskService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">purchaseTask</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="定时任务服务"><a href="#定时任务服务" class="headerlink" title="定时任务服务"></a>定时任务服务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskServiceImpl</span> <span class="keyword">implements</span> <span class="title">TaskService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PurchaseService purchaseService = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PRODUCT_SCHEDULE_SET = <span class="string">"product_schedule_set"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PURCHASE_PRODUCT_LIST = <span class="string">"purchase_list_"</span>;</span><br><span class="line">    <span class="comment">// 每次取出1000条，避免一次取出消耗太多内存，导致JVM内存溢出</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ONE_TIME_SIZE = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 每天半夜1点钟开始执行任务</span></span><br><span class="line"><span class="comment">//    @Scheduled(cron = "0 0 1 * * ?")</span></span><br><span class="line">    <span class="comment">// 下面是用于测试的配置，每分钟执行一次任务</span></span><br><span class="line">     <span class="meta">@Scheduled</span>(fixedRate = <span class="number">1000</span> * <span class="number">60</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">purchaseTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"定时任务开始......"</span>);</span><br><span class="line">        Set&lt;String&gt; productIdList</span><br><span class="line">		    = stringRedisTemplate.opsForSet().members(PRODUCT_SCHEDULE_SET);</span><br><span class="line">        List&lt;PurchaseRecordPo&gt; prpList =<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String productIdStr : productIdList) &#123;</span><br><span class="line">            Long productId = Long.parseLong(productIdStr);</span><br><span class="line">            String purchaseKey = PURCHASE_PRODUCT_LIST + productId;</span><br><span class="line">            BoundListOperations&lt;String, String&gt; ops</span><br><span class="line">			        = stringRedisTemplate.boundListOps(purchaseKey);</span><br><span class="line">            <span class="comment">// 计算记录数</span></span><br><span class="line">            <span class="keyword">long</span> size = stringRedisTemplate.opsForList().size(purchaseKey);</span><br><span class="line">            Long times = size % ONE_TIME_SIZE == <span class="number">0</span> ? </span><br><span class="line">			        size / ONE_TIME_SIZE : size / ONE_TIME_SIZE + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times; i++) &#123;</span><br><span class="line">                <span class="comment">// 获取至多TIME_SIZE个抢红包信息</span></span><br><span class="line">                List&lt;String&gt; prList = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                    prList  = ops.range(i * ONE_TIME_SIZE, </span><br><span class="line">					    (i + <span class="number">1</span>) * ONE_TIME_SIZE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    prList = ops.range(i * ONE_TIME_SIZE + <span class="number">1</span>, </span><br><span class="line">					    (i + <span class="number">1</span>) * ONE_TIME_SIZE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (String prStr : prList) &#123;</span><br><span class="line">                    PurchaseRecordPo prp </span><br><span class="line">					    = <span class="keyword">this</span>.createPurchaseRecord(productId, prStr);</span><br><span class="line">                    prpList.add(prp);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 采用该方法采用新建事务的方式，这样不会导致全局事务回滚</span></span><br><span class="line">                    purchaseService.dealRedisPurchase(prpList);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 清除列表为空，等待重新写入数据</span></span><br><span class="line">                prpList.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 删除购买列表</span></span><br><span class="line">            stringRedisTemplate.delete(purchaseKey);</span><br><span class="line">            <span class="comment">// 从商品集合中删除商品</span></span><br><span class="line">            stringRedisTemplate.opsForSet()</span><br><span class="line">			    .remove(PRODUCT_SCHEDULE_SET, productIdStr);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"定时任务结束......"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> PurchaseRecordPo <span class="title">createPurchaseRecord</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	        Long productId, String prStr)</span> </span>&#123;</span><br><span class="line">        String[] arr = prStr.split(<span class="string">","</span>);</span><br><span class="line">        Long userId = Long.parseLong(arr[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> quantity = Integer.parseInt(arr[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span> sum = Double.valueOf(arr[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">double</span> price = Double.valueOf(arr[<span class="number">3</span>]);</span><br><span class="line">        Long time = Long.parseLong(arr[<span class="number">4</span>]);</span><br><span class="line">        Timestamp purchaseTime = <span class="keyword">new</span> Timestamp(time);</span><br><span class="line">        PurchaseRecordPo pr = <span class="keyword">new</span> PurchaseRecordPo();</span><br><span class="line">        pr.setProductId(productId);</span><br><span class="line">        pr.setPurchaseTime(purchaseTime);</span><br><span class="line">        pr.setPrice(price);</span><br><span class="line">        pr.setQuantity(quantity);</span><br><span class="line">        pr.setSum(sum);</span><br><span class="line">        pr.setUserId(userId);</span><br><span class="line">        pr.setNote(<span class="string">"购买日志，时间："</span> + purchaseTime.getTime());</span><br><span class="line">        <span class="keyword">return</span> pr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用@Scheduled定义时间：上一篇文章有写具体该怎么写。</p>
<p>它会从产品列表中读取产品编号，然后根据产品编号找到购买列表。在读出数据后，会转换为POJO对象，通过PurchaseService的createPurchaseRecord方法进行保存。</p>
<h5 id="修改控制层"><a href="#修改控制层" class="headerlink" title="修改控制层"></a>修改控制层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/purchase"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">purchase</span><span class="params">(Long userId, Long productId, Integer quantity)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> success = purchaseService.purchaseRedis(userId, productId, quantity);</span><br><span class="line">	String message = success ? <span class="string">"抢购成功"</span> : <span class="string">"抢购失败"</span>;</span><br><span class="line">	Result result = <span class="keyword">new</span> Result(success, message);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后注意记得删除mapper中的version判定。</p>
<h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><p>在Redis输入：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/15.png" alt=""></p>
<p>打开 <a href="http://localhost:8888/test" target="_blank" rel="noopener">http://localhost:8888/test</a> 测试：</p>
<p>查看Redis:</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/16.png" alt=""></p>
<p>发现多了这些键，这正是我们在业务层定义的键，查看键里包含的值：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/17.png" alt=""></p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/19.png" alt=""></p>
<p>发现Redis存储了这次数据库执行的结果，但是还没有写入数据库。在实际应用中，我们可以让Redis在一个夜深人静的夜晚，再缓慢的写回数据库。时间使用@Scheduled定义。</p>
<p>等时间到了，IDEA会出现这段文字：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/18.png" alt=""></p>
<p>再去查看数据库，发现成功写回了：</p>
<p><img src="https://gitee.com/antarctica/img_sotre/raw/img/img/designshop/13.png" alt=""></p>
<p>项目地址：<a href="https://github.com/Antarctica000/SpringBoot/tree/master/designshop">https://github.com/Antarctica000/SpringBoot/tree/master/designshop</a></p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a><a class="post-meta__tags" href="/tags/MyBtis/">MyBtis</a><a class="post-meta__tags" href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">定时任务</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/01/21/spring6/"><i class="fa fa-chevron-left">  </i><span>SpringBoot整合Thymeleaf</span></a></div><div class="next-post pull-right"><a href="/2020/01/19/spring4/"><span>SpringBoot整合RabbitMQ</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2024 By 攀</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>