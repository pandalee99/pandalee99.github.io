<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="实践经验"><meta name="keywords" content="实习"><meta name="author" content="攀"><meta name="copyright" content="攀"><title>实践经验 | 小世界</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="小世界" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rpc"><span class="toc-number">1.</span> <span class="toc-text">rpc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#orm"><span class="toc-number">2.</span> <span class="toc-text">orm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#debug"><span class="toc-number">3.</span> <span class="toc-text">debug</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/pandalee99/image_store/master/hexo/c17f0489-42cd-439a-94bd-0612598b142f.jpg"></div><div class="author-info__name text-center">攀</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Pandalee99">GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">93</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">66</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">链接</div><a class="author-info-links__name text-center" href="https://github.com/Pandalee99/Concurrent-programming">GItHub配套资源</a><a class="author-info-links__name text-center" href="https://translate.google.cn/" target="_blank" rel="noopener">Google翻译</a><a class="author-info-links__name text-center" href="https://www.bilibili.com/" target="_blank" rel="noopener">bilibili</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">小世界</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">实践经验</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-12-20</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>今天开始对实习过程中的工程进行简单的总结，不涉及业务。</p>
<p>这里使用的py去实现一个后端架构，但是这里使用的后台框架并非是类似于Django或者是flask等框架。而是单纯使用原生的方式去实现，用法其实和C++写后台没有本质的区别，仅仅是因为编程语言不同。</p>
<p>这里的后端，其实也大绝大多数的后端架构类似，都是采用B/S三层架构，有专门的Controller层去接受请求，也有专门的ORM层去DB访问数据。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/34531809/1703151599325-7ee23777-53cb-4f72-9931-2417cdabd6ab.png" alt="img"></p>
<p>这样的系统还是比较类似的，但是也有着很大的不同。</p>
<h2 id="rpc"><a href="#rpc" class="headerlink" title="rpc"></a>rpc</h2><p>比如说，这里的Controller层接受的不在是http请求，而是rpc请求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@service.reg(name='ExactReCall')</span></span><br><span class="line"><span class="meta">@rpc_log</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">ExactReCallUpdateEvaluateTask</span><span class="params">(ctx, req: mm_pb2.ExactReCallReq,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        resp: mm_pb2.ExactReCallResp)</span>:</span></span><br></pre></td></tr></table></figure>

<p>这里的rpc协议请求使用的都是proto文件去定义的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add.py -s=combo -f=ModifyBizTemplateSave --build</span><br></pre></td></tr></table></figure>

<p>通过命令去rebuild proto，s是模块，f是方法，这样会生成相应的proto映射文件</p>
<p>看到这里大家可能会感到疑惑，这个接口全都是rpc调用，难道前端会发起rpc请求吗？那当然不会，前端发起的显然都是http请求，不过中间有一层网关，会将所有的http请求都转为rpc请求，这一层的主要目的与单体服务无关，之所以要这么做最大的目的是为<strong>让所有的服务都能够互通</strong>。</p>
<p>这里可能和传统的Spring全家桶的微服务不一样，在以往的微服务架构之间，所有的前端发起，后端接收的请求都是http，而服务与服务之间发送的请求基本都是RPC，这可能是一种规范，为了提升效率的规范。但是我目前工作中使用的架构全都是基于Service Mesh的，也就是说，在所有的服务下面都有一层Mesh层，服务与服务之间不能够直接通信，就算是显示的发送RPC请求，服务的链路都是先传入底下的mesh层，再由mesh层传到目标服务的。</p>
<p>这种解决方案目的其实也是为了解开耦合，从而提供<strong>高内聚</strong>的能力，基本每个服务根本不用去在意自己的rpc，自己的基础设施，应该是什么样的版本，什么样的协议与组件。可以说，因为有了mesh层，可以极大的杜绝了重复造轮子导致的资源浪费。</p>
<h2 id="orm"><a href="#orm" class="headerlink" title="orm"></a>orm</h2><p>使用session = get_session()，可以根据需要去获取当前的session。目的是为了获取一个数据库会话对象。这里做了层层的封装，比如说当前的orm是否需要事务等等，都会进行一定程度的判定，最后才会返回一个最终的实例，我们就是通过操作这个实例，去进行保存和更新的。</p>
<p><strong>这里的做法不像是Spring全家桶的风格，不过倒是和Go后端非常相似</strong></p>
<p>可以参考：<a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017803857459008" target="_blank" rel="noopener">使用SQLAlchemy - 廖雪峰的官方网站</a></p>
<p>通过session.query去获取表后，根据使用需求进行操作，比如</p>
<p>session.query(表名).filter(</p>
<p>​    表名.属性 == aaa.bbb, 表名.属性 == aaa.bbb</p>
<p>).first()</p>
<p>这样就可以获取到相应的数据了，这种写法非常简单，基本没有什么特别难的点</p>
<p>我们还可以进入MySQL，show create table，  SHOW INDEX FROM 数据表；查看表信息，这些都是基本的操作了</p>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p>梳理一下逻辑，现在主要学习如何去排查问题，这里使用原生的调试器，去排查问题。</p>
<p>Pdb是Python自带的调试器，它可以帮助你在程序运行时暂停程序的执行，查看变量的值，执行代码行，以及跟踪程序的执行流程。使用Pdb可以帮助你快速定位代码中的错误，并且可以提高代码的可读性和可维护性。</p>
<p>使用Pdb非常简单，只需要在代码中插入一行 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb; </span><br><span class="line">pdb.set_trace()</span><br><span class="line"><span class="comment">#例如：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_path</span><span class="params">(proto_path)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> proto_path:</span><br><span class="line">        pdb.set_trace()</span><br></pre></td></tr></table></figure>



<p>当程序执行到这一行时，程序会暂停执行并进入Pdb调试模式。在Pdb模式下，你可以使用一系列命令来查看变量的值，执行代码行，以及跟踪程序的执行流程。</p>
<p>例如：</p>
<p>可以使用p命令来查看变量的值</p>
<p>使用n命令来执行下一行代码</p>
<p>使用c命令来继续执行程序。</p>
<p>使用h命令是查看有哪些命令</p>
<p>可以使用args查看具体是什么问题</p>
<p>使用u和d分别对应上游和下游</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%9E%E4%B9%A0/">实习</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2024/01/05/zero-copy/"><i class="fa fa-chevron-left">  </i><span>零拷贝技术说明书</span></a></div><div class="next-post pull-right"><a href="/2023/11/02/compensate/"><span>补偿框架</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2024 By 攀</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>