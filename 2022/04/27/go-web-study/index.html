<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="用Go语言编写一个web与分布式应用"><meta name="keywords" content="Golang"><meta name="author" content="攀"><meta name="copyright" content="攀"><title>用Go语言编写一个web与分布式应用 | 小世界</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="小世界" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用Go语言编写一个web与分布式应用"><span class="toc-number">1.</span> <span class="toc-text">使用Go语言编写一个web与分布式应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初始知识"><span class="toc-number">1.1.</span> <span class="toc-text">初始知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go语言的学习"><span class="toc-number">1.1.1.</span> <span class="toc-text">go语言的学习</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工具"><span class="toc-number">1.1.2.</span> <span class="toc-text">工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第一个demo"><span class="toc-number">1.1.3.</span> <span class="toc-text">第一个demo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正式编写"><span class="toc-number">1.2.</span> <span class="toc-text">正式编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#处理请求"><span class="toc-number">1.2.1.</span> <span class="toc-text">处理请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultServeMux"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">DefaultServeMux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HandleFunc"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">HandleFunc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内置Handler"><span class="toc-number">1.2.2.</span> <span class="toc-text">内置Handler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码演示：FileServer"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">代码演示：FileServer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求类型"><span class="toc-number">1.2.3.</span> <span class="toc-text">请求类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#URL类型"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">URL类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#URL-Query"><span class="toc-number">1.2.3.1.1.</span> <span class="toc-text">URL Query</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#URL-Fragment"><span class="toc-number">1.2.3.1.2.</span> <span class="toc-text">URL Fragment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Request-Header"><span class="toc-number">1.2.3.1.3.</span> <span class="toc-text">Request Header</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Request-Body"><span class="toc-number">1.2.3.1.4.</span> <span class="toc-text">Request Body</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#代码演示-Fragment"><span class="toc-number">1.2.3.1.5.</span> <span class="toc-text">代码演示:Fragment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#代码演示-Header"><span class="toc-number">1.2.3.1.6.</span> <span class="toc-text">代码演示:Header</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#代码演示-Header-1"><span class="toc-number">1.2.3.1.7.</span> <span class="toc-text">代码演示:Header</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#URL-Query-1"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">URL Query</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#例子"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Forms"><span class="toc-number">1.2.4.</span> <span class="toc-text">Forms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#enctype"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">enctype</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Form字段"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">Form字段</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#FormValue-和-PostFormValue-方法"><span class="toc-number">1.2.4.2.1.</span> <span class="toc-text">FormValue 和 PostFormValue 方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上传文件"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#FormFile"><span class="toc-number">1.2.4.3.1.</span> <span class="toc-text">FormFile()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MultipartReader"><span class="toc-number">1.2.4.3.2.</span> <span class="toc-text">MultipartReader()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#响应"><span class="toc-number">1.2.5.</span> <span class="toc-text">响应</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ResponseWriter"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">ResponseWriter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WriteHeader-方法"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">WriteHeader 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Header-方法"><span class="toc-number">1.2.5.3.</span> <span class="toc-text">Header 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#内置的-Response"><span class="toc-number">1.2.5.4.</span> <span class="toc-text">内置的 Response</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板"><span class="toc-number">1.2.6.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Go-的模板和模板引擎"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">Go 的模板和模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#工作原理"><span class="toc-number">1.2.6.1.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模板的例子"><span class="toc-number">1.2.6.1.2.</span> <span class="toc-text">模板的例子</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#使用模板引擎"><span class="toc-number">1.2.6.1.3.</span> <span class="toc-text">使用模板引擎</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析模板"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">解析模板</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ParseFiles"><span class="toc-number">1.2.6.2.1.</span> <span class="toc-text">ParseFiles</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ParseGlob"><span class="toc-number">1.2.6.2.2.</span> <span class="toc-text">ParseGlob</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Parse"><span class="toc-number">1.2.6.2.3.</span> <span class="toc-text">Parse</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lookup-方法"><span class="toc-number">1.2.6.2.4.</span> <span class="toc-text">Lookup 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Must-函数"><span class="toc-number">1.2.6.2.5.</span> <span class="toc-text">Must 函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模板的Action"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">模板的Action</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#条件Action"><span class="toc-number">1.2.6.3.1.</span> <span class="toc-text">条件Action</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#迭代-遍历-Action"><span class="toc-number">1.2.6.3.2.</span> <span class="toc-text">迭代&#x2F;遍历 Action</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#设置Action"><span class="toc-number">1.2.6.3.3.</span> <span class="toc-text">设置Action</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#包含-Action"><span class="toc-number">1.2.6.3.4.</span> <span class="toc-text">包含 Action</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数与管道"><span class="toc-number">1.2.6.4.</span> <span class="toc-text">函数与管道</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#参数（argument）"><span class="toc-number">1.2.6.4.1.</span> <span class="toc-text">参数（argument）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#在-Action-中设置变量"><span class="toc-number">1.2.6.4.2.</span> <span class="toc-text">在 Action 中设置变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#管道（pipeline）"><span class="toc-number">1.2.6.4.3.</span> <span class="toc-text">管道（pipeline）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#函数"><span class="toc-number">1.2.6.4.4.</span> <span class="toc-text">函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#内置函数"><span class="toc-number">1.2.6.4.5.</span> <span class="toc-text">内置函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义函数"><span class="toc-number">1.2.6.4.6.</span> <span class="toc-text">自定义函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模板组合"><span class="toc-number">1.2.6.5.</span> <span class="toc-text">模板组合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Layout-模板"><span class="toc-number">1.2.6.5.1.</span> <span class="toc-text">Layout 模板</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#使用-block-action-定义默认模板"><span class="toc-number">1.2.6.5.2.</span> <span class="toc-text">使用 block action 定义默认模板</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#逻辑运算符"><span class="toc-number">1.2.6.5.3.</span> <span class="toc-text">逻辑运算符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库"><span class="toc-number">1.2.7.</span> <span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#https-www-jianshu-com-p-7e745fefb8af"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;7e745fefb8af</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由"><span class="toc-number">1.2.8.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Controller"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#路由的参数"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">路由的参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON"><span class="toc-number">1.2.9.</span> <span class="toc-text">JSON</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#类型映射"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">类型映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对于未知结构的-JSON"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">对于未知结构的 JSON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读取-JSON"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">读取 JSON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#写入-JSON"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">写入 JSON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例子-1"><span class="toc-number">1.2.9.5.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编码的类型：Marshal-和-Unmarshal"><span class="toc-number">1.2.9.6.</span> <span class="toc-text">编码的类型：Marshal 和 Unmarshal</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中间件"><span class="toc-number">1.2.10.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建中间件"><span class="toc-number">1.2.10.1.</span> <span class="toc-text">创建中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#中间件的用途"><span class="toc-number">1.2.10.2.</span> <span class="toc-text">中间件的用途</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例子-2"><span class="toc-number">1.2.10.3.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求上下文"><span class="toc-number">1.2.11.</span> <span class="toc-text">请求上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Request-Context"><span class="toc-number">1.2.11.1.</span> <span class="toc-text">Request Context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#context-Context"><span class="toc-number">1.2.11.2.</span> <span class="toc-text">context.Context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Context-API"><span class="toc-number">1.2.11.3.</span> <span class="toc-text">Context API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一个超时的例子"><span class="toc-number">1.2.11.4.</span> <span class="toc-text">一个超时的例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPS"><span class="toc-number">1.2.12.</span> <span class="toc-text">HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-Listener"><span class="toc-number">1.2.12.1.</span> <span class="toc-text">HTTP Listener</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP的协议"><span class="toc-number">1.2.13.</span> <span class="toc-text">HTTP的协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-1-1"><span class="toc-number">1.2.13.1.</span> <span class="toc-text">HTTP&#x2F;1.1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-2-0"><span class="toc-number">1.2.13.2.</span> <span class="toc-text">HTTP&#x2F;2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#特点"><span class="toc-number">1.2.13.2.1.</span> <span class="toc-text">特点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Server-Push"><span class="toc-number">1.2.13.3.</span> <span class="toc-text">Server Push</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#例子-3"><span class="toc-number">1.2.13.3.1.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.2.14.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-Model-层"><span class="toc-number">1.2.14.1.</span> <span class="toc-text">测试 Model 层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-Controller-层"><span class="toc-number">1.2.14.2.</span> <span class="toc-text">测试 Controller 层</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#NewRequest-函数"><span class="toc-number">1.2.14.2.1.</span> <span class="toc-text">NewRequest 函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ResponseRecorder"><span class="toc-number">1.2.14.2.2.</span> <span class="toc-text">ResponseRecorder</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#例子-4"><span class="toc-number">1.2.14.2.3.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Profiling-性能分析"><span class="toc-number">1.2.15.</span> <span class="toc-text">Profiling 性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析的对象"><span class="toc-number">1.2.15.1.</span> <span class="toc-text">分析的对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如何分析"><span class="toc-number">1.2.15.2.</span> <span class="toc-text">如何分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用Go语言编写一个简易的分布式系统"><span class="toc-number">2.</span> <span class="toc-text">使用Go语言编写一个简易的分布式系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#想法"><span class="toc-number">2.1.</span> <span class="toc-text">想法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一-概念"><span class="toc-number">2.1.1.</span> <span class="toc-text">一.概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二-区别"><span class="toc-number">2.1.2.</span> <span class="toc-text">二.区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三-应用场景"><span class="toc-number">2.1.3.</span> <span class="toc-text">三.应用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四-总结"><span class="toc-number">2.1.4.</span> <span class="toc-text">四.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务注册"><span class="toc-number">2.2.</span> <span class="toc-text">服务注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建自定义的日志服务"><span class="toc-number">2.2.1.</span> <span class="toc-text">创建自定义的日志服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现基本逻辑"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">实现基本逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-1"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务注册的基本逻辑"><span class="toc-number">2.2.2.</span> <span class="toc-text">服务注册的基本逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注册中心"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#独立服务"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">独立服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-2"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#注册服务"><span class="toc-number">2.2.3.</span> <span class="toc-text">注册服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#微服务思想"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">微服务思想</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-3"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#取消注册"><span class="toc-number">2.2.4.</span> <span class="toc-text">取消注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改注册中心"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">修改注册中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改客户端"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">修改客户端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改服务的注册功能"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">修改服务的注册功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试："><span class="toc-number">2.2.4.4.</span> <span class="toc-text">测试：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务发现"><span class="toc-number">2.3.</span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#业务服务"><span class="toc-number">2.3.1.</span> <span class="toc-text">业务服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本的数据结构与方法"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">基本的数据结构与方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务的逻辑"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">服务的逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务启动器"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">服务启动器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务发现-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">服务发现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#去引用日志服务"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">去引用日志服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务的提供者"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">服务的提供者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端的client"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">客户端的client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使main函数具有服务发现的功能"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">使main函数具有服务发现的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#grading-service"><span class="toc-number">2.3.2.4.1.</span> <span class="toc-text">grading service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#log-service"><span class="toc-number">2.3.2.4.2.</span> <span class="toc-text">log service</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试-4"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖变化"><span class="toc-number">2.3.3.</span> <span class="toc-text">依赖变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重新发现服务"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">重新发现服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试1"><span class="toc-number">2.3.3.2.</span> <span class="toc-text">测试1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务下线告知"><span class="toc-number">2.3.3.3.</span> <span class="toc-text">服务下线告知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试2"><span class="toc-number">2.3.3.4.</span> <span class="toc-text">测试2</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://raw.githubusercontent.com/pandalee99/image_store/master/hexo/c17f0489-42cd-439a-94bd-0612598b142f.jpg"></div><div class="author-info__name text-center">攀</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Pandalee99">GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">84</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">58</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">链接</div><a class="author-info-links__name text-center" href="https://github.com/Pandalee99/Concurrent-programming">GItHub配套资源</a><a class="author-info-links__name text-center" href="https://translate.google.cn/" target="_blank" rel="noopener">Google翻译</a><a class="author-info-links__name text-center" href="https://www.bilibili.com/" target="_blank" rel="noopener">bilibili</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">小世界</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">用Go语言编写一个web与分布式应用</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-27</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="使用Go语言编写一个web与分布式应用"><a href="#使用Go语言编写一个web与分布式应用" class="headerlink" title="使用Go语言编写一个web与分布式应用"></a>使用Go语言编写一个web与分布式应用</h1><h2 id="初始知识"><a href="#初始知识" class="headerlink" title="初始知识"></a>初始知识</h2><h3 id="go语言的学习"><a href="#go语言的学习" class="headerlink" title="go语言的学习"></a>go语言的学习</h3><p>其实很简单，就不详细写了。</p>
<p>可以去类似于去菜鸟教程这个网站，去初步的了解编程语言的写法。</p>
<p>或者是类似于哔哔哔哩这样的视频网站，直接照这视频一步一步的去学习它的写法，不过这种方法比较消耗时间。但是我觉得如果你有一定的编程基础，学这个go真的很简单，没有什么复杂地方。你仅需要注意的是，语法有些不同，你可能要花一段时间去适应它的写法。</p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>虽然网上很多教程都是使用VScode去写的，但是我觉得不是很好，可能自己对于这种轻量级的工具不是很适应。</p>
<p>我使用的是IntelliJ IDEA ，然后安装了go的插件之后去写的，我觉得这样写起来比较轻松，这个要看个人了。</p>
<h3 id="第一个demo"><a href="#第一个demo" class="headerlink" title="第一个demo"></a>第一个demo</h3><p>这个编程语言去做一个web服务的话，有点像cpp一样复古的写法，但是相比于cpp这样语言来肯定要简单得多。不过，如果你有一定的基础的话，会比较轻松吧。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//初始化一个函数，让其能对web应用进行响应</span></span><br><span class="line">	<span class="comment">//第一个参数是路由地址，第二个参数是函数主要功能是收到请求并响应</span></span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		w.Write([]<span class="keyword">byte</span>(<span class="string">"hello world"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置服务器，第一个参数是网络地址，第二个参数是处理方式</span></span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8888"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动后就可以看到结果了。</p>
<h2 id="正式编写"><a href="#正式编写" class="headerlink" title="正式编写"></a>正式编写</h2><h3 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h3><h4 id="DefaultServeMux"><a href="#DefaultServeMux" class="headerlink" title="DefaultServeMux"></a>DefaultServeMux</h4><p>首先要编写一个go程序，就如上面的例子一样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//http.ResponseWriter用于表达响应的</span></span><br><span class="line"><span class="comment">// *http.Request 收到的请求，可以是get或post等等</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *myHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello, my lover"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//自制一个Handler</span></span><br><span class="line">	mh := myHandler&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等同于 http.ListenAndServe</span></span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: &amp;mh, <span class="comment">//Handler实际上是一个接口</span></span><br><span class="line">		<span class="comment">//http.DefaultServeMux也是一个Handler，使用nil是默认使用</span></span><br><span class="line">	&#125;</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种情况下，所有的网址都会输出同样的信息，因为每个请求都是使用同一个Handler。而我们应该使用：DefaultServeMux 去进行处理不同的Handler，而我们就需要对每个Handler进行注册，这样才能进行出结果。</p>
<p>所以我们应该这么改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> helloHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//http.ResponseWriter用于表达响应的</span></span><br><span class="line"><span class="comment">// *http.Request 收到的请求，可以是get或post等等</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *helloHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello, my lover"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> aboutHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *aboutHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"About, my message"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//自制一个Handler</span></span><br><span class="line">	mh := helloHandler&#123;&#125;</span><br><span class="line">	a := aboutHandler&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等同于 http.ListenAndServe</span></span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>, <span class="comment">//这样会默认使用DefaultServeMux</span></span><br><span class="line">		<span class="comment">//http.DefaultServeMux也是一个Handler，使用nil是默认使用</span></span><br><span class="line">	&#125;</span><br><span class="line">	http.Handle(<span class="string">"/hello"</span>, &amp;mh) <span class="comment">//相信到这里，就很简单了，直接望文生义即可</span></span><br><span class="line">	http.Handle(<span class="string">"/about"</span>, &amp;a)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就相当于我们把我们需要自定义的Handler，根据自己的需要去更改，最后注册到DefaultServeMux当中，完成对不同请求产生不同的响应。</p>
<h4 id="HandleFunc"><a href="#HandleFunc" class="headerlink" title="HandleFunc"></a>HandleFunc</h4><p>但前面的处理完全可以简写为一个方式，增加可读性，于是乎，我们就要用到这个函数HandleFunc：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> helloHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//http.ResponseWriter用于表达响应的</span></span><br><span class="line"><span class="comment">// *http.Request 收到的请求，可以是get或post等等</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *helloHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"hello, my lover"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> aboutHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *aboutHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"About, my message"</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">welcome</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	writer.Write([]<span class="keyword">byte</span>(<span class="string">"welcome,my friends"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//自制一个Handler</span></span><br><span class="line">	mh := helloHandler&#123;&#125;</span><br><span class="line">	a := aboutHandler&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等同于 http.ListenAndServe</span></span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>, <span class="comment">//这样会默认使用DefaultServeMux</span></span><br><span class="line">		<span class="comment">//http.DefaultServeMux也是一个Handler，使用nil是默认使用</span></span><br><span class="line">	&#125;</span><br><span class="line">	http.Handle(<span class="string">"/hello"</span>, &amp;mh) <span class="comment">//相信到这里，就很简单了，直接望文生义即可</span></span><br><span class="line">	http.Handle(<span class="string">"/about"</span>, &amp;a)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//使用HandleFunc</span></span><br><span class="line">	http.HandleFunc(<span class="string">"/home"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		writer.Write([]<span class="keyword">byte</span>(<span class="string">"back home,my son"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.HandleFunc(<span class="string">"/welcome"</span>, welcome)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而这个HandleFunc本质上还是调用Handler</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HandleFunc</span><span class="params">(pattern <span class="keyword">string</span>, handler <span class="keyword">func</span>(ResponseWriter, *Request)</span>)</span> &#123;</span><br><span class="line">	DefaultServeMux.HandleFunc(pattern, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们把上述代码中的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/welcome"</span>, welcome)	</span><br><span class="line"><span class="comment">//改成</span></span><br><span class="line">http.HandleFunc(<span class="string">"/welcome"</span>, http.HandlerFunc(welcome))</span><br></pre></td></tr></table></figure>

<p>其结果也是一样的。因为这其实是接口型函数，表示函数的类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(ResponseWriter, *Request)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ServeHTTP calls f(w, r).</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(w ResponseWriter, r *Request)</span></span> &#123;</span><br><span class="line">	f(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是go语言精妙的地方了。你可以面对多种不一样的处理方式，但是只用放在同一个接口当中，这就是go语言使用组成而不是继承的原因。</p>
<p>总结，如何注册DefaultServeHTTP</p>
<p>方法一、使用http.Handle（第二个参数是Handler）</p>
<p>方法二、使用http.HandleFunc（第二个参数是Handler函数）</p>
<p>方法三、http.HandlerFunc可以进行类型转换，将Handler函数转化成Handler（结构体）来使用</p>
<h3 id="内置Handler"><a href="#内置Handler" class="headerlink" title="内置Handler"></a>内置Handler</h3><ul>
<li>func NotFoundHandler() Handler<br>返回一个 handler，它给每个请求的响应都是“404 page not found”</li>
<li>func RedirectHandler(url string, code int) Handler<br>返回一个 handler，它把每个请求使用给定的状态码跳转到指定的 URL。<br>url，要跳转到的 URL<br>code，跳转的状态码（3xx），常见的：StatusMovedPermanently、StatusFound 或 StatusSeeOther 等</li>
<li>func StripPrefix(prefix string, h handler) Handler<br>返回一个 handler，它从请求 URL 中去掉指定的前缀，然后再调用另一个 handler。<br>如果请求的 URL 与提供的前缀不符，那么 404<br>略像中间件<br>prefix，URL 将要被移除的字符串前缀<br>h，是一个 handler，在移除字符串前缀之后，这个 handler 将会接收到请求<br>修饰了另一个 Handler </li>
<li>func TimeoutHandler(h Handler, dt time.Duration, msg string) Handler<br>返回一个 handler，它用来在指定时间内运行传入的 h。<br>也相当于是一个修饰器<br>h，将要被修饰的 handler<br>dt，第一个 handler 允许的处理时间<br>msg，如果超时，那么就把 msg 返回给请求，表示响应时间过长</li>
<li>func FileServer(root FileSystem) Handler<br>返回一个 handler，使用基于 root 的文件系统来响应请求<br>type FileSystem interface {<pre><code>Open(name string) (File, error)</code></pre>  }<br>使用时需要用到操作系统的文件系统，所以还需要委托给：<br>type Dir string<br>func (d Dir) Open(name string) (File, error)</li>
</ul>
<h4 id="代码演示：FileServer"><a href="#代码演示：FileServer" class="headerlink" title="代码演示：FileServer"></a>代码演示：FileServer</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe(<span class="string">":8888"</span>, http.FileServer(http.Dir(<span class="string">"root"</span>)))</span><br></pre></td></tr></table></figure>

<p>可以通过这个方法指定root这个根路径，这样打开文件的时候直接去root，直接找到需要的url路径，加载文件</p>
<h3 id="请求类型"><a href="#请求类型" class="headerlink" title="请求类型"></a>请求类型</h3><p> 最基本的肯定是：</p>
<ul>
<li><p>HTTP Request 和 HTTP Response（请求和响应）</p>
</li>
<li><p>它们具有相同的结构：</p>
<ul>
<li><p>​    请求（响应）行</p>
</li>
<li><p>​    0 个或多个 Header</p>
</li>
<li><p>​    空行</p>
</li>
<li><p>​    可选的消息体（Body）</p>
</li>
</ul>
</li>
</ul>
<p>而 <strong>net/http</strong> 包提供了用于表示 HTTP 消息的结构，其中Reqeust（是个 struct），代表了客户端发送的 HTTP 请求消息</p>
<h4 id="URL类型"><a href="#URL类型" class="headerlink" title="URL类型"></a>URL类型</h4><h5 id="URL-Query"><a href="#URL-Query" class="headerlink" title="URL Query"></a>URL Query</h5><p>RawQuery 会提供实际查询的字符串。</p>
<p>例如： <a href="http://www.example.com/post?id=123&amp;thread_id=456" target="_blank" rel="noopener">http://www.example.com/post?id=123&amp;thread_id=456</a></p>
<p>它的 RawQuery 的值就是 id=123&amp;thread_id=456</p>
<p>还有一个简便方法可以得到 Key-Value 对：通过 Request 的 Form 字段（以后再说）</p>
<h5 id="URL-Fragment"><a href="#URL-Fragment" class="headerlink" title="URL Fragment"></a>URL Fragment</h5><p>如果从浏览器发出的请求，那么你无法提取出 Fragment 字段的值</p>
<p>浏览器在发送请求时会把 fragment 部分去掉</p>
<p>但不是所有的请求都是从浏览器发出的（例如从 HTTP 客户端包）。</p>
<h5 id="Request-Header"><a href="#Request-Header" class="headerlink" title="Request Header"></a>Request Header</h5><p>请求和响应（Request、Response）的 headers 是通过 Header 类型来描述的，它是一个 map，用来表述 HTTP Header 里的 Key-Value 对。</p>
<p>Header map 的 key 是 string 类型，value 是 []string</p>
<p>设置 key 的时候会创建一个空的 []string 作为 value，value 里面第一个元素就是新 header 的值；</p>
<p>为指定的 key 添加一个新的 header 值，执行 append 操作即可</p>
<h5 id="Request-Body"><a href="#Request-Body" class="headerlink" title="Request Body"></a>Request Body</h5><p>请求和响应的 bodies 都是使用 Body 字段来表示的</p>
<p>Body 是一个 io.ReadCloser 接口</p>
<p>一个 Reader 接口</p>
<p>一个 Closer 接口</p>
<p>Reader 接口定义了一个 Open 方法：</p>
<p>参数：[]byte</p>
<p>返回：byte 的数量、可选的错误</p>
<p>Closer 接口定义了一个 Close 方法：</p>
<p>没有参数，返回可选的错误</p>
<h5 id="代码演示-Fragment"><a href="#代码演示-Fragment" class="headerlink" title="代码演示:Fragment"></a>代码演示:Fragment</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8888"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/url"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(writer, request.URL.Fragment)</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以通过这种方式，看看自己请求有没有Fragment</p>
<h5 id="代码演示-Header"><a href="#代码演示-Header" class="headerlink" title="代码演示:Header"></a>代码演示:Header</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8888"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/header"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		fmt.Fprintln(writer, request.Header)</span><br><span class="line">		fmt.Fprintln(writer, request.Header[<span class="string">"Accept-Encoding"</span>])</span><br><span class="line">		fmt.Fprintln(writer, request.Header.Get(<span class="string">"Accept-Encoding"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用Postman测试：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://localhost:8888/header</span></span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map[Accept:[*&#x2F;*] Accept-Encoding:[gzip, deflate, br] Connection:[keep-alive] Postman-Token:[9ddda678-d6f8-42d2-aea5-67816a86c3d7] User-Agent:[PostmanRuntime&#x2F;7.28.3]]</span><br><span class="line">[gzip, deflate, br]</span><br><span class="line">gzip, deflate, br</span><br></pre></td></tr></table></figure>

<h5 id="代码演示-Header-1"><a href="#代码演示-Header-1" class="headerlink" title="代码演示:Header"></a>代码演示:Header</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:8888"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/post"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		length := request.ContentLength</span><br><span class="line">		body := <span class="built_in">make</span>([]<span class="keyword">byte</span>, length)</span><br><span class="line">		request.Body.Read(body)</span><br><span class="line">		fmt.Fprintln(writer, <span class="keyword">string</span>(body))</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用这个方式去展现出body的内容</p>
<h4 id="URL-Query-1"><a href="#URL-Query-1" class="headerlink" title="URL Query"></a>URL Query</h4><p>例如：<a href="http://www.example.com/post?id=123&amp;thread_id=456" target="_blank" rel="noopener">http://www.example.com/post?id=123&amp;thread_id=456</a></p>
<p>r.URL.RawQuery 会提供实际查询的原始字符串，因为 RawQuery 的值就是 id=123&amp;thread_id=456</p>
<p>r.URL.Query()，会提供查询字符串对应的 map string string</p>
<h5 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/home"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		url := request.URL</span><br><span class="line">		query := url.Query() <span class="comment">//得到一个map</span></span><br><span class="line"></span><br><span class="line">		id := query[<span class="string">"id"</span>]</span><br><span class="line">		log.Println(id)</span><br><span class="line"></span><br><span class="line">		name := query.Get(<span class="string">"name"</span>)</span><br><span class="line">		log.Println(name)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8888"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8888/home?id=123&amp;name=panda&amp;id=456&amp;name=fox</span><br></pre></td></tr></table></figure>

<p>控制台显示结果为：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[123 456]</span><br><span class="line">panda</span><br></pre></td></tr></table></figure>

<p>这表明 query[“id”] 是获取所有的值，而query.Get(“name”) 只会获取第一个值</p>
<h3 id="Forms"><a href="#Forms" class="headerlink" title="Forms"></a>Forms</h3><h4 id="enctype"><a href="#enctype" class="headerlink" title="enctype"></a>enctype</h4><p>接下来看看，如何处理表单类的数据。</p>
<p>HTML 表单里面的数据会以 name-value 对的形式，通过 POST 请求发送出去，它的数据内容会放在 POST 请求的 Body 里面。</p>
<p>通过 POST 发送的 name-value 数据对的格式可以通过表单的 Content Type 来指定，也就是 enctype 属性。</p>
<p>默认值是：application/x-www-form-urlencoded<br>浏览器被要求至少要支持： application/x-www-form-urlencoded 、multipart/form-data。HTML 5 的话，还需要支持 text/plain</p>
<p>如果 enctype 是 application/x-www-form-urlencoded，那么浏览器会将表单数据编码到查询字符串里面。例如：    first_name=sau%20sheong&amp;last_name=chang</p>
<p>如果 enctype 是 multipart/form-data，那么：每一个 name-value 对都会被转换为一个MIME消息部分，每一个部分都有自己的 Content Type 和 Content Disposition</p>
<p>那么，改如何选择enctype呢？</p>
<ol>
<li>简单文本：表单 URL 编码</li>
<li>大量数据，例如上传文件：multipart-MIME，甚至可以把二进制数据通过选择 Base64 编码，来当作文本进行发送</li>
</ol>
<h4 id="Form字段"><a href="#Form字段" class="headerlink" title="Form字段"></a>Form字段</h4><p>Request 上的函数允许我们从 URL 或/和 Body 中提取数据，通过这些字段：    </p>
<ul>
<li>Form</li>
<li>PostForm</li>
<li>MultipartForm</li>
</ul>
<p>Form 里面的数据是 key-value 对。通常的做法是：先调用 ParseForm 或 ParseMultipartForm 来解析 Request，然后相应的访问 Form、PostForm 或 MultipartForm 字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		request.ParseForm()</span><br><span class="line">		fmt.Fprintln(writer, request.Form)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8888"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样会打印出一个map，包含传入的所有的值。包括url的值和表单的值。</p>
<p>如果只想要表单的 key-value 对，不要 URL 的，可以使用 PostForm 字段。<br>PostForm 只支持 application/x-www-form-urlencoded</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		request.ParseForm()</span><br><span class="line">		fmt.Fprintln(writer, request.PostForm)</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果就只有一个字段</p>
<p>而想要得到 multipart key-value 对，必须使用 MultipartForm 字段。</p>
<p>想要使用 MultipartForm 这个字段的话，首先需要调用ParseMultipartForm 这个方法，该方法会在必要时调用 ParseForm 方法<br>，参数是需要读取数据的长度<br>MultipartForm 只包含表单的 key-value 对，返回类型是一个 struct 而不是 map。这个 struct 里有两个 map：1、key 是 string，value 是 []string 。2、空的（key 是 string，value 是文件）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		request.ParseMultipartForm(<span class="number">1024</span>)</span><br><span class="line">		fmt.Fprintln(writer, request.PostForm)</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="FormValue-和-PostFormValue-方法"><a href="#FormValue-和-PostFormValue-方法" class="headerlink" title="FormValue 和 PostFormValue 方法"></a>FormValue 和 PostFormValue 方法</h5><ul>
<li>FormValue 方法会返回 Form 字段中指定 key 对应的第一个 value，无需调用 ParseForm 或 ParseMultipartForm</li>
<li>PostFormValue 方法也一样，但只能读取 PostForm</li>
<li>FormValue 和 PostFormValue 都会调用 ParseMultipartForm 方法</li>
<li>但如果表单的 enctype 设为 multipart/form-data，那么即使你调用ParseMultipartForm 方法，也无法通过 FormValue 获得想要的值。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		request.ParseMultipartForm(<span class="number">1024</span>)</span><br><span class="line">		fmt.Fprintln(writer, request.FormValue(<span class="string">"name"</span>))</span><br><span class="line">		fmt.Fprintln(writer, request.PostFormValue(<span class="string">"name"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h4><p>multipart/form-data 最常见的应用场景就是上传文件（例子）：</p>
<ol>
<li>首先调用 ParseMultipartForm 方法</li>
<li>从 File 字段获得 FileHeader，调用其 Open 方法来获得文件</li>
<li>可以使用 ioutil.ReadAll 函数把文件内容读取到 byte 切片里</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, process)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	request.ParseMultipartForm(<span class="number">1024</span>)                      <span class="comment">//1024表示一次性加载到内存的最大字节数</span></span><br><span class="line">	fileHeader := request.MultipartForm.File[<span class="string">"upload"</span>][<span class="number">0</span>] <span class="comment">//表示从upload字段获取值</span></span><br><span class="line">	file, err := fileHeader.Open()</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		data, err := ioutil.ReadAll(file)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Fprintln(writer, <span class="keyword">string</span>(data))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字如其意，非常简单。但是这部分代码仍然有改进的空间，比如使用FormFile</p>
<h5 id="FormFile"><a href="#FormFile" class="headerlink" title="FormFile()"></a>FormFile()</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">//request.ParseMultipartForm(1024)                      //1024表示一次性加载到内存的最大字节数</span></span><br><span class="line">	<span class="comment">//fileHeader := request.MultipartForm.File["upload"][0] //表示从upload字段获取值</span></span><br><span class="line">	<span class="comment">//file, err := fileHeader.Open()</span></span><br><span class="line"></span><br><span class="line">	file, _, err := request.FormFile(<span class="string">"uploader"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		data, err := ioutil.ReadAll(file)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Fprintln(writer, <span class="keyword">string</span>(data))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="MultipartReader"><a href="#MultipartReader" class="headerlink" title="MultipartReader()"></a>MultipartReader()</h5><p>方法签名：func (r <em>Request) MultipartReader() (</em>multipart.Reader, error)<br>如果是 multipart/form-data 或 multipart 混合的 POST 请求：1、MultipartReader 返回一个 MIME multipart reader 2、否则返回 nil 和一个错误<br>可以使用该函数代替 ParseMultipartForm 来把请求的 body 作为 stream 进行处理。1、不是把表单作为一个对象来处理的，不是一次性获得整个 map。2、逐个检查来自表单的值，然后每次处理一个</p>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><h4 id="ResponseWriter"><a href="#ResponseWriter" class="headerlink" title="ResponseWriter"></a>ResponseWriter</h4><p>从服务器向客户端返回响应需要使用 ResponseWriter。ResponseWriter 是一个接口，handler 用它来返回响应。而真正支撑 ResponseWriter 的幕后 struct 是非导出的 http.response。</p>
<p>但是，为什么request是指针，而writer不用是呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(writer http.ResponseWriter, request *http.Request)</span><br></pre></td></tr></table></figure>

<p>其实，这两个都是按引用进行传递的，ResponseWriter是具有Header、Write、WriteHeader三种方法的接口，response指针实现了以上三种方法，故response是一种特殊的ResponseWriter。</p>
<p>并且，ResponseWriter还能使用writer.Write([]byte(str))方法，把字符串写入到body里面。</p>
<h4 id="WriteHeader-方法"><a href="#WriteHeader-方法" class="headerlink" title="WriteHeader 方法"></a>WriteHeader 方法</h4><p>WriteHeader 方法接收一个整数类型（HTTP 状态码）作为参数，并把它作为 HTTP 响应的状态码返回<br>如果该方法没有显式调用，那么在第一次调用 Write 方法前，会隐式的调用 WriteHeader(http.StatusOK)，所以 WriteHeader 主要用来发送错误类的 HTTP 状态码<br>调用完 WriteHeader 方法之后，仍然可以写入到 ResponseWriter，但无法再修改 header 了</p>
<h4 id="Header-方法"><a href="#Header-方法" class="headerlink" title="Header 方法"></a>Header 方法</h4><p>Header 方法返回 headers 的 map，可以进行修改<br>修改后的 headers 将会体现在返回给客户端的 HTTP 响应里</p>
<h4 id="内置的-Response"><a href="#内置的-Response" class="headerlink" title="内置的 Response"></a>内置的 Response</h4><p>NotFound 函数，包装一个 404 状态码和一个额外的信息<br>ServeFile 函数，从文件系统提供文件，返回给请求者<br>ServeContent 函数，它可以把实现了 io.ReadSeeker 接口的任何东西里面的内容返回给请求者，并且，还可以处理 Range 请求（范围请求），如果只请求了资源的一部分内容，那么 ServeContent 就可以如此响应。而 ServeFile 或 io.Copy 则不行。<br>Redirect 函数，告诉客户端重定向到另一个 URL</p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>Web 模板就是预先设计好的 HTML 页面，它可以被模板引擎反复的使用，来产生 HTML 页面<br>Go 的标准库提供了 text/template，html/template 两个模板库，大多数 Go 的 Web 框架都使用这些库作为 默认的模板引擎</p>
<h4 id="Go-的模板和模板引擎"><a href="#Go-的模板和模板引擎" class="headerlink" title="Go 的模板和模板引擎"></a>Go 的模板和模板引擎</h4><p>go主要使用的是 text/template，HTML 相关的部分使用了 html/template，是个混合体。go模板可以完全无逻辑，但又具有足够的嵌入特性。和大多数模板引擎一样，Go Web 的模板位于无逻辑和嵌入逻辑之间的某个地方</p>
<h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><p>在 Web 应用中，通产是由 handler 来触发模板引擎。handler 调用模板引擎，并将使用的模板传递给引擎，通常是一组模板文件和动态数据。<br>模板引擎生成 HTML，并将其写入到 ResponseWriter，ResponseWriter 再将它加入到 HTTP 响应中，返回给客户端。</p>
<h5 id="模板的例子"><a href="#模板的例子" class="headerlink" title="模板的例子"></a>模板的例子</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">&#123;&#123; . &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">模板必须是可读的文本格式，扩展名任意。对于 Web 应用通常就是 HTML，里面会内嵌一些命令（叫做 action）</span><br><span class="line">text/template 是通用模板引擎，html/template 是 HTML 模板引擎</span><br><span class="line">action 位于双层花括号之间：&#123;&#123; . &#125;&#125;。这里的 . 就是一个 action。它可以命令模板引擎将其替换成一个值。</span><br></pre></td></tr></table></figure>

<p>是不是有点像jsp</p>
<h5 id="使用模板引擎"><a href="#使用模板引擎" class="headerlink" title="使用模板引擎"></a>使用模板引擎</h5><ol>
<li>解析模板源（可以是字符串或模板文件），从而创建一个解析好的 模板的 struct</li>
<li>执行解析好的模板，并传入 ResponseWriter 和 数据。这会触发模板引擎组合解析好的模板和数据，来产生最终的 HTML，并将它传递给 ResponseWriter </li>
</ol>
<p>例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">"/process"</span>, process)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">"mytest.html"</span>) <span class="comment">//去解析一个模板文件，一个也在这个包下的html文件，</span></span><br><span class="line">	t.Execute(writer, <span class="string">"hello,my friends"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是鉴于现今几乎都是前后端分离的项目了，模板引擎已经几乎要绝迹了，随便学学吧。</p>
<h4 id="解析模板"><a href="#解析模板" class="headerlink" title="解析模板"></a>解析模板</h4><h5 id="ParseFiles"><a href="#ParseFiles" class="headerlink" title="ParseFiles"></a>ParseFiles</h5><p>解析模板文件，并创建一个解析好的模板 struct，后续可以被执行<br>ParseFiles 函数是 Template struct 上 ParseFiles 方法的简便调用<br>调用 ParseFiles 后，会创建一个新的模板，模板的名字是文件名<br>ParseFiles 的参数数量可变，但只返回一个模板，当解析多个文件时，第一个文件作为返回的模板（名、内容），其余的作为 map，供后续执行使用</p>
<h5 id="ParseGlob"><a href="#ParseGlob" class="headerlink" title="ParseGlob"></a>ParseGlob</h5><p>使用模式匹配来解析特定的文件</p>
<h5 id="Parse"><a href="#Parse" class="headerlink" title="Parse"></a>Parse</h5><p>可以解析字符串模板，其它方式最终都会调用 Parse</p>
<h5 id="Lookup-方法"><a href="#Lookup-方法" class="headerlink" title="Lookup 方法"></a>Lookup 方法</h5><p>通过模板名来寻找模板，如果没找到就返回 nil</p>
<h5 id="Must-函数"><a href="#Must-函数" class="headerlink" title="Must 函数"></a>Must 函数</h5><p>可以包裹一个函数，返回到一个模板的指针 和 一个错误。如果错误不为 nil，那么就 panic</p>
<h4 id="模板的Action"><a href="#模板的Action" class="headerlink" title="模板的Action"></a>模板的Action</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Action 就是 Go 模板中嵌入的命令，位于两组花括号之间 &#123;&#123; xxx &#125;&#125;，就是一个 Action，而且是最重要的一个。它代表了传入模板的数据</span><br></pre></td></tr></table></figure>

<p>Action 主要可以分为五类：条件类，迭代/遍历类，设置类，包含类，定义类</p>
<h5 id="条件Action"><a href="#条件Action" class="headerlink" title="条件Action"></a>条件Action</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if arg &#125;&#125;</span><br><span class="line">  some content</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; if arg &#125;&#125;</span><br><span class="line">  some content</span><br><span class="line">&#123;&#123; else &#125;&#125;</span><br><span class="line">  other content</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="迭代-遍历-Action"><a href="#迭代-遍历-Action" class="headerlink" title="迭代/遍历 Action"></a>迭代/遍历 Action</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; range array &#125;&#125;</span><br><span class="line">  Dot is set to the element &#123;&#123; . &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这类 Action 用来遍历数组、slice、map 或 channel 等数据结构，“.”用来表示每次迭代循环中的元素</p>
<h5 id="设置Action"><a href="#设置Action" class="headerlink" title="设置Action"></a>设置Action</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; with arg &#125;&#125;</span><br><span class="line">  Dot is set to arg</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>它允许在指定范围内，让“.”来表示其它指定的值（arg）</p>
<h5 id="包含-Action"><a href="#包含-Action" class="headerlink" title="包含 Action"></a>包含 Action</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; template "name" &#125;&#125;</span><br><span class="line">它允许你在模板中包含其它的模板</span><br><span class="line">&#123;&#123; template "name" arg &#125;&#125;</span><br><span class="line">给被包含模板传递参数</span><br></pre></td></tr></table></figure>



<h4 id="函数与管道"><a href="#函数与管道" class="headerlink" title="函数与管道"></a>函数与管道</h4><h5 id="参数（argument）"><a href="#参数（argument）" class="headerlink" title="参数（argument）"></a>参数（argument）</h5><p>参数就是模板里面用到的值。可以是 bool、整数、string … ，也可以是 struct、struct 的字段、数组的 key 等等<br>参数可以是变量、方法（返回单个值或返回一个值和一个错误）或函数<br>参数可以是一个点“.”，也就是传入模板引擎的那个值。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if arg &#125;&#125;</span><br><span class="line">  some content</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">这里的 arg 就是参数</span><br></pre></td></tr></table></figure>

<h5 id="在-Action-中设置变量"><a href="#在-Action-中设置变量" class="headerlink" title="在 Action 中设置变量"></a>在 Action 中设置变量</h5><p>可以在 action 中设置变量，变量以 $ 开头：$variable := value<br>一个迭代 action 的例子:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; range $key, $value := . &#125;&#125;</span><br><span class="line">  The key is &#123;&#123; $key &#125;&#125; and the value is &#123;&#123; $value &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="管道（pipeline）"><a href="#管道（pipeline）" class="headerlink" title="管道（pipeline）"></a>管道（pipeline）</h5><p>管道是按顺序连接到一起的参数、函数和方法。和 Unix 的管道类似:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如：&#123;&#123; p1 | p2 | p3 &#125;&#125;  ，p1、p2、p3 要么是参数，要么是函数</span><br><span class="line">管道允许我们把参数的输出发给下一个参数，下一个参数由管道（|）分隔开。</span><br></pre></td></tr></table></figure>

<h5 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h5><p>参数可以是一个函数，Go 模板引擎提供了一些基本的内置函数，功能比较有限。例如 fmt.Sprint 的各类变体等<br>开发者可以自定义函数，可以接收任意数量的输入参数<br>返回：一个值     或       一个值+一个错误</p>
<h5 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define、template、block</span><br><span class="line">html、js、urlquery。对字符串进行转义，防止安全问题</span><br><span class="line">如果是 Web 模板，那么不会需要经常使用这些函数。</span><br><span class="line">index</span><br><span class="line">print/printf/println</span><br><span class="line">len</span><br><span class="line">with</span><br><span class="line">这些都是内置的函数</span><br></pre></td></tr></table></figure>

<h5 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">template.Funcs(funcMap FuncMap) *Template</span><br><span class="line"><span class="keyword">type</span> FuncMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="comment">//value 是函数</span></span><br><span class="line"><span class="comment">//可以有任意数量的参数</span></span><br><span class="line"><span class="comment">//返回单个值的函数或返回一个值+一个错误的函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">创建一个 FuncMap（map 类型）。</span></span><br><span class="line"><span class="comment">key 是函数名</span></span><br><span class="line"><span class="comment">value 就是函数</span></span><br><span class="line"><span class="comment">把 FuncMap 附加到模板</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>常见用法：template.New(“”).Funcs(funcMap).Parse(…)，调用顺序非常重要。可以在管道中使用，也可以作为正常函数使用。</p>
<h4 id="模板组合"><a href="#模板组合" class="headerlink" title="模板组合"></a>模板组合</h4><h5 id="Layout-模板"><a href="#Layout-模板" class="headerlink" title="Layout 模板"></a>Layout 模板</h5><p>Layout 模板就是网页中固定的部分，它可以被多个网页重复使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Include（包含）action 的形式：&#123;&#123; template "name" . &#125;，</span><br></pre></td></tr></table></figure>

<p>以这种方式做 layout 模板是不可行的。而正确的做法是在模板文件里面使用 define action 再定义一个模板。这种形式特别像thymeleaf，就是单纯的将HTML页面强行模块化，使其具有公共部分的属性，总体而言还是比较简单的。而也可以在多个模板文件里，定义同名的模板。</p>
<h5 id="使用-block-action-定义默认模板"><a href="#使用-block-action-定义默认模板" class="headerlink" title="使用 block action 定义默认模板"></a>使用 block action 定义默认模板</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; block arg &#125;&#125;</span><br><span class="line">  Dot is set to arg</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">block action 可以定义模板，并同时就使用它</span><br><span class="line">template：模板必须可用</span><br><span class="line">block：模板可以不存在</span><br></pre></td></tr></table></figure>

<h5 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eq/ne</span><br><span class="line">lt/gt</span><br><span class="line">le/ge</span><br><span class="line">and</span><br><span class="line">or</span><br><span class="line">not</span><br></pre></td></tr></table></figure>

<p>字如其意。</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>接下来看看如何使用golang去连接数据库，并进行基本的CRUD。</p>
<h4 id="https-www-jianshu-com-p-7e745fefb8af"><a href="#https-www-jianshu-com-p-7e745fefb8af" class="headerlink" title="https://www.jianshu.com/p/7e745fefb8af"></a><strong><a href="https://www.jianshu.com/p/7e745fefb8af" target="_blank" rel="noopener">https://www.jianshu.com/p/7e745fefb8af</a></strong></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"database/sql"</span></span><br><span class="line">    _ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//"用户名:密码@[连接方式](主机名:端口号)/数据库名"</span></span><br><span class="line">    db,_:=sql.Open(<span class="string">"mysql"</span>,<span class="string">"root:root@(127.0.0.1:3306)/testdatabases"</span>) <span class="comment">// 设置连接数据库的参数</span></span><br><span class="line">    <span class="keyword">defer</span> db.Close()    <span class="comment">//关闭数据库</span></span><br><span class="line">    err:=db.Ping()      <span class="comment">//连接数据库</span></span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">        fmt.Println(<span class="string">"数据库连接失败"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作一：执行数据操作语句</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sql:="insert into stu values (2,'berry')"</span></span><br><span class="line"><span class="comment">    result,_:=db.Exec(sql)      //执行SQL语句</span></span><br><span class="line"><span class="comment">    n,_:=result.RowsAffected(); //获取受影响的记录数</span></span><br><span class="line"><span class="comment">    fmt.Println("受影响的记录数是",n)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作二：执行预处理</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    stu:=[2][2] string&#123;&#123;"3","ketty"&#125;,&#123;"4","rose"&#125;&#125;</span></span><br><span class="line"><span class="comment">    stmt,_:=db.Prepare("insert into stu values (?,?)")      //获取预处理语句对象</span></span><br><span class="line"><span class="comment">    for _,s:=range stu&#123;</span></span><br><span class="line"><span class="comment">        stmt.Exec(s[0],s[1])            //调用预处理语句</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作三：单行查询</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    var id,name string</span></span><br><span class="line"><span class="comment">    rows:=db.QueryRow("select * from stu where id=4")   //获取一行数据</span></span><br><span class="line"><span class="comment">    rows.Scan(&amp;id,&amp;name)        //将rows中的数据存到id,name中</span></span><br><span class="line"><span class="comment">    fmt.Println(id,"--",name)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//操作四：多行查询</span></span><br><span class="line">    rows,_:=db.Query(<span class="string">"select * from stu"</span>)       <span class="comment">//获取所有数据</span></span><br><span class="line">    <span class="keyword">var</span> id,name <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next()&#123;        <span class="comment">//循环显示所有的数据</span></span><br><span class="line">        rows.Scan(&amp;id,&amp;name)</span><br><span class="line">        fmt.Println(id,<span class="string">"--"</span>,name)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>前面很多时候，都是使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.HandleFunc(<span class="string">"/home"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	writer.Write([]<span class="keyword">byte</span>(<span class="string">"back home,my son"</span>))</span><br><span class="line">&#125;)</span><br><span class="line">http.HandleFunc(<span class="string">"/welcome"</span>, http.HandlerFunc(welcome))</span><br></pre></td></tr></table></figure>

<p>HandleFunc这种方式去进行路由控制，但是其实还有更为方便的写法。</p>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>main()：设置类工作<br>controller：1、静态资源 。2、把不同的请求送到不同的 controller 进行处理</p>
<p>我们实际上应该这么设置才是最为正确的写法。</p>
<p>例子，先制作出两个页面：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerHomeRoutes</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/home"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		writer.Write([]<span class="keyword">byte</span>(<span class="string">"back home,my son"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerWelcomeRoutes</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/welcome"</span>, http.HandlerFunc(welcome))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">welcome</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	_, err := writer.Write([]<span class="keyword">byte</span>(<span class="string">"welcome,my friends"</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再将两个函数进行注册：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="comment">//RegisterRoutes 用于注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterRoutes</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//这里还可以使用静态资源</span></span><br><span class="line">	registerHomeRoutes()</span><br><span class="line">	registerWelcomeRoutes()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在主函数中调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	server :&#x3D; http.Server&#123;</span><br><span class="line">		Addr:    &quot;localhost:8888&quot;,</span><br><span class="line">		Handler: nil,</span><br><span class="line">	&#125;</span><br><span class="line">	controller.RegisterRoutes()</span><br><span class="line">	err :&#x3D; server.ListenAndServe()</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这实际上是一种代码层面的解耦合，将我们的函数进一步模块化。</p>
<h4 id="路由的参数"><a href="#路由的参数" class="headerlink" title="路由的参数"></a>路由的参数</h4><p>静态路由：一个路径对应一个页面：</p>
<p>/home           或       /about</p>
<p>带参数的路由：根据路由参数，创建出一族不同的页面：</p>
<p>/companies/123               或            /companies/Google</p>
<p>这里使用HandlerFunc就可以了，将字符串传入URL，效果是相同的，与Spring+thymeleaf可以说是一模一样。</p>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>现在讲究前后端分离，大多数数据都是使用JSON去传递数据，接下来看看如何在go中使用JSON对象。</p>
<h4 id="类型映射"><a href="#类型映射" class="headerlink" title="类型映射"></a>类型映射</h4><p>Go bool：JSON boolean<br>Go float64：JSON 数值<br>Go string：JSON strings<br>Go nil：JSON null.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对于未知结构的-JSON"><a href="#对于未知结构的-JSON" class="headerlink" title="对于未知结构的 JSON"></a>对于未知结构的 JSON</h4><p>map[string]interface{} 可以存储任意 JSON 对象<br>[]interface{} 可以存储任意的 JSON 数组</p>
<h4 id="读取-JSON"><a href="#读取-JSON" class="headerlink" title="读取 JSON"></a>读取 JSON</h4><p>需要一个解码器：dec := json.NewDecoder(r.Body) ，参数需实现 Reader 接口<br>解码器上进行解码：dec.Decode(&amp;query)</p>
<h4 id="写入-JSON"><a href="#写入-JSON" class="headerlink" title="写入 JSON"></a>写入 JSON</h4><p>需要一个编码器：enc := json.NewEncoder(w)，参数需实现 Writer 接口<br>编码是：enc.Encode(results)</p>
<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/companies"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> request.Method &#123;</span><br><span class="line">		<span class="keyword">case</span> http.MethodPost: <span class="comment">//首先看看请求的类型</span></span><br><span class="line">			dec := json.NewDecoder(request.Body) <span class="comment">//现在JSON就在这个body里边了，并且需要进行解码</span></span><br><span class="line">			company := Company&#123;&#125;</span><br><span class="line">			err := dec.Decode(&amp;company) <span class="comment">//将密码解码到company这个变量里边</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;             <span class="comment">//如果它不为空</span></span><br><span class="line">				log.Println(err.Error())                           <span class="comment">//打印错误</span></span><br><span class="line">				writer.WriteHeader(http.StatusInternalServerError) <span class="comment">//500error</span></span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//否则将客户端传过来的数据转化为json重新返回给客户端</span></span><br><span class="line">			enc := json.NewEncoder(writer)</span><br><span class="line">			err = enc.Encode(company)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(err.Error())                           <span class="comment">//打印错误</span></span><br><span class="line">				writer.WriteHeader(http.StatusInternalServerError) <span class="comment">//500error</span></span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			writer.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">"localhost:8888"</span>,</span><br><span class="line">		Handler: <span class="literal">nil</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	err := server.ListenAndServe()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用Postman进行测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://localhost:8888/companies</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">&#123;</span></span><br><span class="line">    "id": 123,</span><br><span class="line">    "name": "google",</span><br><span class="line">    "country": "USA"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码的类型：Marshal-和-Unmarshal"><a href="#编码的类型：Marshal-和-Unmarshal" class="headerlink" title="编码的类型：Marshal 和 Unmarshal"></a>编码的类型：Marshal 和 Unmarshal</h4><p>Marshal（编码）: 把 go struct 转化为 json 格式。MarshalIndent，带缩进<br>Unmarshal（解码）: 把 json 转化为 go struct</p>
<p>测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	jsonStr := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">    "id": 123,</span></span><br><span class="line"><span class="string">    "name": "google",</span></span><br><span class="line"><span class="string">    "country": "USA"</span></span><br><span class="line"><span class="string">	&#125;`</span></span><br><span class="line">	c := Company&#123;&#125;</span><br><span class="line">	_ = json.Unmarshal([]<span class="keyword">byte</span>(jsonStr), &amp;c)</span><br><span class="line">	fmt.Println(c)</span><br><span class="line"></span><br><span class="line">	bytes, _ := json.Marshal(c)</span><br><span class="line">	fmt.Println(<span class="keyword">string</span>(bytes))</span><br><span class="line"></span><br><span class="line">	bytes2, _ := json.MarshalIndent(c, <span class="string">","</span>, <span class="string">"     "</span>)</span><br><span class="line">	fmt.Println(<span class="keyword">string</span>(bytes2))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//打印结果为：</span></span><br><span class="line">&#123;<span class="number">123</span> google USA&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="number">123</span>,<span class="string">"name"</span>:<span class="string">"google"</span>,<span class="string">"country"</span>:<span class="string">"USA"</span>&#125;</span><br><span class="line">&#123;</span><br><span class="line">,     <span class="string">"id"</span>: <span class="number">123</span>,</span><br><span class="line">,     <span class="string">"name"</span>: <span class="string">"google"</span>,</span><br><span class="line">,     <span class="string">"country"</span>: <span class="string">"USA"</span></span><br><span class="line">,&#125;</span><br></pre></td></tr></table></figure>



<p>区别：</p>
<p>针对 string 或 bytes：</p>
<ul>
<li>Marshal =&gt; String</li>
<li>Unmarshal &lt;= String</li>
</ul>
<p>针对 stream:</p>
<ul>
<li>Encode =&gt; Stream，把数据写入到 io.Writer</li>
<li>Decode &lt;= Stream，从 io.Reader 读取数据</li>
</ul>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p>中间件大家都懂的，像消息队列，缓存，也是中间件。当然也可以自己捏一个中间件的处理逻辑。</p>
<h4 id="创建中间件"><a href="#创建中间件" class="headerlink" title="创建中间件"></a>创建中间件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenAndServe</span><span class="params">(addr <span class="keyword">string</span>, handler Handler)</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">//handler 如果是 nil：DefaultServeMux</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>像这个Handler接口，并可以支持中间件的处理。</p>
<p>首先创建一下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyMiddleware <span class="keyword">struct</span> &#123;</span><br><span class="line">	Next http.Handler</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(m MyMiddleware)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 在 next handler 之前做一些事情</span></span><br><span class="line">m.Next.ServeHTTP(w, r)</span><br><span class="line"><span class="comment">// 在 next handler 之后做一些事情</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>途中可以定义中间件需要做的事情。</p>
<h4 id="中间件的用途"><a href="#中间件的用途" class="headerlink" title="中间件的用途"></a>中间件的用途</h4><ol>
<li>Logging，日志</li>
<li>安全，身份认证</li>
<li>请求超时，减少资源消耗</li>
<li>响应压缩，提升效率 </li>
</ol>
<h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//中间件</span></span><br><span class="line"><span class="keyword">type</span> AuthMiddleware <span class="keyword">struct</span> &#123;</span><br><span class="line">	Next http.Handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(am *AuthMiddleware)</span> <span class="title">ServeHTTP</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> am.Next == <span class="literal">nil</span> &#123;</span><br><span class="line">		am.Next = http.DefaultServeMux</span><br><span class="line">	&#125; <span class="comment">//如果什么都没有，执行默认页面</span></span><br><span class="line">	auth := request.Header.Get(<span class="string">"Authorization"</span>)</span><br><span class="line">	<span class="keyword">if</span> auth != <span class="string">""</span> &#123; <span class="comment">//说明存在身份，则执行逻辑</span></span><br><span class="line">		am.Next.ServeHTTP(writer, request)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">//否则报异常</span></span><br><span class="line">		writer.WriteHeader(http.StatusUnauthorized) <span class="comment">//401未授权</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是自定义的中间件类型，接着是主函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/companies"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		c := Company&#123;</span><br><span class="line">			ID:      <span class="number">111</span>,</span><br><span class="line">			Name:    <span class="string">"Microsoft"</span>,</span><br><span class="line">			Country: <span class="string">"USA"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">		enc := json.NewEncoder(writer)</span><br><span class="line">		enc.Encode(c)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8888"</span>, <span class="built_in">new</span>(middleware.AuthMiddleware))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将该中间件注册过后，便可以执行逻辑。</p>
<p>使用Postman进行测试，一个带Authorization，而另一个不带,测试略。</p>
<h3 id="请求上下文"><a href="#请求上下文" class="headerlink" title="请求上下文"></a>请求上下文</h3><p>从请求的上下文中获取信息，以用于处理</p>
<h4 id="Request-Context"><a href="#Request-Context" class="headerlink" title="Request Context"></a>Request Context</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(*Request)</span> <span class="title">Context</span><span class="params">()</span> <span class="title">context</span>.<span class="title">Context</span></span></span><br><span class="line"><span class="comment">//返回当前请求的上下文</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(*Request)</span> <span class="title">WithContext</span><span class="params">(ctx context.Context)</span> <span class="title">context</span>.<span class="title">Context</span></span></span><br><span class="line"><span class="comment">//基于 Context 进行“修改”，（实际上）创建一个新的 Context</span></span><br></pre></td></tr></table></figure>

<p>有这么两种方式去处理上下文</p>
<p>看看里面实际上是什么：</p>
<h4 id="context-Context"><a href="#context-Context" class="headerlink" title="context.Context"></a>context.Context</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">	Deadline() (deadline time.Time, ok <span class="keyword">bool</span>)</span><br><span class="line">	Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	Err() error</span><br><span class="line">	Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//这些方法都是用于读取，不能进行设置</span></span><br></pre></td></tr></table></figure>

<p>这就是上下文接口里面的方法</p>
<p>context这个包，也有一些方法，可以返回新的context</p>
<h4 id="Context-API"><a href="#Context-API" class="headerlink" title="Context API"></a>Context API</h4><ul>
<li>WithCancel()，它有一个 CancelFunc</li>
<li>WithDeadline()，带有一个时间戳（time.Time）</li>
<li>WithTimeout()，带有一个具体的时间段（time.Duration）</li>
<li>WithValue()，在里面可以添加一些值</li>
</ul>
<h4 id="一个超时的例子"><a href="#一个超时的例子" class="headerlink" title="一个超时的例子"></a>一个超时的例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middleware</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TimeoutMiddleware <span class="keyword">struct</span> &#123;</span><br><span class="line">	Next http.Handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tm TimeoutMiddleware)</span> <span class="title">ServeHTTP</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> tm.Next == <span class="literal">nil</span> &#123;</span><br><span class="line">		tm.Next = http.DefaultServeMux</span><br><span class="line">	&#125; <span class="comment">//处理和中间件的一般方式一样</span></span><br><span class="line"></span><br><span class="line">	ctx := request.Context()                         <span class="comment">//获取上下文</span></span><br><span class="line">	ctx, _ = context.WithTimeout(ctx, <span class="number">3</span>*time.Second) <span class="comment">//修改context的超时判断</span></span><br><span class="line">	request.WithContext(ctx)                         <span class="comment">//用我们自定义的context去代替</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)                        <span class="comment">//意图在于，如果我们请求能够在3秒内完成的话，这个chan就会收到一个信号</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;                                      <span class="comment">//使用goroutine</span></span><br><span class="line">		tm.Next.ServeHTTP(writer, request) <span class="comment">//执行完这个方法后，发送一个信号</span></span><br><span class="line">		ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;                   <span class="comment">//发送信号</span></span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">select</span> &#123; <span class="comment">//一个竞争的状态</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-ch: <span class="comment">//正常处理完，得到信号，返回</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done(): <span class="comment">//否则返回错误</span></span><br><span class="line">		writer.WriteHeader(http.StatusRequestTimeout)</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先新造好这个中间件，然后注册到main函数里面</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"go_web/middleware"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/companies"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		c := Company&#123;</span><br><span class="line">			ID:      <span class="number">111</span>,</span><br><span class="line">			Name:    <span class="string">"Microsoft"</span>,</span><br><span class="line">			Country: <span class="string">"USA"</span>,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//time.Sleep(4*time.Second)</span></span><br><span class="line">		<span class="comment">//测试用</span></span><br><span class="line">		enc := json.NewEncoder(writer)</span><br><span class="line">		enc.Encode(c)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">"localhost:8888"</span>, &amp;middleware.TimeoutMiddleware&#123;Next: <span class="built_in">new</span>(middleware.AuthMiddleware)&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后像之前一样去测试，即可。</p>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>这是HTTP的流程</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/login</span> HTTP/1.1</span><br><span class="line">…</span><br><span class="line">username=admin&amp;password=123456</span><br></pre></td></tr></table></figure>

<p>都是明文传输的，所以我们有时候就需要HTTPS</p>
<h4 id="HTTP-Listener"><a href="#HTTP-Listener" class="headerlink" title="HTTP Listener"></a>HTTP Listener</h4><ul>
<li>http.ListenAndServe 函数</li>
<li>http.ListenAndServeTLS 函数</li>
</ul>
<p>可以使用ListenAndServeTLS去使其页面变为HTTPS类型，看看接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenAndServeTLS</span><span class="params">(addr, certFile, keyFile <span class="keyword">string</span>, handler Handler)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	server := &amp;Server&#123;Addr: addr, Handler: handler&#125;</span><br><span class="line">	<span class="keyword">return</span> server.ListenAndServeTLS(certFile, keyFile)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现需要安全证书，而我们的go就可以自己生成安全证书：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">go run D:\Golang\sdk\go1.<span class="number">15</span>.<span class="number">1</span>\src\crypto\tls\generate_cert.go -h</span><br><span class="line">//看看帮助</span><br><span class="line"> -ca</span><br><span class="line">        whether this cert should be its own Certificate Authority</span><br><span class="line">  -duration duration</span><br><span class="line">        Duration that certificate is valid <span class="keyword">for</span> (default <span class="number">8760</span>h0m0s)</span><br><span class="line">  -ecdsa-curve string</span><br><span class="line">        ECDSA curve to use to generate a key. Valid values are P224, P256 (recommended), P384, P521</span><br><span class="line">  -ed25519</span><br><span class="line">        Generate an Ed25519 key</span><br><span class="line">  -host string</span><br><span class="line">        Comma-separated hostnames and IPs to generate a certificate <span class="keyword">for</span></span><br><span class="line">  -rsa-bits int</span><br><span class="line">        Size of RSA key to generate. Ignored <span class="keyword">if</span> --ecdsa-curve is <span class="built_in">set</span> (default <span class="number">2048</span>)</span><br><span class="line">  -<span class="built_in">start</span>-<span class="built_in">date</span> string</span><br><span class="line">        Creation <span class="built_in">date</span> formatted as Jan <span class="number">1</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">05</span> <span class="number">2011</span></span><br></pre></td></tr></table></figure>

<p>于是乎，便生成证书：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go run D:\Golang\sdk\go1.<span class="number">15</span>.<span class="number">1</span>\src\crypto\tls\generate_cert.go -host localhost</span><br><span class="line"> //wrote cert.pem</span><br><span class="line"> //wrote key.pem</span><br></pre></td></tr></table></figure>

<p>之后再测试，发现只有使用HTTPS的前缀，才能打开网页。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"go_web/controller"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	controller.RegisterRoutes()</span><br><span class="line">	http.ListenAndServeTLS(<span class="string">"localhost:8888"</span>, <span class="string">"cert.pem"</span>, <span class="string">"key.pem"</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们使用的HTTP1.1协议就会自动升级到HTTP2.0协议</p>
<h3 id="HTTP的协议"><a href="#HTTP的协议" class="headerlink" title="HTTP的协议"></a>HTTP的协议</h3><h4 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP/1.1"></a>HTTP/1.1</h4><p>在HTTP/1.1的情况下：</p>
<ol>
<li>请求 header+body</li>
<li>响应 header+body</li>
</ol>
<p>这样请求和响应，他们的信息都无法被压缩，会导致传输效率低，但是HTTP2.0使得他们能够压缩加密</p>
<h4 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP/2.0"></a>HTTP/2.0</h4><p>在这个协议下，请求和响应都是使用Stream来进行的，把消息拆成多个Frame进行发送，每个Frame都可以单独的进行优化。</p>
<p>Frame类型：Headers、Continuation、Data等等，把请求和响应分成多个Frame，每个数据类型都可以单独优化。</p>
<h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ul>
<li><p>请求多路复用</p>
</li>
<li><p>Header 压缩</p>
</li>
<li><p>默认安全</p>
<p>​    HTTP ，但很多决定不支持 HTTP</p>
<p>​    HTTPS</p>
</li>
<li><p>Server Push</p>
</li>
</ul>
<h4 id="Server-Push"><a href="#Server-Push" class="headerlink" title="Server Push"></a>Server Push</h4><p>在没有Server Push的情况下，每个页面的素材例如：css、html等都是必须发送一个单独的请求来进行的。</p>
<p>在有了Server Push的情况下，但我们的html页面包含css文件的时候，Server Push会自动传输css文件，即使这个html文件还没有进行对css的引用。这样一来，当html文件需要使用的时候，就不用再次发送请求了。节省了一些加载时间。</p>
<h5 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">registerHomeRoutes</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/home"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> pusher, ok := writer.(http.Pusher); ok &#123; <span class="comment">//先做类型断言，看看存不存在push</span></span><br><span class="line">			pusher.Push(<span class="string">"/css/app.css"</span>, &amp;http.PushOptions&#123; <span class="comment">//如果为真，则说明支持server push</span></span><br><span class="line">				Header: http.Header&#123;<span class="string">"Content-Type"</span>: []<span class="keyword">string</span>&#123;<span class="string">"text/css"</span>&#125;&#125;, <span class="comment">//使其自加载这个文件</span></span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		writer.Write([]<span class="keyword">byte</span>(<span class="string">"back home,my son"</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后启动服务，进入页面，打开F12看看，结果就清晰明了了。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>接下来学习，如何对go web应用进行测试：</p>
<h4 id="测试-Model-层"><a href="#测试-Model-层" class="headerlink" title="测试 Model 层"></a>测试 Model 层</h4><p>可以编写一个单独的go程序进行测试，然后编写测试函数，并且应该注重命名：</p>
<ul>
<li><p>user_test.go</p>
<p>​    测试代码所在文件的名称以 _test 结尾</p>
<p>​    对于生产编译，不会包含以 _test 结尾的文件</p>
<p>​    对于测试编译，会包含以 _test 结尾的文件</p>
</li>
<li><p>func TestUpdatesModifiedTime(t *testing.T) { … }</p>
<p>​    测试函数名应以 Test 开头（需要导出）</p>
<p>​    函数名需要表达出被验证的特性</p>
<p>​    测试函数的参数类型是 *testing.T，它会提供测试相关的一些工具</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"strings"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID      <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name    <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Country <span class="keyword">string</span> <span class="string">`json:"country"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Company)</span> <span class="title">GetCompanyType</span><span class="params">()</span> <span class="params">(result <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> strings.HasSuffix(c.Name, <span class="string">".LTD"</span>) &#123;</span><br><span class="line">		result = <span class="string">"Limited Liability Company"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		result = <span class="string">"Others"</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在使用一个极为简易的例子去测试，判断公司的名称。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"testing"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCompany_GetCompanyType</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	c := Company&#123;</span><br><span class="line">		ID:      <span class="number">123</span>,</span><br><span class="line">		Name:    <span class="string">"Google.LTD"</span>,</span><br><span class="line">		Country: <span class="string">"USA"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	companyType := c.GetCompanyType() <span class="comment">//获取类型</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> companyType != <span class="string">"Limited Liability Company"</span> &#123; <span class="comment">//判断</span></span><br><span class="line">		t.Error(<span class="string">"this is others!"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果测试通过，则会直接显示PASS</span></span><br><span class="line"><span class="comment">//如果测试不通过。结果如下：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">UN   TestCompany_GetCompanyType</span></span><br><span class="line"><span class="comment">    company_test.go:15: this is others!</span></span><br><span class="line"><span class="comment">--- FAIL: TestCompany_GetCompanyType (0.00s)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">FAIL</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>这便是测试的结果。</p>
<h4 id="测试-Controller-层"><a href="#测试-Controller-层" class="headerlink" title="测试 Controller 层"></a>测试 Controller 层</h4><ol>
<li>为了尽量保证单元测试的隔离性，测试不要使用例如数据库、外部API、文件系统等外部资源。</li>
<li>模拟请求和响应</li>
<li>需要使用 net/http/httptest 提供的功能</li>
</ol>
<p>这里有几个函数值得关注：</p>
<h5 id="NewRequest-函数"><a href="#NewRequest-函数" class="headerlink" title="NewRequest 函数"></a>NewRequest 函数</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRequest</span><span class="params">(method, url <span class="keyword">string</span>, body io.Reader)</span> <span class="params">(*Request, error)</span></span> </span><br><span class="line"></span><br><span class="line"><span class="comment">//method：HTTP Method</span></span><br><span class="line"><span class="comment">//url：请求的 URL</span></span><br><span class="line"><span class="comment">//body：请求的 Body</span></span><br><span class="line"><span class="comment">//返回的 *Request 可以传递给 handler 函数</span></span><br></pre></td></tr></table></figure>

<h5 id="ResponseRecorder"><a href="#ResponseRecorder" class="headerlink" title="ResponseRecorder"></a>ResponseRecorder</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResponseRecorder &#123;</span><br><span class="line">  	Code <span class="keyword">int</span> <span class="comment">// 状态码  200、500…</span></span><br><span class="line">	HeaderMap http.Header <span class="comment">// 响应的 header</span></span><br><span class="line">	Body *bytes.Buffer <span class="comment">// 响应的 body</span></span><br><span class="line">	Flushed <span class="keyword">bool</span> <span class="comment">// 缓存是否被 flush 了</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用来捕获从 handler 返回的响应，只是做记录</span></span><br><span class="line"><span class="comment">//可以用于测试断言</span></span><br></pre></td></tr></table></figure>



<h5 id="例子-4"><a href="#例子-4" class="headerlink" title="例子"></a>例子</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"go_web/model"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterRoutesController</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/companies"</span>, handlerCompany)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerCompany</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">	c := model.Company&#123;</span><br><span class="line">		ID:      <span class="number">123</span>,</span><br><span class="line">		Name:    <span class="string">"Google"</span>,</span><br><span class="line">		Country: <span class="string">"USA"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//收到请求后使用JSON编码，并写到响应里面，并返回回去</span></span><br><span class="line">	enc := json.NewEncoder(writer)</span><br><span class="line">	enc.Encode(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着写一个测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"go_web/model"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"net/http/httptest"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestHandleCompanyCorrect</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	r := httptest.NewRequest(http.MethodGet, <span class="string">"/companies"</span>, <span class="literal">nil</span>) <span class="comment">//模拟一个请求</span></span><br><span class="line">	w := httptest.NewRecorder()                                 <span class="comment">//用于捕获和记录响应</span></span><br><span class="line">	handlerCompany(w, r)                                        <span class="comment">//传入Handler</span></span><br><span class="line"></span><br><span class="line">	result, _ := ioutil.ReadAll(w.Result().Body) <span class="comment">//获取响应，提取body</span></span><br><span class="line"></span><br><span class="line">	c := model.Company&#123;&#125;</span><br><span class="line">	json.Unmarshal(result, &amp;c) <span class="comment">//解码并重新放入c这个变量里边</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.ID != <span class="number">123</span> &#123; <span class="comment">//然后判断</span></span><br><span class="line">		t.Error(<span class="string">"this is a failed"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过就显示PASS</span></span><br><span class="line"><span class="comment">//否则显示：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">=== RUN   TestHandleCompanyCorrect</span></span><br><span class="line"><span class="comment">    company_test.go:23: this is a failed</span></span><br><span class="line"><span class="comment">--- FAIL: TestHandleCompanyCorrect (0.00s)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">FAIL</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>这还是比较方便的</p>
<h3 id="Profiling-性能分析"><a href="#Profiling-性能分析" class="headerlink" title="Profiling 性能分析"></a>Profiling 性能分析</h3><h4 id="分析的对象"><a href="#分析的对象" class="headerlink" title="分析的对象"></a>分析的对象</h4><ul>
<li><p>内存消耗</p>
</li>
<li><p>CPU 使用</p>
</li>
<li><p>阻塞的 goroutine</p>
</li>
<li><p>执行追踪</p>
</li>
</ul>
<p>还有一个 Web 界面：应用的实时数据</p>
<h4 id="如何分析"><a href="#如何分析" class="headerlink" title="如何分析"></a>如何分析</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import _ “<span class="built_in">net</span>/http/pprof”</span><br><span class="line">引入一个包，设置一些监听的 URL，它们会提供各类诊断信息</span><br><span class="line"></span><br><span class="line">go tool pprof http://localhost:<span class="number">8000</span>/debug/pprof/heap   // 内存</span><br><span class="line">从应用获取内存 dump：应用在使用哪些内存，它们会去哪</span><br><span class="line"></span><br><span class="line">go tool pprof http://localhost:<span class="number">8000</span>/debug/pprof/profile    // CPU</span><br><span class="line">CPU 的快照，可以看到谁在用 CPU</span><br><span class="line"></span><br><span class="line">go tool pprof http://localhost:<span class="number">8000</span>/debug/pprof/block // goroutine</span><br><span class="line">看到阻塞的 goroutine</span><br><span class="line"></span><br><span class="line">go tool pprof http://localhost:<span class="number">8000</span>/debug/pprof/trace?seconds=<span class="number">5</span>  // trace</span><br><span class="line">监控这段时间内，什么在执行，什么在调用什么…</span><br><span class="line"></span><br><span class="line"><span class="function">http:// <span class="title">localhost</span>:8000/<span class="title">debug</span>/<span class="title">pprof</span> 	// 网页</span></span><br></pre></td></tr></table></figure>















<p>未完待续…….</p>
<h1 id="使用Go语言编写一个简易的分布式系统"><a href="#使用Go语言编写一个简易的分布式系统" class="headerlink" title="使用Go语言编写一个简易的分布式系统"></a>使用Go语言编写一个简易的分布式系统</h1><h2 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h2><p>在一开始我要去学习用go语言编写一个分布式系统的时候。我会在想什么是分布式系统，分布式系统又跟以往的系统有什么很大的差异，或者说区别嘛。带着这个好奇，我去搜索一下什么才是真正的分布式系统，我以为是非常高深，又难以明白的一门学科，但是我仔细了解分布式系统的原理后。我发现我好像学过？！</p>
<p>以下资料是来源于我在网上搜索得出的信息：</p>
<blockquote>
<h3 id="一-概念"><a href="#一-概念" class="headerlink" title="一.概念"></a>一.概念</h3><p>​            集  群: 同一个业务,部署在多个服务器上</p>
<p>​            分布式: 同一个业务,拆分成多个子业务,部署在不同的服务器上</p>
<p>​            微服务: 同一个业务,按照功能模块拆分,每一个服务只对应一个功能模块</p>
<h3 id="二-区别"><a href="#二-区别" class="headerlink" title="二.区别"></a>二.区别</h3><p>​     <strong>集群</strong>是多台服务器一起处理同一个业务,可以使用负载均衡使得每一个服务器的负载相对平衡,集群中的一台服务器出现问题,该服务器所负责的业务可以由其他的服务器代为处理.集群是一种物理形态.</p>
<p>​     <strong>分布式</strong>是把一个业务拆分成多个子业务,给不同的服务器去处理,这里的服务器可以是单个的服务器,也可以是多个服务器集群,一旦处理该业务的服务器出现问题,那么该业务就无法实现了.分布式是一种工作方式.</p>
<p>​     <strong>微服务</strong>是把一个业务中的各种功能模块进行拆分,给不同的服务去处理,每个服务只处理一个功能模块,该服务可以是单个服务器也可以是多个服务器集群,每个服务之间都是低耦合的.微服务是一种架构风格.</p>
<p>​    <strong>为什么说分布式不一定是微服务:</strong></p>
<p>​    假设有一个很大应用,拆分成几个小应用,但还是很庞大,即便使用了分布式,但其依旧不算是微服务,因为微服务的核心要素是微小,简单来说就是这个应用还不够小(嗯..没错就是这样!)</p>
<p>​            所以我们可以理解为:微服务是分布式的一个子集</p>
<h3 id="三-应用场景"><a href="#三-应用场景" class="headerlink" title="三.应用场景"></a>三.应用场景</h3><p>假设有一个业务,该业务有5个功能,每个功能单独处理需要1个小时.</p>
<p>此时,如果只部署一台服务器,则需要5个小时才能处理完该业务,若采用集群或者分布式来处理,结果如下:</p>
<p>​            1.采用集群处理:提供5台服务器一起处理该业务,则处理每个功能只需12分钟,即处理整个业务只需1个小时</p>
<p>​    2.采用分布式处理:提供5台服务器,每个服务器处理不同的功能,则一共也只需要一个小时.</p>
<p>​            该情况下,微服务和分布式的工作原理和最终结果是一样的.</p>
<h3 id="四-总结"><a href="#四-总结" class="headerlink" title="四.总结"></a>四.总结</h3><p>​            分布式中的每一个节点,都可以做集群.而集群并不一定就是分布式的.</p>
<p>​            微服务肯定是分布式的,但分布式不一定是微服务的.</p>
<p>作者：晔歌歌<br>链接：<a href="https://www.jianshu.com/p/5f157ac8efcf" target="_blank" rel="noopener">https://www.jianshu.com/p/5f157ac8efcf</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<p>所以说分布式系统其实是一个非常广泛的概念，很多的应用都可以是一个分布式系统，所以我想以我曾经学过的知识微服务，这一方面去了解，或者说是使用：<strong>如何用go编写一个微服务</strong>，也就是分布式系统。</p>
<p>注：我觉得写go还用前后端耦合，并且还用模板，是非常愚蠢的行为。而微服务是天生前后端分离的（战术后仰）。</p>
<p>总体分为三个部分：服务注册，服务发现，状态监控。</p>
<h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><h3 id="创建自定义的日志服务"><a href="#创建自定义的日志服务" class="headerlink" title="创建自定义的日志服务"></a>创建自定义的日志服务</h3><h4 id="实现基本逻辑"><a href="#实现基本逻辑" class="headerlink" title="实现基本逻辑"></a>实现基本逻辑</h4><p>目的在于接受请求，并把请求写入到log里面，是很多应用必备的功能。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> log</span><br><span class="line"></span><br><span class="line"><span class="comment">//因为标准库也有一个log，所以可以起一个别名</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> log *stlog.Logger</span><br><span class="line"></span><br><span class="line"><span class="comment">//目的在于把日志写入文件系统</span></span><br><span class="line"><span class="keyword">type</span> fileLog <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fl fileLog)</span> <span class="title">Write</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//首先要打开文件，才能写入</span></span><br><span class="line">	<span class="comment">//fl文件路径，os...表示没有则创造，只写，只附加，</span></span><br><span class="line">	f, err := os.OpenFile(<span class="keyword">string</span>(fl), os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0600</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//defer表示程序最后一定会执行的，这句的意思是必须把文件关闭</span></span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line">	<span class="keyword">return</span> f.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//最后把log指向某个文件地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(destination <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	log = stlog.New(fileLog(destination), <span class="string">"go"</span>, stlog.LstdFlags)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册一个Handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterHandler</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/log"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> request.Method &#123;</span><br><span class="line">		<span class="keyword">case</span> http.MethodPost: <span class="comment">//如果请求是post</span></span><br><span class="line">			msg, err := ioutil.ReadAll(request.Body) <span class="comment">//先读取内容</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(msg) == <span class="number">0</span> &#123;         <span class="comment">//如果有错误</span></span><br><span class="line">				writer.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//没有错误则写入日志</span></span><br><span class="line">			write(<span class="keyword">string</span>(msg))</span><br><span class="line">		<span class="keyword">default</span>: <span class="comment">//对于其他情况，方法就不进行，直接返回</span></span><br><span class="line">			writer.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">(message <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"%v\n"</span>, message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先写好一个基本的日志服务的逻辑，逻辑较为简单。但还需要完善，接下来就要实现能够运行的日志服务。也就是说，还需要把web服务集中化管理，使其能够正常的运行。</p>
<p>接着创立一个service，去完善服务：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//公共的函数，用于启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(ctx context.Context, serviceName, host, port <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	registerHandlersFunc <span class="keyword">func</span>()</span>) <span class="params">(context.Context, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//将传入的函数运行</span></span><br><span class="line">	registerHandlersFunc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//对服务进行基本的定义，完善服务，并将信息返回给主函数</span></span><br><span class="line">	ctx = startService(ctx, serviceName, host, port)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startService</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>, host <span class="keyword">string</span>, port <span class="keyword">string</span>)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="comment">//使得ctx具有取消的功能</span></span><br><span class="line">	ctx, cancel := context.WithCancel(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义服务地址</span></span><br><span class="line">	<span class="keyword">var</span> server http.Server</span><br><span class="line">	server.Addr = <span class="string">":"</span> + port</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">//一旦发生可错误，就取消上下文</span></span><br><span class="line">		log.Println(server.ListenAndServe())</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%v 服务开始。按任意键停止. \n"</span>, name)</span><br><span class="line">		<span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line">		fmt.Scanln(&amp;s)</span><br><span class="line">		server.Shutdown(ctx)</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里完善了服务启动的逻辑，接着还需要去使这个服务能够正常的运行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/log"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/service"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//定义日志地址</span></span><br><span class="line">	log.Run(<span class="string">"./distribute.log"</span>)</span><br><span class="line">	<span class="comment">//定义具体参数，其实通常应该由配置文件中定义</span></span><br><span class="line">	host, port := <span class="string">"localhost"</span>, <span class="string">"4000"</span></span><br><span class="line">	ctx, err := service.Start(</span><br><span class="line">		context.Background(),</span><br><span class="line">		<span class="string">"Log service"</span>,</span><br><span class="line">		host,</span><br><span class="line">		port,</span><br><span class="line">		log.RegisterHandler,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">//如果有错误，就先执行标准库的log打印出结果</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		stlog.Fatalln(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接需要等待ctx的信号</span></span><br><span class="line">	<span class="comment">//如果在启动服务器的时候出现了错误</span></span><br><span class="line">	<span class="comment">//或者在按下任意键停止后，就会发送信号</span></span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	<span class="comment">//接受到信号后，就会继续</span></span><br><span class="line">	fmt.Println(<span class="string">"停止服务"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>接着启动服务，并使用postman进行测试:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://localhost:4000/log</span></span><br></pre></td></tr></table></figure>

<p>输入任意文字，就会看到在根目录下，有一个日志文件生成了。</p>
<h3 id="服务注册的基本逻辑"><a href="#服务注册的基本逻辑" class="headerlink" title="服务注册的基本逻辑"></a>服务注册的基本逻辑</h3><h4 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h4><p>首先需要去尝试编写一下，一个可以将服务都注册进去的注册中心。</p>
<p>先写一个数据结构，注册中心：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册中心</span></span><br><span class="line"><span class="keyword">type</span> Registration <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName ServiceName</span><br><span class="line">	ServiceURL  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServiceName <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LogService = ServiceName(<span class="string">"LogService"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>注册中心包含了各个服务的名字的地址，紧接着，编写服务注册进去之后的逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ServerPort = <span class="string">":3000"</span></span><br><span class="line"><span class="keyword">const</span> ServicesURL = <span class="string">"http://localhost"</span> + ServerPort + <span class="string">"/services"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> registry <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//这个slice，是动态变化的，而且多个线程可能会并发的进行访问，</span></span><br><span class="line">	<span class="comment">//为了保证线程安全，需要加锁。</span></span><br><span class="line">	registrations []Registration</span><br><span class="line">	mutex         *sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在增加服务的时候是需要加锁的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.Lock()</span><br><span class="line">	registry.registrations = <span class="built_in">append</span>(registry.registrations, reg)</span><br><span class="line">	registry.mutex.Unlock()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reg = registry&#123;</span><br><span class="line">	registrations: <span class="built_in">make</span>([]Registration, <span class="number">0</span>),</span><br><span class="line">	mutex:         <span class="built_in">new</span>(sync.Mutex),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个web服务</span></span><br><span class="line"><span class="keyword">type</span> RegistryService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s RegistryService)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"接受请求："</span>)</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		<span class="comment">//解码</span></span><br><span class="line">		dec := json.NewDecoder(r.Body)</span><br><span class="line">		<span class="keyword">var</span> r Registration</span><br><span class="line">		err := dec.Decode(&amp;r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">"增加服务：%v ，该服务的地址是：%s \n"</span>,</span><br><span class="line">			r.ServiceName, r.ServiceURL)</span><br><span class="line">		err = reg.add(r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在之后，需要让服务独立运行</p>
<h4 id="独立服务"><a href="#独立服务" class="headerlink" title="独立服务"></a>独立服务</h4><p>接着就需要将之前的服务，注册到服务中心中。</p>
<p>这就需要创建一个服务中心主要运行逻辑了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//将之前的处理逻辑注册进去</span></span><br><span class="line">	http.Handle(<span class="string">"/services"</span>, registry.RegistryService&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//接下来的逻辑一样，需要有取消功能，当然其实你在ide中能直接打断，但在大型服务中，每秒都要运行。还是需要自定义取消功能的</span></span><br><span class="line">	ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//一样是定义服务的地址</span></span><br><span class="line">	<span class="keyword">var</span> srv http.Server</span><br><span class="line">	srv.Addr = registry.ServerPort</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		log.Println(srv.ListenAndServe())</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"注册中心 的服务开始。按任意键停止. \n"</span>)</span><br><span class="line">		<span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line">		fmt.Scanln(&amp;s)</span><br><span class="line">		srv.Shutdown(ctx)</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	fmt.Println(<span class="string">"结束服务注册"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实和日志服务的注册类似，没什么特别的,接着测试：</p>
<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http://localhost:3000/services</span></span><br></pre></td></tr></table></figure>

<p>接着输入json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;   </span><br><span class="line">     <span class="attr">"serviceName"</span>: <span class="string">"study service"</span>,</span><br><span class="line">    <span class="attr">"serviceURL"</span> : <span class="string">" http://localhost/5000/study"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着显示服务注册成功：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">注册中心 的服务开始。按任意键停止.</span><br><span class="line">接受请求：</span><br><span class="line">增加服务：study service ，该服务的//localhost/<span class="number">5000</span>/study</span><br></pre></td></tr></table></figure>



<h3 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h3><h4 id="微服务思想"><a href="#微服务思想" class="headerlink" title="微服务思想"></a>微服务思想</h4><p>首先微服务的基本含义是：注册中心是一个服务，然后其他的服务注册到注册中心，然后由主要控制台相互控制和调用。</p>
<p>那么现在会需要一个客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个函数的目的是给web service发送一个post请求</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterService</span><span class="params">(r Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	enc := json.NewEncoder(buf)</span><br><span class="line">	err := enc.Encode(r)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res, err := http.Post(ServicesURL, <span class="string">"application/json"</span>, buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务注册失败 "</span>+<span class="string">"状态码为： %v"</span>, res.StatusCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着需要去改一下日志服务的逻辑，使得日志服务会主动去注册自己：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//公共的函数，用于启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(ctx context.Context, host, port <span class="keyword">string</span>, reg registry.Registration,</span></span></span><br><span class="line"><span class="function"><span class="params">	registerHandlersFunc <span class="keyword">func</span>()</span>) <span class="params">(context.Context, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//将传入的函数运行</span></span><br><span class="line">	registerHandlersFunc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//对服务进行基本的定义，完善服务，并将信息返回给主函数</span></span><br><span class="line">	ctx = startService(ctx, reg.ServiceName, host, port)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//启动web服务之后注册：</span></span><br><span class="line">	err := registry.RegisterService(reg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ctx, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startService</span><span class="params">(ctx context.Context, name registry.ServiceName, host <span class="keyword">string</span>, port <span class="keyword">string</span>)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="comment">//使得ctx具有取消的功能</span></span><br><span class="line">	ctx, cancel := context.WithCancel(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义服务地址</span></span><br><span class="line">	<span class="keyword">var</span> server http.Server</span><br><span class="line">	server.Addr = <span class="string">":"</span> + port</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">//一旦发生可错误，就取消上下文</span></span><br><span class="line">		log.Println(server.ListenAndServe())</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%v 服务开始。按任意键停止. \n"</span>, name)</span><br><span class="line">		<span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line">		fmt.Scanln(&amp;s)</span><br><span class="line">		server.Shutdown(ctx)</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这的<strong>registry.RegisterService(reg)</strong>实际上会去调用client的<strong>func RegisterService(r Registration)</strong>，这样会向注册中心发送一个post请求，去注册自己。</p>
<p>接着，要去改动日志服务的main函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/log"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/service"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//定义日志地址</span></span><br><span class="line">	log.Run(<span class="string">"./distribute.log"</span>)</span><br><span class="line">	<span class="comment">//定义具体参数，其实通常应该由配置文件中定义</span></span><br><span class="line">	host, port := <span class="string">"localhost"</span>, <span class="string">"4000"</span></span><br><span class="line"></span><br><span class="line">	serviceAddress := fmt.Sprintf(<span class="string">"http://%s:%s"</span>, host, port)</span><br><span class="line">	r := registry.Registration&#123;</span><br><span class="line">		ServiceName: <span class="string">"log service"</span>,</span><br><span class="line">		ServiceURL:  serviceAddress,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx, err := service.Start(</span><br><span class="line">		context.Background(),</span><br><span class="line">		host,</span><br><span class="line">		port,</span><br><span class="line">		r,</span><br><span class="line">		log.RegisterHandler,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">//如果有错误，就先执行标准库的log打印出结果</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		stlog.Fatalln(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接需要等待ctx的信号</span></span><br><span class="line">	<span class="comment">//如果在启动服务器的时候出现了错误</span></span><br><span class="line">	<span class="comment">//或者在按下任意键停止后，就会发送信号</span></span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	<span class="comment">//接受到信号后，就会继续</span></span><br><span class="line">	fmt.Println(<span class="string">"停止服务"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是增加了<strong>serviceAddress</strong> ，也就是说所有服务都会使用这同一个逻辑。</p>
<h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><p>紧接着两个服务连续启动，先启动注册中心，后启动日志逻辑，结果如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">注册中心 的服务开始。按任意键停止.</span><br><span class="line"></span><br><span class="line">log service 服务开始。按任意键停止</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接受请求：</span><br><span class="line">增加服务：log service ，该服务的地址是：http://localhost:4000</span><br></pre></td></tr></table></figure>

<p>很简单对吧，和Spring cloud的微服务简直一模一样。</p>
<h3 id="取消注册"><a href="#取消注册" class="headerlink" title="取消注册"></a>取消注册</h3><p>那么我们把微服务注册进去了，自然能够调用，但是怎么主动去取消微服务呢？它肯定不是说我自己把自己的微服务关了就行了，同时也需要通知注册中心。</p>
<h4 id="修改注册中心"><a href="#修改注册中心" class="headerlink" title="修改注册中心"></a>修改注册中心</h4><p>直接在注册中心加上一个方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//那么肯定要有个方法取消服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//看看服务中台有没有这服务</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> reg.registrations &#123;</span><br><span class="line">		<span class="keyword">if</span> reg.registrations[i].ServiceURL == url &#123;</span><br><span class="line">			registry.mutex.Lock()</span><br><span class="line">			<span class="comment">//把后面的接上前面的，自然的去除了，方法其实不唯一</span></span><br><span class="line">			reg.registrations = <span class="built_in">append</span>(reg.registrations[:i], reg.registrations[i+<span class="number">1</span>:]...)</span><br><span class="line">			registry.mutex.Unlock()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务地址未发现： %s "</span>, url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后直接在Switch里面增加一个情况Delete：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> http.MethodDelete:</span><br><span class="line">	payload, err := ioutil.ReadAll(r.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">		w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	url := <span class="keyword">string</span>(payload)</span><br><span class="line">	log.Printf(<span class="string">"移除服务： %s"</span>, url)</span><br><span class="line">	err = reg.remove(url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">		w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>代码很清晰，就是一模一样的移除服务，总体代码改动如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ServerPort = <span class="string">":3000"</span></span><br><span class="line"><span class="keyword">const</span> ServicesURL = <span class="string">"http://localhost"</span> + ServerPort + <span class="string">"/services"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> registry <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//这个slice，是动态变化的，而且多个线程可能会并发的进行访问，</span></span><br><span class="line">	<span class="comment">//为了保证线程安全，需要加锁。</span></span><br><span class="line">	registrations []Registration</span><br><span class="line">	mutex         *sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在增加服务的时候是需要加锁的</span></span><br><span class="line"><span class="comment">//add方法表示增加服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.Lock()</span><br><span class="line">	registry.registrations = <span class="built_in">append</span>(registry.registrations, reg)</span><br><span class="line">	registry.mutex.Unlock()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//那么肯定要有个方法取消服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//看看服务中台有没有这服务</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> reg.registrations &#123;</span><br><span class="line">		<span class="keyword">if</span> reg.registrations[i].ServiceURL == url &#123;</span><br><span class="line">			registry.mutex.Lock()</span><br><span class="line">			<span class="comment">//把后面的接上前面的，自然的去除了，方法其实不唯一</span></span><br><span class="line">			reg.registrations = <span class="built_in">append</span>(reg.registrations[:i], reg.registrations[:i+<span class="number">1</span>]...)</span><br><span class="line">			registry.mutex.Unlock()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务地址未发现： %s "</span>, url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reg = registry&#123;</span><br><span class="line">	registrations: <span class="built_in">make</span>([]Registration, <span class="number">0</span>),</span><br><span class="line">	mutex:         <span class="built_in">new</span>(sync.Mutex),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个web服务</span></span><br><span class="line"><span class="keyword">type</span> RegistryService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s RegistryService)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"接受请求："</span>)</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		<span class="comment">//解码</span></span><br><span class="line">		dec := json.NewDecoder(r.Body)</span><br><span class="line">		<span class="keyword">var</span> r Registration</span><br><span class="line">		err := dec.Decode(&amp;r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">"增加服务：%v ，该服务的地址是：%s \n"</span>,</span><br><span class="line">			r.ServiceName, r.ServiceURL)</span><br><span class="line">		err = reg.add(r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> http.MethodDelete:</span><br><span class="line">		payload, err := ioutil.ReadAll(r.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		url := <span class="keyword">string</span>(payload)</span><br><span class="line">		log.Printf(<span class="string">"移除服务： %s"</span>, url)</span><br><span class="line">		err = reg.remove(url)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册中心取消服务的方法定义好了，那么也就需要在其他可注册服务的函数体中定义方法。为了进一步的解除耦合度，取消服务的方法和建立服务的方法一样，需要在client里面编写。</p>
<h4 id="修改客户端"><a href="#修改客户端" class="headerlink" title="修改客户端"></a>修改客户端</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个函数的目的是给web service发送一个post请求</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterService</span><span class="params">(r Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	enc := json.NewEncoder(buf)</span><br><span class="line">	err := enc.Encode(r)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res, err := http.Post(ServicesURL, <span class="string">"application/json"</span>, buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务注册失败 "</span>+<span class="string">"状态码为： %v"</span>, res.StatusCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结束服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShutdownService</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	req, err := http.NewRequest(</span><br><span class="line">		http.MethodDelete, ServicesURL,</span><br><span class="line">		bytes.NewBuffer([]<span class="keyword">byte</span>(url))) <span class="comment">//把string转化为slice</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	req.Header.Add(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">	<span class="comment">//紧接着发送请求</span></span><br><span class="line">	res, err := http.DefaultClient.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务取消失败，状态码为：%v"</span>,</span><br><span class="line">			res.StatusCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加了ShutdownService去结束这个服务。</p>
<p>紧接着，去开始服务注册的函数里边，进行取消注册的修改：</p>
<h4 id="修改服务的注册功能"><a href="#修改服务的注册功能" class="headerlink" title="修改服务的注册功能"></a>修改服务的注册功能</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//公共的函数，用于启动服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(ctx context.Context, host, port <span class="keyword">string</span>, reg registry.Registration,</span></span></span><br><span class="line"><span class="function"><span class="params">	registerHandlersFunc <span class="keyword">func</span>()</span>) <span class="params">(context.Context, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">//将传入的函数运行</span></span><br><span class="line">	registerHandlersFunc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//对服务进行基本的定义，完善服务，并将信息返回给主函数</span></span><br><span class="line">	ctx = startService(ctx, reg.ServiceName, host, port)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//启动web服务之后注册：</span></span><br><span class="line">	err := registry.RegisterService(reg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ctx, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startService</span><span class="params">(ctx context.Context, name registry.ServiceName, host <span class="keyword">string</span>, port <span class="keyword">string</span>)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	<span class="comment">//使得ctx具有取消的功能</span></span><br><span class="line">	ctx, cancel := context.WithCancel(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//定义服务地址</span></span><br><span class="line">	<span class="keyword">var</span> server http.Server</span><br><span class="line">	server.Addr = <span class="string">":"</span> + port</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">//启动服务，一旦发生可错误，就取消</span></span><br><span class="line">		log.Println(server.ListenAndServe())</span><br><span class="line">		<span class="comment">//调用取消服务的服务</span></span><br><span class="line">		err := registry.ShutdownService(fmt.Sprintf(<span class="string">"http://%s:%s"</span>, host, port))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%v 服务开始。按任意键停止. \n"</span>, name)</span><br><span class="line">		<span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line">		fmt.Scanln(&amp;s)</span><br><span class="line"></span><br><span class="line">		<span class="comment">//调用取消服务的服务</span></span><br><span class="line">		err := registry.ShutdownService(fmt.Sprintf(<span class="string">"http://%s:%s"</span>, host, port))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		server.Shutdown(ctx)</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是两个goroutine的修改，使其具有取消服务的功能。</p>
<h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>那么注册中心和服务的逻辑都修改好了，然后和上面的步骤一样，先启动注册中心，后启动日志逻辑，结果为:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">注册中心 的服务开始。按任意键停止.</span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：log service ，该服务的地址是：http://localhost:<span class="number">4000</span> </span><br><span class="line"></span><br><span class="line">log service 服务开始。按任意键停止.</span><br><span class="line">q</span><br><span class="line"><span class="function">http: <span class="title">Server</span> <span class="title">closed</span></span></span><br><span class="line"><span class="function">停止服务</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">移除服务： <span class="title">http</span>://<span class="title">localhost</span>:4000</span></span><br><span class="line"><span class="function"><span class="title">http</span>: <span class="title">Server</span> <span class="title">closed</span></span></span><br></pre></td></tr></table></figure>





<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><p>前面的服务注册都是一对一的，还体现不了分布式的特点。接下来进行多服务注册，使得一个学生成绩的服务既要使用日志服务，也要注册到注册中心</p>
<h3 id="业务服务"><a href="#业务服务" class="headerlink" title="业务服务"></a>业务服务</h3><h4 id="基本的数据结构与方法"><a href="#基本的数据结构与方法" class="headerlink" title="基本的数据结构与方法"></a>基本的数据结构与方法</h4><p>首先要编写一个学生的基础信息的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grades</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//学生信息</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID        <span class="keyword">int</span></span><br><span class="line">	FirstName <span class="keyword">string</span></span><br><span class="line">	LastName  <span class="keyword">string</span></span><br><span class="line">	Grades    []Grade</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分数</span></span><br><span class="line"><span class="keyword">type</span> Grade <span class="keyword">struct</span> &#123;</span><br><span class="line">	Title <span class="keyword">string</span></span><br><span class="line">	Type  GradeType</span><br><span class="line">	Score <span class="keyword">float32</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> GradeType <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ( <span class="comment">//考试类型</span></span><br><span class="line">	GradeQuiz = GradeType(<span class="string">"Quiz"</span>)</span><br><span class="line">	GradeTest = GradeType(<span class="string">"Test"</span>)</span><br><span class="line">	GradeExam = GradeType(<span class="string">"Exam"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//学生的平均成绩</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s Student)</span> <span class="title">Average</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> result <span class="keyword">float32</span></span><br><span class="line">	<span class="keyword">for</span> _, grade := <span class="keyword">range</span> s.Grades &#123;</span><br><span class="line">		result += grade.Score</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result / <span class="keyword">float32</span>(<span class="built_in">len</span>(s.Grades))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//寻找学生 by ID</span></span><br><span class="line"><span class="keyword">type</span> Students []Student</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ss Students)</span> <span class="title">GetByID</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="params">(*Student, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> ss &#123;</span><br><span class="line">		<span class="keyword">if</span> ss[i].ID == id &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;ss[i], <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"学生的ID：  %d  未找到"</span>, id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用于外部的访问</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	students      Students</span><br><span class="line">	studentsMutex sync.Mutex</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<p>接着肯定得有一些学生的数据，来做测试，这些数据一开始就会被加载进数据结构中，这暂时是用来代替数据库的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grades</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	students = []Student&#123;</span><br><span class="line">		&#123;</span><br><span class="line">			ID:        <span class="number">1</span>,</span><br><span class="line">			FirstName: <span class="string">"Nick"</span>,</span><br><span class="line">			LastName:  <span class="string">"Carter"</span>,</span><br><span class="line">			Grades: []Grade&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 1"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">85</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Final Exam"</span>,</span><br><span class="line">					Type:  GradeExam,</span><br><span class="line">					Score: <span class="number">94</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 2"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">82</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			ID:        <span class="number">2</span>,</span><br><span class="line">			FirstName: <span class="string">"Roberto"</span>,</span><br><span class="line">			LastName:  <span class="string">"Baggio"</span>,</span><br><span class="line">			Grades: []Grade&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 1"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">100</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Final Exam"</span>,</span><br><span class="line">					Type:  GradeExam,</span><br><span class="line">					Score: <span class="number">100</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 2"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">81</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			ID:        <span class="number">3</span>,</span><br><span class="line">			FirstName: <span class="string">"Emma"</span>,</span><br><span class="line">			LastName:  <span class="string">"Stone"</span>,</span><br><span class="line">			Grades: []Grade&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 1"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">67</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Final Exam"</span>,</span><br><span class="line">					Type:  GradeExam,</span><br><span class="line">					Score: <span class="number">0</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 2"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">75</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			ID:        <span class="number">4</span>,</span><br><span class="line">			FirstName: <span class="string">"Rachel"</span>,</span><br><span class="line">			LastName:  <span class="string">"McAdams"</span>,</span><br><span class="line">			Grades: []Grade&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 1"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">98</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Final Exam"</span>,</span><br><span class="line">					Type:  GradeExam,</span><br><span class="line">					Score: <span class="number">99</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 2"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">94</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			ID:        <span class="number">5</span>,</span><br><span class="line">			FirstName: <span class="string">"Kelly"</span>,</span><br><span class="line">			LastName:  <span class="string">"Clarkson"</span>,</span><br><span class="line">			Grades: []Grade&#123;</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 1"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">95</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Final Exam"</span>,</span><br><span class="line">					Type:  GradeExam,</span><br><span class="line">					Score: <span class="number">100</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">				&#123;</span><br><span class="line">					Title: <span class="string">"Quiz 2"</span>,</span><br><span class="line">					Type:  GradeQuiz,</span><br><span class="line">					Score: <span class="number">97</span>,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，也肯定要有server，才能正常的启动服务，需要去编写基本的逻辑，比如获取全部学生信息，根据ID进行信息搜索，增加学生信息等功能：</p>
<h4 id="服务的逻辑"><a href="#服务的逻辑" class="headerlink" title="服务的逻辑"></a>服务的逻辑</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> grades</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterHandlers</span><span class="params">()</span></span> &#123;</span><br><span class="line">	handler := <span class="built_in">new</span>(studentsHandler)</span><br><span class="line">	<span class="comment">//这个两个地址是不同的，一个是单个页面</span></span><br><span class="line">	http.Handle(<span class="string">"/students"</span>, handler)</span><br><span class="line">	<span class="comment">//另一个是必须传入参数的页面</span></span><br><span class="line">	http.Handle(<span class="string">"/students/"</span>, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> studentsHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//所以一个链接需要处理很多情况</span></span><br><span class="line"><span class="comment">// /students 分割后长度是2</span></span><br><span class="line"><span class="comment">// /students/&#123;id&#125; 分割后长度是3</span></span><br><span class="line"><span class="comment">// /students/&#123;id&#125;/grades  分割后长度是4</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh studentsHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">//简单对字符进行处理：</span></span><br><span class="line">	pathSegments := strings.Split(r.URL.Path, <span class="string">"/"</span>)</span><br><span class="line">	<span class="keyword">switch</span> <span class="built_in">len</span>(pathSegments) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>: <span class="comment">//获取全部信息</span></span><br><span class="line">		sh.getAll(w, r)</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>: <span class="comment">//查询</span></span><br><span class="line">		<span class="comment">//提取id</span></span><br><span class="line">		id, err := strconv.Atoi(pathSegments[<span class="number">2</span>])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(http.StatusNotFound)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		sh.getOne(w, r, id)</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>: <span class="comment">//新增</span></span><br><span class="line">		id, err := strconv.Atoi(pathSegments[<span class="number">2</span>])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(http.StatusNotFound)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		sh.addGrade(w, r, id)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusNotFound)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取全部学生信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh studentsHandler)</span> <span class="title">getAll</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	studentsMutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> studentsMutex.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将学生信息全部转为JSON，返回给data，最后写入</span></span><br><span class="line">	data, err := sh.toJSON(students)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">		log.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.Header().Add(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">	w.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据ID，搜索学生信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh studentsHandler)</span> <span class="title">getOne</span><span class="params">(w http.ResponseWriter, r *http.Request, id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	studentsMutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> studentsMutex.Unlock()</span><br><span class="line"></span><br><span class="line">	student, err := students.GetByID(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusNotFound)</span><br><span class="line">		log.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//逻辑与获取全部信息几乎一致</span></span><br><span class="line">	data, err := sh.toJSON(student)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">		log.Printf(<span class="string">"学生信息序列化失败: %q"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.Header().Add(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">	w.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加学生成绩信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh studentsHandler)</span> <span class="title">addGrade</span><span class="params">(w http.ResponseWriter, r *http.Request, id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	studentsMutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> studentsMutex.Unlock()</span><br><span class="line"></span><br><span class="line">	student, err := students.GetByID(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusNotFound)</span><br><span class="line">		log.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//上面的逻辑一样的，没什么好说</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//接着要从URL中获取到要传达的学生成绩信息</span></span><br><span class="line">	<span class="keyword">var</span> g Grade</span><br><span class="line">	dec := json.NewDecoder(r.Body)</span><br><span class="line">	err = dec.Decode(&amp;g)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">		log.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//这部分逻辑是获取成绩信息</span></span><br><span class="line">	<span class="comment">//如果学生成绩获取正确，就附加信息</span></span><br><span class="line">	student.Grades = <span class="built_in">append</span>(student.Grades, g)</span><br><span class="line">	w.WriteHeader(http.StatusCreated) <span class="comment">//201</span></span><br><span class="line">	</span><br><span class="line">	data, err := sh.toJSON(g)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	w.Header().Add(<span class="string">"Content-Type"</span>, <span class="string">"applicaiton/json"</span>)</span><br><span class="line">	w.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转化为JSON</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sh studentsHandler)</span> <span class="title">toJSON</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">	enc := json.NewEncoder(&amp;b)</span><br><span class="line">	err := enc.Encode(obj)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"学生信息序列化失败: %q"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话，基础逻辑也已经完善了，接着就是在注册中心里增加服务：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册中心</span></span><br><span class="line"><span class="keyword">type</span> Registration <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName ServiceName</span><br><span class="line">	ServiceURL  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServiceName <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LogService     = ServiceName(<span class="string">"LogService"</span>)</span><br><span class="line">	GradingService = ServiceName(<span class="string">"GradingService"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>最后，得让web服务可以运行，在cmd文件夹下创建一个新的main函数，写入一样的逻辑代码：</p>
<h4 id="服务启动器"><a href="#服务启动器" class="headerlink" title="服务启动器"></a>服务启动器</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/grades"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/service"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	host, port := <span class="string">"localhost"</span>, <span class="string">"6000"</span></span><br><span class="line">	serviceAddress := fmt.Sprintf(<span class="string">"http://%v:%v"</span>, host, port)</span><br><span class="line"></span><br><span class="line">	r := registry.Registration&#123;</span><br><span class="line">		ServiceName: registry.GradingService,</span><br><span class="line">		ServiceURL:  serviceAddress,</span><br><span class="line">	&#125;</span><br><span class="line">	ctx, err := service.Start(context.Background(),</span><br><span class="line">		host,</span><br><span class="line">		port,</span><br><span class="line">		r,</span><br><span class="line">		grades.RegisterHandlers)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		stlog.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	fmt.Println(<span class="string">"grading service 服务停止了"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这么下来，这个业务服务也就完成了，他们可以互相不干扰的进行服务注册，但是现在grade服务还不能去调用日志服务。所以我们还需要服务发现。</p>
<h3 id="服务发现-1"><a href="#服务发现-1" class="headerlink" title="服务发现"></a>服务发现</h3><p>服务发现作用能让grade服务可以请求log服务</p>
<h4 id="去引用日志服务"><a href="#去引用日志服务" class="headerlink" title="去引用日志服务"></a>去引用日志服务</h4><p>首先肯定是要给服务的数据结构增加一些基本信息，这样才能使得服务有这些基本的功能。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册中心</span></span><br><span class="line"><span class="keyword">type</span> Registration <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName ServiceName</span><br><span class="line">	ServiceURL  <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//该服务所依赖的其他服务。用slice去保存</span></span><br><span class="line">	RequiredServices []ServiceName</span><br><span class="line">	<span class="comment">//向外暴露的服务端口</span></span><br><span class="line">	ServiceUpdateURL <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServiceName <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LogService     = ServiceName(<span class="string">"LogService"</span>)</span><br><span class="line">	GradingService = ServiceName(<span class="string">"GradingService"</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//每一条目</span></span><br><span class="line"><span class="keyword">type</span> patchEntry <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name ServiceName</span><br><span class="line">	URL  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务变化</span></span><br><span class="line"><span class="keyword">type</span> patch <span class="keyword">struct</span> &#123;</span><br><span class="line">	Added   []patchEntry</span><br><span class="line">	Removed []patchEntry</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来可以想想，一个服务如果还依赖着其他的服务。那么，当这个服务正要注册的时候，或者说要加入服务群体的时候。就会在：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span></span></span><br></pre></td></tr></table></figure>

<p>进行服务注册，那么这个时候如果服务还依赖其他服务，比如正要注册的grade服务还依赖log服务，这时候就正好可以去获取依赖。</p>
<p>修改后代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ServerPort = <span class="string">":3000"</span></span><br><span class="line"><span class="keyword">const</span> ServicesURL = <span class="string">"http://localhost"</span> + ServerPort + <span class="string">"/services"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> registry <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//这个slice，是动态变化的，而且多个线程可能会并发的进行访问，</span></span><br><span class="line">	<span class="comment">//为了保证线程安全，需要加锁。</span></span><br><span class="line">	registrations []Registration</span><br><span class="line">	mutex         *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在增加服务的时候是需要加锁的</span></span><br><span class="line"><span class="comment">//add方法表示增加服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.Lock()</span><br><span class="line">	registry.registrations = <span class="built_in">append</span>(registry.registrations, reg)</span><br><span class="line">	registry.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//正好去获取这个服务所依赖的其他服务</span></span><br><span class="line">	err := registry.sendRequireServices(reg)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取其他服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">sendRequireServices</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.RLock()</span><br><span class="line">	<span class="keyword">defer</span> registry.mutex.RUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//寻找服务</span></span><br><span class="line">	<span class="keyword">var</span> p patch</span><br><span class="line">	<span class="keyword">for</span> _, serviceReg := <span class="keyword">range</span> registry.registrations &#123;</span><br><span class="line">		<span class="keyword">for</span> _, reqService := <span class="keyword">range</span> reg.RequiredServices &#123;</span><br><span class="line">			<span class="keyword">if</span> serviceReg.ServiceName == reqService &#123;</span><br><span class="line">				p.Added = <span class="built_in">append</span>(p.Added, patchEntry&#123;</span><br><span class="line">					Name: serviceReg.ServiceName,</span><br><span class="line">					URL:  serviceReg.ServiceURL,</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//找到之后,注册</span></span><br><span class="line">	err := registry.sendPatch(p, reg.ServiceUpdateURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将需要的服务发送过去注册的过程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">sendPatch</span><span class="params">(p patch, url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	d, err := json.Marshal(p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	_, err = http.Post(url, <span class="string">"application/json"</span>, bytes.NewBuffer(d))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//那么肯定要有个方法取消服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//看看服务中台有没有这服务</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> reg.registrations &#123;</span><br><span class="line">		<span class="keyword">if</span> reg.registrations[i].ServiceURL == url &#123;</span><br><span class="line">			registry.mutex.Lock()</span><br><span class="line">			<span class="comment">//把后面的接上前面的，自然的去除了，方法其实不唯一</span></span><br><span class="line">			reg.registrations = <span class="built_in">append</span>(reg.registrations[:i], reg.registrations[:i+<span class="number">1</span>]...)</span><br><span class="line">			<span class="comment">//reg.registrations = append(reg.registrations[:i], reg.registrations[i+1:]...)</span></span><br><span class="line">			registry.mutex.Unlock()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务地址未发现： %s "</span>, url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reg = registry&#123;</span><br><span class="line">	registrations: <span class="built_in">make</span>([]Registration, <span class="number">0</span>),</span><br><span class="line">	mutex:         <span class="built_in">new</span>(sync.RWMutex),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个web服务</span></span><br><span class="line"><span class="keyword">type</span> RegistryService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s RegistryService)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"等待接受请求："</span>)</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		<span class="comment">//解码</span></span><br><span class="line">		dec := json.NewDecoder(r.Body)</span><br><span class="line">		<span class="keyword">var</span> r Registration</span><br><span class="line">		err := dec.Decode(&amp;r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">"增加服务：%v ，该服务的地址是：%s \n"</span>,</span><br><span class="line">			r.ServiceName, r.ServiceURL)</span><br><span class="line">		err = reg.add(r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> http.MethodDelete:</span><br><span class="line">		payload, err := ioutil.ReadAll(r.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		url := <span class="keyword">string</span>(payload)</span><br><span class="line">		log.Printf(<span class="string">"移除服务： %s"</span>, url)</span><br><span class="line">		err = reg.remove(url)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个找到所需要服务并将其注册的过程。</p>
<p>接着，grade服务会向注册中心请求这些服务，但是注册中心也需要地方去存储这些请求的服务。</p>
<p>log服务就会向grade服务提供服务，那么会需要一些数据结构去存储：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//log服务会向多个服务提供服务</span></span><br><span class="line"><span class="keyword">type</span> providers <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//服务与服务的URL</span></span><br><span class="line">	services <span class="keyword">map</span>[ServiceName][]<span class="keyword">string</span></span><br><span class="line">	<span class="comment">//互斥锁</span></span><br><span class="line">	mutex *sync.RWMutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后去实现它的逻辑，总体修改后代码如下：</p>
<h4 id="服务的提供者"><a href="#服务的提供者" class="headerlink" title="服务的提供者"></a>服务的提供者</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"math/rand"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"net/url"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个函数的目的是给web service发送一个post请求</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterService</span><span class="params">(r Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//服务注册中心要向URL更新一些信息</span></span><br><span class="line">	serviceUpdateURL, err := url.Parse(r.ServiceUpdateURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	http.Handle(serviceUpdateURL.Path, &amp;serviceUpdateHandler&#123;&#125;)</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	enc := json.NewEncoder(buf)</span><br><span class="line">	err = enc.Encode(r)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res, err := http.Post(ServicesURL, <span class="string">"application/json"</span>, buf)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务注册失败 "</span>+<span class="string">"状态码为： %v"</span>, res.StatusCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新服务的处理</span></span><br><span class="line"><span class="keyword">type</span> serviceUpdateHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(suh serviceUpdateHandler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> r.Method != http.MethodPost &#123;</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//先进行解码</span></span><br><span class="line">	dec := json.NewDecoder(r.Body)</span><br><span class="line">	<span class="keyword">var</span> p patch</span><br><span class="line">	err := dec.Decode(&amp;p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">		w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//fmt.Printf("收到更新： %v\n", p)</span></span><br><span class="line">	prov.Update(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//结束服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShutdownService</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	req, err := http.NewRequest(</span><br><span class="line">		http.MethodDelete, ServicesURL,</span><br><span class="line">		bytes.NewBuffer([]<span class="keyword">byte</span>(url))) <span class="comment">//把string转化为slice</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	req.Header.Add(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">	<span class="comment">//紧接着发送请求</span></span><br><span class="line">	res, err := http.DefaultClient.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务取消失败，状态码为：%v"</span>,</span><br><span class="line">			res.StatusCode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//log服务会向多个服务提供服务</span></span><br><span class="line"><span class="keyword">type</span> providers <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//服务与服务的URL</span></span><br><span class="line">	services <span class="keyword">map</span>[ServiceName][]<span class="keyword">string</span></span><br><span class="line">	<span class="comment">//互斥锁</span></span><br><span class="line">	mutex *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接受到patch的时候，需要进行更新，</span></span><br><span class="line"><span class="keyword">var</span> prov = providers&#123;</span><br><span class="line">	services: <span class="built_in">make</span>(<span class="keyword">map</span>[ServiceName][]<span class="keyword">string</span>),</span><br><span class="line">	mutex:    <span class="built_in">new</span>(sync.RWMutex),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *providers)</span> <span class="title">Update</span><span class="params">(pat patch)</span></span> &#123;</span><br><span class="line">	<span class="comment">//对传进来的patch更新provider</span></span><br><span class="line">	p.mutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> p.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//新增的情况</span></span><br><span class="line">	<span class="keyword">for</span> _, patchEntry := <span class="keyword">range</span> pat.Added &#123;</span><br><span class="line">		<span class="comment">//如果这个服务名目前还不存在，就创建新的slice</span></span><br><span class="line">		<span class="keyword">if</span> _, ok := p.services[patchEntry.Name]; !ok &#123;</span><br><span class="line">			p.services[patchEntry.Name] = <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//如果存在的话，就在值后边附加URL</span></span><br><span class="line">		p.services[patchEntry.Name] = <span class="built_in">append</span>(p.services[patchEntry.Name],</span><br><span class="line">			patchEntry.URL)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//减少的情况</span></span><br><span class="line">	<span class="comment">//遍历，对比，移除</span></span><br><span class="line">	<span class="keyword">for</span> _, patchEntry := <span class="keyword">range</span> pat.Removed &#123;</span><br><span class="line">		<span class="keyword">if</span> providerURLs, ok := p.services[patchEntry.Name]; ok &#123;</span><br><span class="line">			<span class="keyword">for</span> i := <span class="keyword">range</span> providerURLs &#123;</span><br><span class="line">				<span class="keyword">if</span> providerURLs[i] == patchEntry.URL &#123;</span><br><span class="line">					p.services[patchEntry.Name] = <span class="built_in">append</span>(providerURLs[:i],</span><br><span class="line">						providerURLs[i+<span class="number">1</span>:]...)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//然后还需要，根据服务的名称来找到它所依赖服务的url</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p providers)</span> <span class="title">get</span><span class="params">(name ServiceName)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	providers, ok := p.services[name]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"没有可提供服务的提供商： %v"</span>, name)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//随机数</span></span><br><span class="line">	idx := <span class="keyword">int</span>(rand.Float32() * <span class="keyword">float32</span>(<span class="built_in">len</span>(providers)))</span><br><span class="line">	<span class="keyword">return</span> providers[idx], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于这个get方法是私有的，对外再套一个函数：</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProvider</span><span class="params">(name ServiceName)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> prov.get(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="客户端的client"><a href="#客户端的client" class="headerlink" title="客户端的client"></a>客户端的client</h4><p>log服务现在有服务端的逻辑，但是客户端的服务想使用这个client还是比较麻烦的，所以还需要对log服务有一个自己的client：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> log</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//写日志，把日志写到server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetClientLogger</span><span class="params">(serviceURL <span class="keyword">string</span>, clientService registry.ServiceName)</span></span> &#123;</span><br><span class="line">	stlog.SetPrefix(fmt.Sprintf(<span class="string">"[%v] - "</span>, clientService))</span><br><span class="line">	stlog.SetFlags(<span class="number">0</span>)</span><br><span class="line">	stlog.SetOutput(&amp;clientLogger&#123;url: serviceURL&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> clientLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">	url <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cl clientLogger)</span> <span class="title">Write</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	b := bytes.NewBuffer([]<span class="keyword">byte</span>(data))</span><br><span class="line">	<span class="comment">//写到服务端</span></span><br><span class="line">	res, err := http.Post(cl.url+<span class="string">"/log"</span>, <span class="string">"text/plain"</span>, b)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res.StatusCode != http.StatusOK &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">"Failed to send log message. Service responded with %d - %s"</span>, res.StatusCode, res.Status)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//如果都没有问题，返回数据</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(data), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以让本地的日志服务写好日志后发送到服务器端保存</p>
<h4 id="使main函数具有服务发现的功能"><a href="#使main函数具有服务发现的功能" class="headerlink" title="使main函数具有服务发现的功能"></a>使main函数具有服务发现的功能</h4><p>主要是使得两个启动器拥有新的功能：</p>
<h5 id="grading-service"><a href="#grading-service" class="headerlink" title="grading service"></a>grading service</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/grades"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/log"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/service"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	host, port := <span class="string">"localhost"</span>, <span class="string">"6000"</span></span><br><span class="line">	serviceAddress := fmt.Sprintf(<span class="string">"http://%v:%v"</span>, host, port)</span><br><span class="line"></span><br><span class="line">	r := registry.Registration&#123;</span><br><span class="line">		ServiceName: registry.GradingService,</span><br><span class="line">		ServiceURL:  serviceAddress,</span><br><span class="line">		<span class="comment">//添加两个信息</span></span><br><span class="line">		RequiredServices: []registry.ServiceName&#123;registry.LogService&#125;,</span><br><span class="line">		ServiceUpdateURL: serviceAddress + <span class="string">"/services"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	ctx, err := service.Start(context.Background(),</span><br><span class="line">		host,</span><br><span class="line">		port,</span><br><span class="line">		r,</span><br><span class="line">		grades.RegisterHandlers)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		stlog.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//在服务启动之后使用log服务</span></span><br><span class="line">	<span class="keyword">if</span> logProvider, err := registry.GetProvider(registry.LogService); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"发现日志服务: %s\n"</span>, logProvider)</span><br><span class="line">		log.SetClientLogger(logProvider, r.ServiceName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	fmt.Println(<span class="string">"grading service 服务停止了"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="log-service"><a href="#log-service" class="headerlink" title="log service"></a>log service</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/log"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/registry"</span></span><br><span class="line">	<span class="string">"go_distributed_system_study/service"</span></span><br><span class="line">	stlog <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//定义日志地址</span></span><br><span class="line">	log.Run(<span class="string">"./distribute.log"</span>)</span><br><span class="line">	<span class="comment">//定义具体参数，其实通常应该由配置文件中定义</span></span><br><span class="line">	host, port := <span class="string">"localhost"</span>, <span class="string">"4000"</span></span><br><span class="line"></span><br><span class="line">	serviceAddress := fmt.Sprintf(<span class="string">"http://%s:%s"</span>, host, port)</span><br><span class="line">	r := registry.Registration&#123;</span><br><span class="line">		ServiceName: registry.LogService,</span><br><span class="line">		ServiceURL:  serviceAddress,</span><br><span class="line">		<span class="comment">//添加两个信息</span></span><br><span class="line">		RequiredServices: <span class="built_in">make</span>([]registry.ServiceName, <span class="number">0</span>),</span><br><span class="line">		ServiceUpdateURL: serviceAddress + <span class="string">"/services"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx, err := service.Start(</span><br><span class="line">		context.Background(),</span><br><span class="line">		host,</span><br><span class="line">		port,</span><br><span class="line">		r,</span><br><span class="line">		log.RegisterHandler,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">//如果有错误，就先执行标准库的log打印出结果</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		stlog.Fatalln(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//接需要等待ctx的信号</span></span><br><span class="line">	<span class="comment">//如果在启动服务器的时候出现了错误</span></span><br><span class="line">	<span class="comment">//或者在按下任意键停止后，就会发送信号</span></span><br><span class="line">	&lt;-ctx.Done()</span><br><span class="line">	<span class="comment">//接受到信号后，就会继续</span></span><br><span class="line">	fmt.Println(<span class="string">"停止服务"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来便可以测试了。</p>
<h4 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h4><p>按照：registryservice，logservice，gradingservice的顺序启动，测试结果如：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">注册中心 的服务开始。按任意键停止.</span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：LogService ，该服务的地址是：http://localhost:<span class="number">4000</span> </span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：GradingService ，该服务的地址是：http://localhost:<span class="number">6000</span> </span><br><span class="line"></span><br><span class="line">LogService 服务开始。按任意键停止.</span><br><span class="line"></span><br><span class="line">GradingService 服务开始。按任意键停止.</span><br><span class="line">发现日志服务: http://localhost:<span class="number">4000</span></span><br></pre></td></tr></table></figure>

<p>这么一来就完成了。</p>
<h3 id="依赖变化"><a href="#依赖变化" class="headerlink" title="依赖变化"></a>依赖变化</h3><h4 id="重新发现服务"><a href="#重新发现服务" class="headerlink" title="重新发现服务"></a>重新发现服务</h4><p>可以从上述的情况下看到一些不那么方便的点，一是：启动必须按照顺序来，不能随意。二是：当log服务下线后，再上线的话不会被再次发现。这都是服务极为脆弱的表现。那么解决这个问题的最好方法是：使服务具有依赖变化时进行通知的功能。</p>
<p>可以在服务中更改，使其具备通知的功能,主要是有notify函数，总体修改如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> registry</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ServerPort = <span class="string">":3000"</span></span><br><span class="line"><span class="keyword">const</span> ServicesURL = <span class="string">"http://localhost"</span> + ServerPort + <span class="string">"/services"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> registry <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//这个slice，是动态变化的，而且多个线程可能会并发的进行访问，</span></span><br><span class="line">	<span class="comment">//为了保证线程安全，需要加锁。</span></span><br><span class="line">	registrations []Registration</span><br><span class="line">	mutex         *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在增加服务的时候是需要加锁的</span></span><br><span class="line"><span class="comment">//add方法表示增加服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.Lock()</span><br><span class="line">	registry.registrations = <span class="built_in">append</span>(registry.registrations, reg)</span><br><span class="line">	registry.mutex.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//正好去获取这个服务所依赖的其他服务</span></span><br><span class="line">	err := registry.sendRequireServices(reg)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//服务通知，当服务上线，而这个服务又被依赖时，告知依赖服务自己上线了</span></span><br><span class="line">	registry.notify(patch&#123;</span><br><span class="line">		Added: []patchEntry&#123;</span><br><span class="line">			patchEntry&#123;</span><br><span class="line">				Name: reg.ServiceName,</span><br><span class="line">				URL:  reg.ServiceURL,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取其他服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">sendRequireServices</span><span class="params">(reg Registration)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	registry.mutex.RLock()</span><br><span class="line">	<span class="keyword">defer</span> registry.mutex.RUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//寻找服务</span></span><br><span class="line">	<span class="keyword">var</span> p patch</span><br><span class="line">	<span class="keyword">for</span> _, serviceReg := <span class="keyword">range</span> registry.registrations &#123;</span><br><span class="line">		<span class="keyword">for</span> _, reqService := <span class="keyword">range</span> reg.RequiredServices &#123;</span><br><span class="line">			<span class="keyword">if</span> serviceReg.ServiceName == reqService &#123;</span><br><span class="line">				p.Added = <span class="built_in">append</span>(p.Added, patchEntry&#123;</span><br><span class="line">					Name: serviceReg.ServiceName,</span><br><span class="line">					URL:  serviceReg.ServiceURL,</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//找到之后,注册</span></span><br><span class="line">	err := registry.sendPatch(p, reg.ServiceUpdateURL)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通知其他服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">notify</span><span class="params">(fullPatch patch)</span></span> &#123;</span><br><span class="line">	r.mutex.RLock()</span><br><span class="line">	<span class="keyword">defer</span> r.mutex.RUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">//看看服务的依赖在patch里面存不存在</span></span><br><span class="line">	<span class="comment">//对已经注册的服务循环遍历</span></span><br><span class="line">	<span class="keyword">for</span> _, reg := <span class="keyword">range</span> r.registrations &#123;</span><br><span class="line">		<span class="comment">//并发的发出通知</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(reg Registration)</span></span> &#123;</span><br><span class="line">			<span class="comment">//对服务所需要的服务进行循环</span></span><br><span class="line">			<span class="keyword">for</span> _, reqService := <span class="keyword">range</span> reg.RequiredServices &#123;</span><br><span class="line">				p := patch&#123;Added: []patchEntry&#123;&#125;, Removed: []patchEntry&#123;&#125;&#125;</span><br><span class="line">				<span class="comment">//标志位，为TRUE表示有需要更新的地方</span></span><br><span class="line">				sendUpdate := <span class="literal">false</span></span><br><span class="line">				<span class="keyword">for</span> _, added := <span class="keyword">range</span> fullPatch.Added &#123;</span><br><span class="line">					<span class="comment">//如果添加的服务正好是某个服务的依赖项</span></span><br><span class="line">					<span class="keyword">if</span> added.Name == reqService &#123;</span><br><span class="line">						p.Added = <span class="built_in">append</span>(p.Added, added)</span><br><span class="line">						sendUpdate = <span class="literal">true</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//看看有哪些服务停止了</span></span><br><span class="line">				<span class="keyword">for</span> _, removed := <span class="keyword">range</span> fullPatch.Removed &#123;</span><br><span class="line">					<span class="comment">///如果停掉的服务正好是所被依赖的服务</span></span><br><span class="line">					<span class="keyword">if</span> removed.Name == reqService &#123;</span><br><span class="line">						p.Removed = <span class="built_in">append</span>(p.Removed, removed)</span><br><span class="line">						sendUpdate = <span class="literal">true</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//最后判断标志位，把更新发送到对应的服务</span></span><br><span class="line">				<span class="keyword">if</span> sendUpdate &#123;</span><br><span class="line">					err := r.sendPatch(p, reg.ServiceUpdateURL)</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						log.Println(err)</span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(reg)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将需要的服务发送过去注册的过程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">sendPatch</span><span class="params">(p patch, url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	d, err := json.Marshal(p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	_, err = http.Post(url, <span class="string">"application/json"</span>, bytes.NewBuffer(d))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//那么肯定要有个方法取消服务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//看看服务中台有没有这服务</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> reg.registrations &#123;</span><br><span class="line">		<span class="keyword">if</span> reg.registrations[i].ServiceURL == url &#123;</span><br><span class="line">			registry.mutex.Lock()</span><br><span class="line">			<span class="comment">//把后面的接上前面的，自然的去除了，方法其实不唯一</span></span><br><span class="line">			reg.registrations = <span class="built_in">append</span>(reg.registrations[:i], reg.registrations[:i+<span class="number">1</span>]...)</span><br><span class="line">			<span class="comment">//reg.registrations = append(reg.registrations[:i], reg.registrations[i+1:]...)</span></span><br><span class="line">			registry.mutex.Unlock()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务地址未发现： %s "</span>, url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reg = registry&#123;</span><br><span class="line">	registrations: <span class="built_in">make</span>([]Registration, <span class="number">0</span>),</span><br><span class="line">	mutex:         <span class="built_in">new</span>(sync.RWMutex),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建一个web服务</span></span><br><span class="line"><span class="keyword">type</span> RegistryService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s RegistryService)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"等待接受请求："</span>)</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		<span class="comment">//解码</span></span><br><span class="line">		dec := json.NewDecoder(r.Body)</span><br><span class="line">		<span class="keyword">var</span> r Registration</span><br><span class="line">		err := dec.Decode(&amp;r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Printf(<span class="string">"增加服务：%v ，该服务的地址是：%s \n"</span>,</span><br><span class="line">			r.ServiceName, r.ServiceURL)</span><br><span class="line">		err = reg.add(r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> http.MethodDelete:</span><br><span class="line">		payload, err := ioutil.ReadAll(r.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		url := <span class="keyword">string</span>(payload)</span><br><span class="line">		log.Printf(<span class="string">"移除服务： %s"</span>, url)</span><br><span class="line">		err = reg.remove(url)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h4><p>接着再进行测试，可以看到，当log服务下线后，重新上线时，grading 服务就能够发现log服务了。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">收到更新： &#123;[&#123;LogService http://localhost:<span class="number">4000</span>&#125; &#123;LogService http://localhost:<span class="number">4000</span>&#125;] []&#125;</span><br><span class="line">发现日志服务: http://localhost:<span class="number">4000</span></span><br><span class="line">收到更新： &#123;[&#123;LogService http://localhost:<span class="number">4000</span>&#125;] []&#125;</span><br><span class="line">收到更新： &#123;[&#123;LogService http://localhost:<span class="number">4000</span>&#125;] []&#125;</span><br></pre></td></tr></table></figure>



<h4 id="服务下线告知"><a href="#服务下线告知" class="headerlink" title="服务下线告知"></a>服务下线告知</h4><p>接着也容易，把remove方法里面添加下线告知的功能就行了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(registry *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//看看服务中台有没有这服务</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> reg.registrations &#123;</span><br><span class="line">		<span class="keyword">if</span> reg.registrations[i].ServiceURL == url &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//下线也告知</span></span><br><span class="line">			registry.notify(patch&#123;</span><br><span class="line">				Removed: []patchEntry&#123;</span><br><span class="line">					&#123;</span><br><span class="line">						Name: registry.registrations[i].ServiceName,</span><br><span class="line">						URL:  registry.registrations[i].ServiceURL,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="comment">//下线告知</span></span><br><span class="line">			</span><br><span class="line">			registry.mutex.Lock()</span><br><span class="line">			<span class="comment">//把后面的接上前面的，自然的去除了，方法其实不唯一</span></span><br><span class="line">			reg.registrations = <span class="built_in">append</span>(reg.registrations[:i], reg.registrations[:i+<span class="number">1</span>]...)</span><br><span class="line">			<span class="comment">//reg.registrations = append(reg.registrations[:i], reg.registrations[i+1:]...)</span></span><br><span class="line">			registry.mutex.Unlock()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"服务地址未发现： %s "</span>, url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，这部分逻辑就完成了。接下来测试代码。</p>
<h4 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h4><p>测试的步骤是先开启注册中心，再开启日志服务，后开始grade服务。然后使得日志服务停止，再重启。可以看到一系列的结果。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">注册中心 的服务开始。按任意键停止.</span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：LogService ，该服务的地址是：http://localhost:<span class="number">4000</span> </span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：GradingService ，该服务的地址是：http://localhost:<span class="number">6000</span></span><br><span class="line">移除服务： http://localhost:<span class="number">4000</span></span><br><span class="line">等待接受请求：</span><br><span class="line">增加服务：LogService ，该服务的地址是：http://localhost:<span class="number">4000</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LogService 服务开始。按任意键停止.</span><br><span class="line">收到更新： &#123;[] []&#125;</span><br><span class="line"><span class="function">http: <span class="title">Server</span> <span class="title">closed</span></span></span><br><span class="line"><span class="function">停止服务</span></span><br><span class="line"><span class="function"><span class="title">LogService</span> 服务开始。按任意键停止</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GradingService</span> 服务开始。按任意键停止.</span></span><br><span class="line"><span class="function">收到更新： &#123;[&#123;<span class="title">LogService</span> <span class="title">http</span>://<span class="title">localhost</span>:4000&#125;] []&#125;</span></span><br><span class="line"><span class="function">发现日志服务: <span class="title">http</span>://<span class="title">localhost</span>:4000</span></span><br><span class="line"><span class="function">收到更新： &#123;[] [&#123;<span class="title">LogService</span> <span class="title">http</span>://<span class="title">localhost</span>:4000&#125;]&#125;</span></span><br><span class="line"><span class="function">收到更新： &#123;[&#123;<span class="title">LogService</span> <span class="title">http</span>://<span class="title">localhost</span>:4000&#125;] []&#125;</span></span><br></pre></td></tr></table></figure>





<p>使用解除了耦合的网络接口，这也是Spring Cloud的微服务思想，同时也是分布式的一种类型。所以说分布式也没什么神奇之处，最核心的一处在于：<strong>把本地接口转化为了网络接口</strong>。能够理解这一过程，也就理解了分布式的思想。</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Golang/">Golang</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/04/19/restart-my-blog/"><i class="fa fa-chevron-left">  </i><span>【置顶】谈谈几件事</span></a></div><div class="next-post pull-right"><a href="/2022/04/27/go-language-error-problem/"><span>go语言学习遇到的问题</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(http://bbsfiles.vivo.com.cn/vivobbs/attachment/forum/201706/23/120105q39c9ql9syl7b4ye.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2022 By 攀</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>